<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BenchSight Tracker Pro v21</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #0a0e14; --card: #111820; --card2: #161d27; --border: #1e2a36;
  --text: #e0e0e0; --muted: #6b7280; --accent: #3b82f6; --accent2: #60a5fa;
  --home: #22c55e; --away: #ef4444; --success: #22c55e; --fail: #ef4444;
  --warn: #f59e0b; --input: #1a2332; --hover: #243040;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); font-size: 11px; height: 100vh; overflow: hidden; }
button { cursor: pointer; font-family: inherit; }
select, input { font-family: inherit; }

/* Layout */
.app { display: grid; grid-template-rows: 40px 1fr 24px; height: 100vh; }

/* Header */
header { display: flex; align-items: center; gap: 8px; padding: 0 10px; background: var(--card); border-bottom: 1px solid var(--border); }
header h1 { font-size: 13px; color: var(--accent); font-weight: 600; }
header select, header button { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; font-size: 10px; }
header button:hover { background: var(--hover); }
.hdr-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
.spacer { flex: 1; }
#status { font-size: 9px; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.btn-green { background: var(--success) !important; color: #000 !important; font-weight: 600; }
.btn-orange { background: var(--warn) !important; color: #000 !important; font-weight: 600; }
.btn-blue { background: var(--accent) !important; color: #fff !important; }

/* Main */
.main { display: grid; grid-template-columns: 180px 1fr 300px; gap: 4px; padding: 4px; overflow: hidden; }

/* Panels */
.panel { background: var(--card); border-radius: 6px; padding: 8px; display: flex; flex-direction: column; overflow: hidden; }
.panel h3 { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.panel h3 .badge { background: var(--accent); color: #fff; padding: 1px 5px; border-radius: 8px; font-size: 8px; }

/* Left Column */
.left { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }

/* Team/Period Selector */
.team-row { display: flex; gap: 3px; }
.team-btn { flex: 1; padding: 6px 4px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; opacity: 0.4; transition: all 0.15s; }
.team-btn.home { background: var(--home); color: #000; }
.team-btn.away { background: var(--away); color: #fff; }
.team-btn.active { opacity: 1; box-shadow: 0 0 0 2px #fff; }

.period-row { display: flex; gap: 2px; margin-top: 4px; }
.period-btn { flex: 1; padding: 4px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; font-size: 9px; text-align: center; color: var(--text); }
.period-btn:hover { background: var(--hover); }
.period-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* On-Ice Slots */
.slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
.slot { background: var(--input); border: 2px solid var(--border); border-radius: 4px; padding: 3px; text-align: center; cursor: pointer; min-height: 36px; transition: all 0.1s; }
.slot:hover { border-color: var(--accent2); }
.slot.active { border-color: var(--accent); background: #1a3050; }
.slot.filled { border-color: var(--success); }
.slot .lbl { font-size: 7px; color: var(--muted); text-transform: uppercase; }
.slot .num { font-size: 13px; font-weight: 700; color: var(--accent); }

/* Roster */
.roster { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 2px; align-content: flex-start; padding: 2px 0; }
.player { display: inline-flex; align-items: center; gap: 2px; padding: 2px 5px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; font-size: 9px; cursor: pointer; transition: all 0.1s; }
.player:hover { border-color: var(--accent); background: var(--hover); }
.player.on-ice { background: var(--success); color: #000; border-color: var(--success); font-weight: 600; }
.player.evt-player { background: var(--accent); color: #fff; border-color: var(--accent); }
.player.opp-player { background: var(--warn); color: #000; border-color: var(--warn); }
.player .n { font-weight: 700; }

/* Center Column */
.center { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }

/* Video Section */
.video-panel { display: flex; flex-direction: column; gap: 4px; }
.camera-tabs { display: flex; gap: 2px; }
.cam-tab { flex: 1; padding: 4px; background: var(--input); border: 1px solid var(--border); border-radius: 3px 3px 0 0; font-size: 9px; text-align: center; color: var(--muted); }
.cam-tab:hover { background: var(--hover); }
.cam-tab.active { background: var(--card2); color: var(--text); border-bottom-color: var(--card2); }
.video-box { background: #000; border-radius: 0 0 6px 6px; height: 140px; position: relative; }
.video-box iframe { width: 100%; height: 100%; border: none; }
.video-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted); font-size: 10px; }
.video-url-row { display: flex; gap: 4px; }
.video-url-row input { flex: 1; padding: 5px 8px; background: var(--input); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 10px; }
.video-url-row button { padding: 5px 10px; font-size: 9px; }

/* Clock Section */
.clock-row { display: flex; gap: 6px; align-items: center; padding: 6px 8px; background: var(--card2); border-radius: 6px; }
.clock-big { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 24px; font-weight: 700; color: var(--accent); min-width: 70px; }
.time-inp { display: flex; flex-direction: column; gap: 1px; }
.time-inp label { font-size: 7px; color: var(--muted); text-transform: uppercase; }
.time-inp input { width: 55px; padding: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; color: var(--text); font-family: monospace; font-size: 11px; text-align: center; }
.video-time { font-family: monospace; font-size: 10px; color: var(--warn); margin-left: auto; }

/* Rink Section */
.rink-row { display: flex; gap: 6px; }
.rink-box { flex: 1; background: var(--card2); border-radius: 6px; padding: 6px; display: flex; flex-direction: column; align-items: center; }
.rink-svg { width: 100%; max-width: 220px; cursor: crosshair; }
.xy-info { font-size: 9px; color: var(--muted); margin-top: 3px; }
.net-box { width: 90px; background: var(--card2); border-radius: 6px; padding: 6px; }
.net-box h4 { font-size: 8px; color: var(--muted); text-align: center; margin-bottom: 4px; }
.net-svg { width: 100%; cursor: pointer; }
.net-info { font-size: 8px; color: var(--muted); text-align: center; margin-top: 3px; }

/* Event List */
.events-panel { flex: 1; min-height: 0; }
.events-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.events-header button { padding: 2px 6px; font-size: 8px; }
.event-list { flex: 1; overflow-y: auto; font-size: 9px; }
.event-row { display: grid; grid-template-columns: 30px 45px 55px 1fr 30px 20px; gap: 3px; padding: 4px 2px; border-bottom: 1px solid var(--border); cursor: pointer; align-items: center; }
.event-row:hover { background: var(--hover); }
.event-row.active { background: var(--accent); color: #fff; }
.event-row.linked { border-left: 3px solid var(--warn); padding-left: 5px; }
.event-row.editing { background: #2a3a50; border: 1px solid var(--accent); }
.event-row .idx { font-family: monospace; color: var(--muted); font-weight: 600; }
.event-row .time { font-family: monospace; font-size: 8px; }
.event-row .type { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.event-row .players { color: var(--muted); font-size: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.event-row .zone { font-size: 8px; text-align: center; }
.event-row .del { color: var(--fail); cursor: pointer; opacity: 0.4; text-align: center; }
.event-row .del:hover { opacity: 1; }

/* Stats Bar */
.stats-bar { display: flex; gap: 10px; padding: 4px 8px; background: var(--card2); border-radius: 4px; font-size: 9px; }
.stat { display: flex; gap: 3px; }
.stat .l { color: var(--muted); }
.stat .v { font-weight: 600; color: var(--accent); }

/* Right Column - Event Entry */
.right { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }

/* Event Type Grid */
.evt-types { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; }
.evt-btn { padding: 6px 2px; display: flex; flex-direction: column; align-items: center; gap: 1px; background: var(--input); border: 2px solid var(--border); border-radius: 4px; transition: all 0.1s; }
.evt-btn:hover { border-color: var(--accent); background: var(--hover); }
.evt-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.evt-btn span { font-size: 8px; font-weight: 600; }
.evt-btn kbd { font-size: 7px; color: var(--muted); background: var(--bg); padding: 0 3px; border-radius: 2px; }
.evt-btn.active kbd { color: #fff; background: rgba(255,255,255,0.2); }

/* Form Rows */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
.form-row.tri { grid-template-columns: 1fr 1fr 1fr; }
.form-row.quad { grid-template-columns: 1fr 1fr 1fr 1fr; }
.form-group { display: flex; flex-direction: column; gap: 2px; }
.form-group label { font-size: 8px; color: var(--muted); text-transform: uppercase; }
.form-group select, .form-group input { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 5px; border-radius: 3px; font-size: 10px; }
.form-group select:focus, .form-group input:focus { outline: none; border-color: var(--accent); }

/* Success Toggle */
.success-row { display: flex; gap: 2px; }
.suc-btn { flex: 1; padding: 6px; border: 2px solid var(--border); border-radius: 4px; background: var(--input); font-weight: 700; font-size: 11px; text-align: center; }
.suc-btn:hover { background: var(--hover); }
.suc-btn.s.active { background: var(--success); color: #000; border-color: var(--success); }
.suc-btn.u.active { background: var(--fail); color: #fff; border-color: var(--fail); }

/* Link Row */
.link-row { display: flex; gap: 3px; align-items: center; padding: 5px; background: var(--card2); border-radius: 4px; margin-top: 4px; }
.link-row label { font-size: 8px; color: var(--muted); white-space: nowrap; }
.link-row select { flex: 1; font-size: 9px; }
.link-row button { padding: 4px 8px; font-size: 8px; }
.auto-link { font-size: 8px; color: var(--warn); }

/* Players Section */
.players-section { margin-top: 6px; }
.players-section h4 { font-size: 8px; color: var(--muted); margin-bottom: 3px; display: flex; justify-content: space-between; }
.player-slots { display: flex; flex-direction: column; gap: 3px; }
.player-slot-row { display: flex; gap: 3px; align-items: center; }
.player-slot-row .role { font-size: 8px; color: var(--muted); width: 25px; }
.player-slot-row .num { flex: 1; background: var(--input); border: 1px solid var(--border); border-radius: 3px; padding: 4px 6px; min-height: 24px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.player-slot-row .num:hover { border-color: var(--accent); }
.player-slot-row .num.filled { background: var(--accent); color: #fff; border-color: var(--accent); }
.player-slot-row .num.opp { background: var(--warn); color: #000; border-color: var(--warn); }
.player-slot-row .clear { font-size: 10px; cursor: pointer; opacity: 0.5; }
.player-slot-row .clear:hover { opacity: 1; }

/* XY Points for Player */
.xy-points-row { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 4px; padding: 4px; background: var(--card2); border-radius: 4px; }
.xy-point { padding: 2px 5px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; font-size: 8px; font-family: monospace; cursor: pointer; }
.xy-point:hover { border-color: var(--fail); }
.xy-point.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.xy-point.puck { background: #7f1d1d; color: #fca5a5; border-color: #dc2626; }
.xy-point.player { background: #1e3a5f; color: #93c5fd; border-color: #3b82f6; }

/* XY Mode Toggle */
.xy-mode-toggle { display: flex; gap: 3px; margin-bottom: 4px; align-items: center; }
.xy-mode-btn { padding: 3px 8px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; font-size: 9px; color: var(--text); }
.xy-mode-btn:hover { background: var(--hover); }
.xy-mode-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* XY Points Section */
.xy-points-section { margin-top: 6px; padding: 6px; background: var(--input); border-radius: 4px; }
.xy-points-label { font-size: 8px; color: var(--muted); margin-bottom: 2px; margin-top: 4px; }
.xy-points-label:first-child { margin-top: 0; }

/* Action Buttons */
.action-row { display: flex; gap: 4px; margin-top: 6px; }
.action-row button { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: 600; font-size: 11px; }
.action-row .save { background: var(--success); color: #000; }
.action-row .save:hover { background: #16a34a; }
.action-row .clear { background: var(--input); color: var(--text); border: 1px solid var(--border); }
.action-row .clear:hover { background: var(--hover); }
.action-row .update { background: var(--accent); color: #fff; }

/* Shift Panel */
.shift-panel { padding: 6px; background: var(--card2); border-radius: 4px; margin-top: 4px; }
.shift-panel h4 { font-size: 8px; color: var(--muted); margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
.shift-info { display: flex; gap: 4px; flex-wrap: wrap; font-size: 9px; }
.shift-info input { width: 50px; padding: 3px; font-size: 9px; }
.shift-info select { flex: 1; min-width: 80px; font-size: 9px; padding: 3px; }
.shift-btns { display: flex; gap: 3px; margin-top: 4px; }
.shift-btns button { flex: 1; padding: 5px; font-size: 9px; }

/* Footer */
footer { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0 10px; background: var(--card); border-top: 1px solid var(--border); font-size: 9px; color: var(--muted); }
footer kbd { background: var(--input); padding: 1px 4px; border-radius: 2px; margin: 0 1px; }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
.modal-bg.show { display: flex; }
.modal { background: var(--card); border-radius: 8px; padding: 16px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; }
.modal h3 { margin-bottom: 12px; font-size: 14px; }
.modal-row { display: flex; gap: 8px; margin-bottom: 8px; }
.modal-row label { width: 100px; font-size: 10px; color: var(--muted); }
.modal-row input, .modal-row select { flex: 1; padding: 6px; background: var(--input); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
.modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }
.modal-actions button { padding: 8px 16px; border-radius: 4px; font-size: 11px; }

/* Loading */
.loading { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 10px; }
.loading.hidden { display: none; }
.spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="loading hidden" id="loading">
  <div class="spinner"></div>
  <div id="loadingText">Loading...</div>
</div>

<div class="app">
<!-- HEADER -->
<header>
  <h1>üèí BenchSight Pro</h1>
  <div class="hdr-sep"></div>
  <select id="gameSelect" style="width:180px"><option value="">-- Select Game --</option></select>
  <button onclick="loadGameFromSupabase()" class="btn-blue">Load</button>
  <button onclick="showNewGameModal()" class="btn-green">+ New</button>
  <div class="hdr-sep"></div>
  <button onclick="syncFromSupabase()">‚Üì Pull</button>
  <button onclick="pushToSupabase()" class="btn-blue">‚Üë Push</button>
  <span class="spacer"></span>
  <span id="status">Ready</span>
  <button onclick="saveLocal()">üíæ</button>
  <button onclick="exportXLSX()" class="btn-orange">üì• Export</button>
</header>

<!-- MAIN -->
<div class="main">

<!-- LEFT: Team/Period, On-Ice, Roster -->
<div class="left">
  <div class="panel">
    <div class="team-row">
      <button class="team-btn home active" onclick="setTeam('home')" id="homeBtn">HOME</button>
      <button class="team-btn away" onclick="setTeam('away')" id="awayBtn">AWAY</button>
    </div>
    <div class="period-row" id="periodRow"></div>
  </div>
  
  <div class="panel" style="flex:1;min-height:0">
    <h3>On Ice <span class="badge" id="iceTeamBadge">H</span></h3>
    <div class="slots-grid" id="slotsGrid"></div>
    <h3 style="margin-top:6px">Roster <span class="badge" id="rosterCount">0</span></h3>
    <div class="roster" id="rosterList"></div>
  </div>
</div>

<!-- CENTER: Video, Clock, Rink, Events -->
<div class="center">
  <div class="panel video-panel">
    <div class="camera-tabs" id="cameraTabs"></div>
    <div class="video-box" id="videoBox">
      <div class="video-placeholder">üìπ Select game to load video</div>
    </div>
    <div class="video-url-row">
      <input type="text" id="videoUrl" placeholder="YouTube URL or paste...">
      <button onclick="loadVideoManual()">Load</button>
      <button onclick="captureVideoTime()" title="Capture current time">‚è±Ô∏è</button>
      <button onclick="jumpToEventTime()" title="Jump to event time">‚ñ∂</button>
    </div>
  </div>
  
  <div class="panel">
    <div class="clock-row">
      <div class="clock-big" id="clockDisplay">20:00</div>
      <div class="time-inp"><label>Start</label><input type="text" id="timeS" value="20:00" onchange="onTimeChange()"></div>
      <div class="time-inp"><label>End</label><input type="text" id="timeE" value="20:00"></div>
      <button onclick="copyTimeDown()" style="padding:4px 8px" title="Copy start to end">‚¨á</button>
      <div class="video-time">üé¨ <span id="videoTimeDisplay">0s</span></div>
    </div>
  </div>
  
  <div class="rink-row">
    <div class="rink-box">
      <div class="xy-mode-toggle">
        <button id="xyModePuck" class="xy-mode-btn active" onclick="setXYMode('puck')">üèí Puck</button>
        <button id="xyModePlayer" class="xy-mode-btn" onclick="setXYMode('player')">üë§ Player</button>
        <button onclick="clearAllXY()" style="margin-left:auto;font-size:8px;padding:2px 6px">Clear All</button>
      </div>
      <svg class="rink-svg" id="rinkSvg" viewBox="0 0 200 85" onclick="onRinkClick(event)">
        <defs>
          <linearGradient id="iceGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#f8fafc"/>
            <stop offset="100%" style="stop-color:#e2e8f0"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="200" height="85" fill="url(#iceGrad)" stroke="#64748b" stroke-width="1" rx="15"/>
        <line x1="100" y1="0" x2="100" y2="85" stroke="#dc2626" stroke-width="2"/>
        <line x1="25" y1="0" x2="25" y2="85" stroke="#2563eb" stroke-width="1.5"/>
        <line x1="175" y1="0" x2="175" y2="85" stroke="#2563eb" stroke-width="1.5"/>
        <circle cx="100" cy="42.5" r="15" fill="none" stroke="#2563eb" stroke-width="1"/>
        <circle cx="100" cy="42.5" r="2" fill="#2563eb"/>
        <circle cx="31" cy="20.5" r="15" fill="none" stroke="#dc2626" stroke-width="0.75"/>
        <circle cx="31" cy="64.5" r="15" fill="none" stroke="#dc2626" stroke-width="0.75"/>
        <circle cx="169" cy="20.5" r="15" fill="none" stroke="#dc2626" stroke-width="0.75"/>
        <circle cx="169" cy="64.5" r="15" fill="none" stroke="#dc2626" stroke-width="0.75"/>
        <rect x="0" y="36" width="4" height="13" fill="#dc2626" rx="1"/>
        <rect x="196" y="36" width="4" height="13" fill="#dc2626" rx="1"/>
        <!-- Zone labels -->
        <text x="12" y="44" font-size="6" fill="#64748b">DZ</text>
        <text x="97" y="44" font-size="6" fill="#64748b">NZ</text>
        <text x="182" y="44" font-size="6" fill="#64748b">OZ</text>
        <g id="xyMarkers"></g>
      </svg>
      <div class="xy-info">XY: <span id="xyText">Click rink</span> | Zone: <span id="zoneText">-</span></div>
      <div class="xy-points-section">
        <div class="xy-points-label">üèí Puck Trail (10 max):</div>
        <div class="xy-points-row" id="puckXYRow"><span style="color:var(--muted);font-size:8px">Click rink to add puck positions</span></div>
        <div class="xy-points-label">üë§ Player Positions:</div>
        <div class="xy-points-row" id="playerXYRow"><span style="color:var(--muted);font-size:8px">Switch to Player mode</span></div>
      </div>
    </div>
    <div class="net-box" id="netBox">
      <h4>Shot Target</h4>
      <svg class="net-svg" id="netSvg" viewBox="0 0 72 48" onclick="onNetClick(event)">
        <rect x="0" y="0" width="72" height="48" fill="#1e293b" stroke="#475569" stroke-width="1" rx="2"/>
        <line x1="0" y1="24" x2="72" y2="24" stroke="#334155" stroke-width="0.5"/>
        <line x1="24" y1="0" x2="24" y2="48" stroke="#334155" stroke-width="0.5"/>
        <line x1="48" y1="0" x2="48" y2="48" stroke="#334155" stroke-width="0.5"/>
        <!-- Net zones -->
        <text x="8" y="14" font-size="6" fill="#64748b">GH</text>
        <text x="30" y="14" font-size="6" fill="#64748b">TM</text>
        <text x="54" y="14" font-size="6" fill="#64748b">BH</text>
        <text x="8" y="38" font-size="6" fill="#64748b">GL</text>
        <text x="30" y="38" font-size="6" fill="#64748b">5H</text>
        <text x="54" y="38" font-size="6" fill="#64748b">BL</text>
        <g id="netMarker"></g>
      </svg>
      <div class="net-info" id="netInfo">-</div>
    </div>
  </div>
  
  <div class="panel events-panel">
    <div class="events-header">
      <h3>Events <span class="badge" id="evtCount">0</span></h3>
      <div>
        <button onclick="editSelectedEvent()">‚úèÔ∏è Edit</button>
        <button onclick="scrollToLatest()">‚¨á Latest</button>
      </div>
    </div>
    <div class="event-list" id="eventList"></div>
  </div>
  
  <div class="stats-bar">
    <div class="stat"><span class="l">Home:</span><span class="v" id="statHomeG">0</span></div>
    <div class="stat"><span class="l">Away:</span><span class="v" id="statAwayG">0</span></div>
    <div class="stat"><span class="l">Shots:</span><span class="v" id="statShots">0</span></div>
    <div class="stat"><span class="l">Passes:</span><span class="v" id="statPasses">0</span></div>
    <div class="stat"><span class="l">Shifts:</span><span class="v" id="statShifts">0</span></div>
    <div class="stat"><span class="l">Events:</span><span class="v" id="statEvents">0</span></div>
  </div>
</div>

<!-- RIGHT: Event Entry -->
<div class="right">
  <div class="panel" style="flex:1">
    <h3>Event Entry <span id="editingLabel" style="color:var(--warn);display:none">‚úèÔ∏è EDITING #<span id="editingIdx"></span></span></h3>
    
    <div class="evt-types" id="evtTypesGrid"></div>
    
    <div class="form-row">
      <div class="form-group"><label>Detail 1</label><select id="detail1"><option value="">--</option></select></div>
      <div class="form-group"><label>Detail 2</label><select id="detail2"><option value="">--</option></select></div>
    </div>
    
    <div class="form-row">
      <div class="form-group"><label>Play Detail</label><select id="playDetail1"><option value="">--</option></select></div>
      <div class="form-group"><label>Play Detail 2</label><select id="playDetail2"><option value="">--</option></select></div>
    </div>
    
    <div class="form-row quad">
      <div class="form-group"><label>Zone</label>
        <select id="zoneSelect" onchange="onZoneChange()">
          <option value="n">Neutral</option>
          <option value="o">Offensive</option>
          <option value="d">Defensive</option>
        </select>
      </div>
      <div class="form-group"><label>Success</label>
        <div class="success-row">
          <button class="suc-btn s active" onclick="setSuccess('s')" id="sucBtnS">‚úì</button>
          <button class="suc-btn u" onclick="setSuccess('u')" id="sucBtnU">‚úó</button>
        </div>
      </div>
      <div class="form-group"><label>Pressure</label>
        <select id="pressure"><option value="">-</option><option value="1">Yes</option><option value="0">No</option></select>
      </div>
      <div class="form-group"><label>Play Suc</label>
        <select id="playSuccess"><option value="">-</option><option value="s">‚úì</option><option value="u">‚úó</option></select>
      </div>
    </div>
    
    <div class="link-row">
      <label>Link:</label>
      <select id="linkTo" style="max-width:120px"><option value="">None</option></select>
      <button onclick="linkToPrev()">‚¨Ü Prev</button>
      <span class="auto-link" id="autoLinkHint"></span>
    </div>
    
    <div class="players-section">
      <h4>Event Players (1-6) <button onclick="clearEventPlayers()" style="font-size:7px;padding:1px 4px">Clear</button></h4>
      <div class="player-slots" id="eventPlayerSlots"></div>
    </div>
    
    <div class="players-section">
      <h4>Opponent Players (1-6) <button onclick="clearOppPlayers()" style="font-size:7px;padding:1px 4px">Clear</button></h4>
      <div class="player-slots" id="oppPlayerSlots"></div>
    </div>
    
    <div class="xy-points-row" id="xyPointsRow" style="display:none">
      <span style="font-size:8px;color:var(--muted);width:100%">Player XY Points (click to remove):</span>
    </div>
    
    <div class="action-row">
      <button class="clear" onclick="clearEventForm()">Clear</button>
      <button class="save" onclick="saveEvent()" id="saveBtn">Save (Enter)</button>
      <button class="update" onclick="updateEvent()" id="updateBtn" style="display:none">Update</button>
    </div>
  </div>
  
  <div class="panel shift-panel">
    <h4>Shift #<span id="shiftNum">1</span> <button onclick="showShiftEditor()" style="font-size:7px;padding:1px 4px">Edit All</button></h4>
    <div class="shift-info">
      <input type="text" id="shiftStart" placeholder="Start" value="20:00">
      <span>‚Üí</span>
      <input type="text" id="shiftEnd" placeholder="End">
      <select id="shiftType">
        <option value="GameStart">Game Start</option>
        <option value="OtherFaceoff">Faceoff</option>
        <option value="Icing">Icing</option>
        <option value="Offside">Offside</option>
        <option value="Penalty">Penalty</option>
        <option value="Goal">Goal</option>
        <option value="">On-the-fly</option>
      </select>
    </div>
    <div class="shift-btns">
      <button onclick="endCurrentShift()">End Shift</button>
      <button onclick="newShift()" class="btn-green">+ New Shift</button>
    </div>
  </div>
</div>

</div>

<!-- FOOTER -->
<footer>
  <kbd>F</kbd>ace <kbd>S</kbd>hot <kbd>G</kbd>oal <kbd>V</kbd>Save <kbd>P</kbd>ass <kbd>T</kbd>urn <kbd>Z</kbd>Entry <kbd>X</kbd>Exit <kbd>H</kbd>it <kbd>B</kbd>lock <kbd>R</kbd>etrieval <kbd>W</kbd>Stop |
  <kbd>Space</kbd>=Toggle Success | <kbd>Enter</kbd>=Save | <kbd>1-4</kbd>=Period | <kbd>Esc</kbd>=Clear
</footer>

</div>

<!-- MODALS -->
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)hideModal()">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// ============================================================================
// CONFIGURATION
// ============================================================================
const SUPABASE_URL = 'https://uuaowslhpgyiudmbvqze.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YW93c2xocGd5aXVkbWJ2cXplIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Njg1NDk4NywiZXhwIjoyMDgyNDMwOTg3fQ.BV5d03x9Hv83XZsveGdU7k7D7gAZ7Yi1tqNB7DeDkrM';

// ============================================================================
// STATE
// ============================================================================
const S = {
  gameId: null,
  game: null,
  period: 1,
  team: 'home', // Current team context for adding players
  playerSlotMode: 'event', // 'event' or 'opp' - which slot group to add to
  activePlayerSlot: 0, // 0-5 for the 6 slots
  events: [],
  shifts: [],
  currentShiftIdx: 1,
  onIce: {
    home: { F1: null, F2: null, F3: null, D1: null, D2: null, G: null },
    away: { F1: null, F2: null, F3: null, D1: null, D2: null, G: null }
  },
  roster: { home: [], away: [] },
  selectedSlot: null,
  editingEventIdx: null, // Event index being edited, or null
  evt: {
    type: null,
    detail1: '', detail2: '',
    playDetail1: '', playDetail2: '', playSuccess: '',
    zone: 'n', success: 's', pressure: '',
    linkedTo: null,
    eventPlayers: [null, null, null, null, null, null], // 6 slots for event team
    oppPlayers: [null, null, null, null, null, null], // 6 slots for opp team  
    playerXYPoints: [], // [{x, y, playerIdx, playerId}] up to 10 per player
    puckXYPoints: [], // [{x, y, timestamp}] up to 10 per event - PUCK TRACKING
    netLocation: null, // {x, y, code}
  },
  // XY tracking data for Supabase
  puckXYData: [], // [{event_index, points: [{x, y, z, timestamp}]}]
  playerXYData: [], // [{event_index, player_id, team_venue, points: [{x, y, timestamp}]}]
  shotXYData: [], // [{event_index, shot_x, shot_y, target_x, target_y, net_location, ...}]
  
  videos: [], // [{type, url}] multiple camera angles
  activeCamera: 0,
  videoOffset: 0, // Seconds offset for period 1 start
  ytPlayer: null,
  xyMode: 'puck', // 'puck' or 'player' - which XY to record on click
  
  // Reference data from Supabase
  ref: {
    schedule: [],
    players: [],
    rosters: [],
    playDetails: [],
    playDetails2: [],
    eventDetails: {},
    netLocations: []
  }
};

// Event type definitions with details and auto-link rules
const EVENT_TYPES = [
  { key: 'Faceoff', label: 'Faceoff', kbd: 'F', details1: ['Faceoff_GameStart','Faceoff_AfterGoal','Faceoff_AfterIcing','Faceoff_AfterOffside','Faceoff_AfterPenalty','Faceoff_AfterStoppage'], details2: [], autoLink: null },
  { key: 'Shot', label: 'Shot', kbd: 'S', details1: ['Shot_Wrist','Shot_Slap','Shot_Snap','Shot_Backhand','Shot_Tip','Shot_Deflection','Shot_Wrap'], details2: ['Shot-OnNet','Shot-Blocked','Shot-Missed','Shot-Post','Shot Goal'], autoLink: 'Save', showNet: true },
  { key: 'Goal', label: 'Goal', kbd: 'G', details1: ['Goal_EvenStrength','Goal_PowerPlay','Goal_ShortHanded','Goal_EmptyNet'], details2: ['Goal Scored'], autoLink: null, showNet: true },
  { key: 'Save', label: 'Save', kbd: 'V', details1: ['Save_Glove','Save_Blocker','Save_Pad','Save_Body','Save_Stick'], details2: ['Save-Rebound','Save-Freeze','Save-Cover'], autoLink: null },
  { key: 'Pass', label: 'Pass', kbd: 'P', details1: ['Pass_Completed','Pass_Incomplete','Pass_Intercepted'], details2: ['Pass-Forehand','Pass-Backhand','Pass-Saucer','Pass-Bank','Pass-Chip','Pass-Drop'], autoLink: null },
  { key: 'Turnover', label: 'Turn', kbd: 'T', details1: ['Turnover_Giveaway','Turnover_Takeaway','Turnover_LostBattle'], details2: ['Giveaway-BadPass','Giveaway-LostPuck','Takeaway-Stick','Takeaway-Body'], autoLink: null },
  { key: 'Zone_Entry', label: 'Entry', kbd: 'Z', details1: ['ZoneEntry-Carry','ZoneEntry-Pass','ZoneEntry-DumpIn','ZoneEntry-DumpChase'], details2: ['Entry-Controlled','Entry-Uncontrolled'], autoLink: null },
  { key: 'Zone_Exit', label: 'Exit', kbd: 'X', details1: ['ZoneExit-Carry','ZoneExit-Pass','ZoneExit-Clear','ZoneExit-Dump'], details2: ['Exit-Clean','Exit-Pressured'], autoLink: null },
  { key: 'Hit', label: 'Hit', kbd: 'H', details1: ['Hit_Body','Hit_Stick','Hit_Board'], details2: ['Hit-Clean','Hit-Penalty'], autoLink: null },
  { key: 'Block', label: 'Block', kbd: 'B', details1: ['Block_Shot','Block_Pass'], details2: [], autoLink: null },
  { key: 'Retrieval', label: 'Retrieval', kbd: 'R', details1: ['Retrieval_Board','Retrieval_Corner','Retrieval_Slot','Retrieval_Rebound'], details2: [], autoLink: null },
  { key: 'Stoppage', label: 'Stop', kbd: 'W', details1: ['Stoppage_Whistle','Stoppage_Icing','Stoppage_Offside','Stoppage_Penalty','Stoppage_GoalieFreeze','Stoppage_PuckOutOfPlay'], details2: [], autoLink: null }
];

const NET_LOCATIONS = [
  { code: 'GH', name: 'Glove High', x: 18, y: 12 },
  { code: 'TM', name: 'Top Middle', x: 36, y: 8 },
  { code: 'BH', name: 'Blocker High', x: 54, y: 12 },
  { code: 'GL', name: 'Glove Low', x: 18, y: 36 },
  { code: '5H', name: 'Five Hole', x: 36, y: 40 },
  { code: 'BL', name: 'Blocker Low', x: 54, y: 36 }
];

// ============================================================================
// INITIALIZATION
// ============================================================================
async function init() {
  showLoading('Initializing...');
  buildUI();
  setupKeyboard();
  await loadReferenceData();
  loadLocalState();
  hideLoading();
  updateStatus('Ready');
}

function buildUI() {
  // Period buttons
  document.getElementById('periodRow').innerHTML = [1,2,3,4].map(p => 
    `<button class="period-btn ${p===1?'active':''}" onclick="setPeriod(${p})">${p===4?'OT':'P'+p}</button>`
  ).join('');
  
  // Event type buttons
  document.getElementById('evtTypesGrid').innerHTML = EVENT_TYPES.map(et =>
    `<button class="evt-btn" data-type="${et.key}" onclick="setEventType('${et.key}')"><span>${et.label}</span><kbd>${et.kbd}</kbd></button>`
  ).join('');
  
  // On-ice slots
  const slotLabels = { F1: 'LW', F2: 'C', F3: 'RW', D1: 'LD', D2: 'RD', G: 'G' };
  document.getElementById('slotsGrid').innerHTML = Object.entries(slotLabels).map(([s, lbl]) =>
    `<div class="slot" data-slot="${s}" onclick="selectIceSlot('${s}')"><div class="lbl">${lbl}</div><div class="num" id="slot${s}">-</div></div>`
  ).join('');
  
  // Player slots (6 each for event and opp)
  document.getElementById('eventPlayerSlots').innerHTML = [1,2,3,4,5,6].map(i =>
    `<div class="player-slot-row"><span class="role">P${i}</span><div class="num" id="evtP${i}" onclick="activatePlayerSlot('event',${i-1})">-</div><span class="clear" onclick="clearPlayerSlot('event',${i-1})">√ó</span></div>`
  ).join('');
  
  document.getElementById('oppPlayerSlots').innerHTML = [1,2,3,4,5,6].map(i =>
    `<div class="player-slot-row"><span class="role">O${i}</span><div class="num opp" id="oppP${i}" onclick="activatePlayerSlot('opp',${i-1})">-</div><span class="clear" onclick="clearPlayerSlot('opp',${i-1})">√ó</span></div>`
  ).join('');
}

function setupKeyboard() {
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
    
    const keyMap = {};
    EVENT_TYPES.forEach(et => keyMap[et.kbd.toLowerCase()] = et.key);
    
    if (keyMap[e.key.toLowerCase()]) { 
      setEventType(keyMap[e.key.toLowerCase()]); 
      e.preventDefault(); 
    }
    if (e.key === ' ') { toggleSuccess(); e.preventDefault(); }
    if (e.key === 'Enter') { 
      if (S.editingEventIdx !== null) updateEvent();
      else saveEvent(); 
      e.preventDefault(); 
    }
    if (e.key >= '1' && e.key <= '4') { setPeriod(+e.key); e.preventDefault(); }
    if (e.key === 'Escape') { clearEventForm(); e.preventDefault(); }
  });
}

// ============================================================================
// SUPABASE API
// ============================================================================
async function sbFetch(table, query = '') {
  const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
  });
  if (!resp.ok) throw new Error(`Supabase error: ${resp.status}`);
  return resp.json();
}

async function sbUpsert(table, data) {
  const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: { 
      'apikey': SUPABASE_KEY, 
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    body: JSON.stringify(data)
  });
  if (!resp.ok) throw new Error(`Supabase error: ${resp.status}`);
  return resp;
}

async function loadReferenceData() {
  showLoading('Loading reference data...');
  try {
    // Load schedule
    S.ref.schedule = await sbFetch('dim_schedule', 'select=game_id,game_date_str,home_team_name,away_team_name,home_team_id,away_team_id&order=game_date_str.desc&limit=100');
    
    // Load players
    S.ref.players = await sbFetch('dim_player', 'select=player_id,player_full_name,player_first_name,player_last_name,player_primary_position,current_skill_rating');
    
    // Load rosters (recent games)
    S.ref.rosters = await sbFetch('fact_gameroster', 'select=game_id,player_id,player_game_number,team_venue,team_name,player_position&limit=2000');
    
    // Load play details
    S.ref.playDetails = await sbFetch('dim_play_detail', 'select=play_detail_id,play_detail_code,play_detail_name');
    S.ref.playDetails2 = await sbFetch('dim_play_detail_2', 'select=play_detail_2_id,play_detail_2_code,play_detail_2_name');
    
    // Load videos
    S.videos = await sbFetch('fact_video', 'select=*');
    
    populateGameSelect();
    populatePlayDetailDropdowns();
    
  } catch (err) {
    console.error('Error loading reference data:', err);
    updateStatus('Error loading data: ' + err.message);
  }
}

function populateGameSelect() {
  const sel = document.getElementById('gameSelect');
  sel.innerHTML = '<option value="">-- Select Game --</option>';
  
  // Add games from schedule
  S.ref.schedule.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.game_id;
    opt.textContent = `${g.game_id} - ${g.game_date_str || ''} ${g.home_team_name || ''} vs ${g.away_team_name || ''}`;
    sel.appendChild(opt);
  });
  
  // Add locally saved games
  const saved = Object.keys(localStorage).filter(k => k.startsWith('bst_game_'));
  saved.forEach(k => {
    const gid = k.replace('bst_game_', '');
    if (!S.ref.schedule.find(g => g.game_id === gid)) {
      const opt = document.createElement('option');
      opt.value = gid;
      opt.textContent = `${gid} (local)`;
      sel.appendChild(opt);
    }
  });
}

function populatePlayDetailDropdowns() {
  const pd1 = document.getElementById('playDetail1');
  const pd2 = document.getElementById('playDetail2');
  
  pd1.innerHTML = '<option value="">--</option>' + S.ref.playDetails.map(p => 
    `<option value="${p.play_detail_code}">${p.play_detail_code}</option>`
  ).join('');
  
  pd2.innerHTML = '<option value="">--</option>' + S.ref.playDetails2.map(p => 
    `<option value="${p.play_detail_2_code}">${p.play_detail_2_code}</option>`
  ).join('');
}

// ============================================================================
// GAME LOADING
// ============================================================================
async function loadGameFromSupabase() {
  const gid = document.getElementById('gameSelect').value;
  if (!gid) { alert('Select a game first'); return; }
  
  showLoading('Loading game ' + gid + '...');
  
  try {
    // Get game info
    const gameInfo = S.ref.schedule.find(g => g.game_id === gid);
    if (!gameInfo) throw new Error('Game not found in schedule');
    
    S.gameId = gid;
    S.game = gameInfo;
    
    // Load roster for this game
    const roster = S.ref.rosters.filter(r => r.game_id === gid);
    S.roster.home = roster.filter(r => r.team_venue === 'Home').map(r => ({
      number: parseInt(r.player_game_number) || 0,
      playerId: r.player_id,
      name: getPlayerName(r.player_id),
      position: r.player_position
    })).sort((a,b) => a.number - b.number);
    
    S.roster.away = roster.filter(r => r.team_venue === 'Away').map(r => ({
      number: parseInt(r.player_game_number) || 0,
      playerId: r.player_id,
      name: getPlayerName(r.player_id),
      position: r.player_position
    })).sort((a,b) => a.number - b.number);
    
    // Try to load existing tracking data
    try {
      const events = await sbFetch('fact_events', `game_id=eq.${gid}&order=event_index`);
      const eventsPlayer = await sbFetch('fact_events_player', `game_id=eq.${gid}&order=event_index`);
      const shifts = await sbFetch('fact_shifts', `game_id=eq.${gid}&order=shift_index`);
      
      if (events.length > 0) {
        // Convert to our format
        S.events = mergeEventData(events, eventsPlayer);
        S.shifts = shifts;
        S.currentShiftIdx = shifts.length + 1;
        updateStatus(`Loaded ${events.length} events, ${shifts.length} shifts`);
      } else {
        S.events = [];
        S.shifts = [];
        S.currentShiftIdx = 1;
        updateStatus('New game - no existing data');
      }
    } catch (e) {
      // No existing data
      S.events = [];
      S.shifts = [];
      S.currentShiftIdx = 1;
    }
    
    // Load videos for this game
    const gameVideos = S.videos.filter(v => v.game_id === gid);
    setupVideos(gameVideos);
    
    // Check for local save
    loadLocalState();
    
    renderAll();
    hideLoading();
    
  } catch (err) {
    hideLoading();
    alert('Error loading game: ' + err.message);
  }
}

function mergeEventData(events, eventsPlayer) {
  // Group events player by event_index
  const playersByEvent = {};
  eventsPlayer.forEach(ep => {
    if (!playersByEvent[ep.event_index]) playersByEvent[ep.event_index] = [];
    playersByEvent[ep.event_index].push(ep);
  });
  
  // Build merged event rows
  const merged = [];
  events.forEach(e => {
    const players = playersByEvent[e.event_index] || [];
    // Create one row per player (or one row if no players)
    if (players.length === 0) {
      merged.push({ ...e, player_game_number_: '', player_role: '', role_number: 1 });
    } else {
      players.forEach((p, i) => {
        merged.push({
          ...e,
          player_game_number_: p.player_number || p.player_game_number,
          player_id: p.player_id,
          player_role: p.player_role,
          role_number: i + 1,
          event_index_flag_: i === 0 ? 1 : ''
        });
      });
    }
  });
  
  return merged;
}

function getPlayerName(playerId) {
  const p = S.ref.players.find(pl => pl.player_id === playerId);
  return p ? p.player_full_name : '';
}

function setupVideos(videos) {
  const tabs = document.getElementById('cameraTabs');
  if (videos.length === 0) {
    tabs.innerHTML = '<div class="cam-tab active">No Video</div>';
    return;
  }
  
  S.videos = videos;
  S.activeCamera = 0;
  
  tabs.innerHTML = videos.map((v, i) => 
    `<div class="cam-tab ${i===0?'active':''}" onclick="switchCamera(${i})">${v.Video_Type || 'Cam '+(i+1)}</div>`
  ).join('');
  
  loadVideo(videos[0].Url_1);
}

function switchCamera(idx) {
  S.activeCamera = idx;
  document.querySelectorAll('.cam-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
  if (S.videos[idx]) loadVideo(S.videos[idx].Url_1);
}

function loadVideo(url) {
  if (!url) return;
  
  let videoId = '';
  if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
  else if (url.includes('v=')) videoId = url.split('v=')[1].split(/[?&]/)[0];
  
  if (videoId) {
    document.getElementById('videoBox').innerHTML = 
      `<iframe id="ytFrame" src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${location.origin}" allowfullscreen></iframe>`;
    document.getElementById('videoUrl').value = url;
  }
}

function loadVideoManual() {
  const url = document.getElementById('videoUrl').value;
  loadVideo(url);
}

// ============================================================================
// TEAM / PERIOD / TIME
// ============================================================================
function setTeam(t) {
  S.team = t;
  document.getElementById('homeBtn').classList.toggle('active', t === 'home');
  document.getElementById('awayBtn').classList.toggle('active', t === 'away');
  document.getElementById('iceTeamBadge').textContent = t === 'home' ? 'H' : 'A';
  renderRoster();
  renderOnIce();
}

function setPeriod(p) {
  S.period = p;
  document.querySelectorAll('.period-btn').forEach((b, i) => b.classList.toggle('active', i + 1 === p));
  updateVideoTime();
}

function onTimeChange() {
  const t = document.getElementById('timeS').value;
  document.getElementById('clockDisplay').textContent = t;
  updateVideoTime();
  autoDetectZone();
}

function copyTimeDown() {
  document.getElementById('timeE').value = document.getElementById('timeS').value;
}

function updateVideoTime() {
  const [m, s] = parseTime(document.getElementById('timeS').value);
  const vt = calcVideoTime(S.period, m, s);
  document.getElementById('videoTimeDisplay').textContent = vt + 's';
}

function parseTime(str) {
  if (!str) return [0, 0];
  const parts = str.split(':');
  return [parseInt(parts[0]) || 0, parseInt(parts[1]) || 0];
}

function calcVideoTime(period, min, sec) {
  // Clock counts down from 20:00, video counts up
  const periodSec = (20 - min) * 60 - sec;
  const priorPeriods = (period - 1) * 20 * 60;
  const intermission = (period - 1) * 90; // ~1.5 min between periods
  return priorPeriods + periodSec + intermission + S.videoOffset;
}

function captureVideoTime() {
  const t = prompt('Enter current video time in seconds (from video player):');
  if (t !== null) {
    const [m, s] = parseTime(document.getElementById('timeS').value);
    const expected = calcVideoTime(S.period, m, s) - S.videoOffset;
    S.videoOffset = parseInt(t) - expected;
    updateVideoTime();
    updateStatus('Video offset set to ' + S.videoOffset + 's');
  }
}

function jumpToEventTime() {
  const vt = parseInt(document.getElementById('videoTimeDisplay').textContent);
  const iframe = document.getElementById('ytFrame');
  if (iframe) {
    // Try to control YouTube player
    try {
      iframe.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'seekTo', args: [vt, true] }), '*');
    } catch (e) {
      console.log('Cannot control video:', e);
    }
  }
}

// ============================================================================
// ON-ICE SLOTS & ROSTER
// ============================================================================
function selectIceSlot(slot) {
  if (S.selectedSlot === slot) {
    S.selectedSlot = null;
  } else {
    S.selectedSlot = slot;
  }
  renderOnIce();
}

function renderOnIce() {
  const ice = S.onIce[S.team];
  ['F1','F2','F3','D1','D2','G'].forEach(s => {
    const el = document.getElementById('slot' + s);
    const slotDiv = document.querySelector(`.slot[data-slot="${s}"]`);
    el.textContent = ice[s] || '-';
    slotDiv.classList.toggle('filled', !!ice[s]);
    slotDiv.classList.toggle('active', S.selectedSlot === s);
  });
}

function renderRoster() {
  const r = S.roster[S.team] || [];
  const onIceNums = Object.values(S.onIce[S.team]).filter(Boolean);
  const evtPlayerNums = S.evt.eventPlayers.filter(Boolean).map(p => p.number);
  const oppPlayerNums = S.evt.oppPlayers.filter(Boolean).map(p => p.number);
  
  document.getElementById('rosterCount').textContent = r.length;
  document.getElementById('rosterList').innerHTML = r.map(p => {
    let cls = 'player';
    if (onIceNums.includes(p.number)) cls += ' on-ice';
    if (S.team === S.team && evtPlayerNums.includes(p.number)) cls += ' evt-player';
    // Check opp team
    const oppTeam = S.team === 'home' ? 'away' : 'home';
    if (S.roster[oppTeam].find(op => op.number === p.number && oppPlayerNums.includes(p.number))) cls += ' opp-player';
    
    return `<div class="${cls}" onclick="onPlayerClick(${p.number},'${S.team}')"><span class="n">${p.number}</span></div>`;
  }).join('') || '<span style="color:var(--muted)">No roster</span>';
}

function onPlayerClick(num, team) {
  // If ice slot is selected, assign player to slot
  if (S.selectedSlot) {
    S.onIce[team][S.selectedSlot] = num;
    S.selectedSlot = null;
    renderOnIce();
    renderRoster();
    return;
  }
  
  // Otherwise add to event/opp player slots
  const player = S.roster[team].find(p => p.number === num);
  if (!player) return;
  
  if (S.playerSlotMode === 'event' && team === S.team) {
    // Add to event players
    const emptySlot = S.evt.eventPlayers.findIndex(p => p === null);
    if (emptySlot >= 0) {
      S.evt.eventPlayers[emptySlot] = { number: num, playerId: player.playerId, team };
      renderPlayerSlots();
    }
  } else {
    // Add to opp players
    const emptySlot = S.evt.oppPlayers.findIndex(p => p === null);
    if (emptySlot >= 0) {
      S.evt.oppPlayers[emptySlot] = { number: num, playerId: player.playerId, team };
      renderPlayerSlots();
    }
  }
  renderRoster();
}

function activatePlayerSlot(mode, idx) {
  S.playerSlotMode = mode;
  S.activePlayerSlot = idx;
  // Visual feedback
  document.querySelectorAll('.player-slot-row .num').forEach(el => el.style.outline = '');
  const el = document.getElementById(mode === 'event' ? `evtP${idx+1}` : `oppP${idx+1}`);
  if (el) el.style.outline = '2px solid var(--accent)';
  
  // Switch team view if clicking opp slots
  if (mode === 'opp' && S.team === 'home') setTeam('away');
  else if (mode === 'opp' && S.team === 'away') setTeam('home');
}

function clearPlayerSlot(mode, idx) {
  if (mode === 'event') S.evt.eventPlayers[idx] = null;
  else S.evt.oppPlayers[idx] = null;
  renderPlayerSlots();
  renderRoster();
}

function clearEventPlayers() {
  S.evt.eventPlayers = [null, null, null, null, null, null];
  renderPlayerSlots();
  renderRoster();
}

function clearOppPlayers() {
  S.evt.oppPlayers = [null, null, null, null, null, null];
  renderPlayerSlots();
  renderRoster();
}

function renderPlayerSlots() {
  S.evt.eventPlayers.forEach((p, i) => {
    const el = document.getElementById(`evtP${i+1}`);
    if (p) {
      el.textContent = '#' + p.number;
      el.classList.add('filled');
    } else {
      el.textContent = '-';
      el.classList.remove('filled');
    }
  });
  
  S.evt.oppPlayers.forEach((p, i) => {
    const el = document.getElementById(`oppP${i+1}`);
    if (p) {
      el.textContent = '#' + p.number;
      el.classList.add('filled');
    } else {
      el.textContent = '-';
      el.classList.remove('filled');
    }
  });
}

// ============================================================================
// EVENT TYPE & DETAILS
// ============================================================================
function setEventType(type) {
  S.evt.type = type;
  
  // Update button states
  document.querySelectorAll('.evt-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
  
  // Populate detail dropdowns
  const et = EVENT_TYPES.find(e => e.key === type);
  if (et) {
    document.getElementById('detail1').innerHTML = '<option value="">--</option>' + 
      et.details1.map(d => `<option value="${d}">${d}</option>`).join('');
    document.getElementById('detail2').innerHTML = '<option value="">--</option>' + 
      et.details2.map(d => `<option value="${d}">${d}</option>`).join('');
    
    // Auto-select first detail
    if (et.details1.length) document.getElementById('detail1').value = et.details1[0];
    if (type === 'Goal') document.getElementById('detail2').value = 'Goal Scored';
    
    // Show/hide net target
    document.getElementById('netBox').style.display = et.showNet ? 'block' : 'none';
    
    // Auto-link hint
    if (et.autoLink) {
      document.getElementById('autoLinkHint').textContent = `‚Üí auto-links to ${et.autoLink}`;
    } else {
      document.getElementById('autoLinkHint').textContent = '';
    }
  }
}

function setSuccess(s) {
  S.evt.success = s;
  document.getElementById('sucBtnS').classList.toggle('active', s === 's');
  document.getElementById('sucBtnU').classList.toggle('active', s === 'u');
}

function toggleSuccess() {
  setSuccess(S.evt.success === 's' ? 'u' : 's');
}

function linkToPrev() {
  const uniqueEvents = getUniqueEvents();
  if (uniqueEvents.length > 0) {
    const last = uniqueEvents[uniqueEvents.length - 1];
    document.getElementById('linkTo').value = last.event_index;
    S.evt.linkedTo = last.event_index;
  }
}

// ============================================================================
// RINK & NET CLICK - PUCK & PLAYER XY TRACKING
// ============================================================================
function onRinkClick(e) {
  const svg = document.getElementById('rinkSvg');
  const rect = svg.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width * 200).toFixed(1);
  const y = ((e.clientY - rect.top) / rect.height * 85).toFixed(1);
  const timestamp = calcVideoTime(S.period, ...parseTime(document.getElementById('timeS').value));
  
  if (S.xyMode === 'puck') {
    // Puck tracking - up to 10 points per event
    if (S.evt.puckXYPoints.length < 10) {
      S.evt.puckXYPoints.push({ x: parseFloat(x), y: parseFloat(y), z: 0, timestamp });
      renderPuckXYPoints();
    }
  } else {
    // Player tracking - up to 10 points per player
    if (S.evt.playerXYPoints.length < 10) {
      const activePlayer = S.evt.eventPlayers[S.activePlayerSlot] || S.evt.oppPlayers[S.activePlayerSlot];
      S.evt.playerXYPoints.push({ 
        x: parseFloat(x), 
        y: parseFloat(y), 
        timestamp,
        playerIdx: S.activePlayerSlot,
        playerId: activePlayer?.playerId || ''
      });
      renderPlayerXYPoints();
    }
  }
  
  // Draw marker on rink
  renderRinkMarkers();
  
  document.getElementById('xyText').textContent = `(${x}, ${y})`;
  
  // Auto-detect zone from x position
  autoDetectZone(parseFloat(x));
}

function renderRinkMarkers() {
  const markers = document.getElementById('xyMarkers');
  let html = '';
  
  // Puck points - red circles with trail line
  if (S.evt.puckXYPoints.length > 0) {
    // Draw trail line
    if (S.evt.puckXYPoints.length > 1) {
      const pathData = S.evt.puckXYPoints.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
      html += `<path d="${pathData}" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="2,2" opacity="0.7"/>`;
    }
    // Draw points
    S.evt.puckXYPoints.forEach((p, i) => {
      html += `<circle cx="${p.x}" cy="${p.y}" r="${i === S.evt.puckXYPoints.length - 1 ? 4 : 2.5}" fill="#ef4444" stroke="#fff" stroke-width="0.5"/>`;
      html += `<text x="${p.x + 4}" y="${p.y - 2}" font-size="5" fill="#ef4444">${i + 1}</text>`;
    });
  }
  
  // Player points - blue circles
  S.evt.playerXYPoints.forEach((p, i) => {
    html += `<circle cx="${p.x}" cy="${p.y}" r="3" fill="#3b82f6" stroke="#fff" stroke-width="0.5"/>`;
    html += `<text x="${p.x + 4}" y="${p.y - 2}" font-size="5" fill="#3b82f6">P${p.playerIdx + 1}</text>`;
  });
  
  markers.innerHTML = html;
}

function renderPuckXYPoints() {
  const row = document.getElementById('puckXYRow');
  if (S.evt.puckXYPoints.length === 0) {
    row.innerHTML = '<span style="color:var(--muted);font-size:8px">Click rink to add puck positions (max 10)</span>';
    return;
  }
  
  row.innerHTML = S.evt.puckXYPoints.map((p, i) => 
    `<div class="xy-point puck" onclick="removePuckXYPoint(${i})" title="Click to remove">${i + 1}: (${p.x},${p.y})</div>`
  ).join('') + `<span style="font-size:8px;color:var(--muted)">${S.evt.puckXYPoints.length}/10</span>`;
}

function renderPlayerXYPoints() {
  const row = document.getElementById('playerXYRow');
  if (S.evt.playerXYPoints.length === 0) {
    row.innerHTML = '<span style="color:var(--muted);font-size:8px">Switch to Player mode to track player positions</span>';
    return;
  }
  
  row.innerHTML = S.evt.playerXYPoints.map((p, i) => 
    `<div class="xy-point player" onclick="removePlayerXYPoint(${i})" title="Click to remove">P${p.playerIdx + 1}: (${p.x},${p.y})</div>`
  ).join('') + `<span style="font-size:8px;color:var(--muted)">${S.evt.playerXYPoints.length}/10</span>`;
}

function removePuckXYPoint(idx) {
  S.evt.puckXYPoints.splice(idx, 1);
  renderPuckXYPoints();
  renderRinkMarkers();
}

function removePlayerXYPoint(idx) {
  S.evt.playerXYPoints.splice(idx, 1);
  renderPlayerXYPoints();
  renderRinkMarkers();
}

function setXYMode(mode) {
  S.xyMode = mode;
  document.getElementById('xyModePuck').classList.toggle('active', mode === 'puck');
  document.getElementById('xyModePlayer').classList.toggle('active', mode === 'player');
}

function autoDetectZone(x) {
  let zone = 'n';
  if (x < 50) zone = 'd';
  else if (x > 150) zone = 'o';
  
  // Flip if away team
  if (S.team === 'away') {
    if (zone === 'o') zone = 'd';
    else if (zone === 'd') zone = 'o';
  }
  
  S.evt.zone = zone;
  document.getElementById('zoneSelect').value = zone;
  document.getElementById('zoneText').textContent = { n: 'Neutral', o: 'Offensive', d: 'Defensive' }[zone];
}

function onZoneChange() {
  S.evt.zone = document.getElementById('zoneSelect').value;
}

function onNetClick(e) {
  const svg = document.getElementById('netSvg');
  const rect = svg.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width * 72;
  const y = (e.clientY - rect.top) / rect.height * 48;
  
  // Find closest net location
  let closest = NET_LOCATIONS[0];
  let minDist = Infinity;
  NET_LOCATIONS.forEach(nl => {
    const dist = Math.sqrt((x - nl.x) ** 2 + (y - nl.y) ** 2);
    if (dist < minDist) { minDist = dist; closest = nl; }
  });
  
  S.evt.netLocation = closest;
  
  // Show marker
  document.getElementById('netMarker').innerHTML = 
    `<circle cx="${closest.x}" cy="${closest.y}" r="6" fill="var(--accent)" stroke="#fff" stroke-width="1"/>`;
  document.getElementById('netInfo').textContent = closest.name;
}

// ============================================================================
// SAVE / UPDATE EVENT
// ============================================================================
function saveEvent() {
  if (!S.evt.type) { alert('Select event type'); return; }
  if (!S.gameId) { alert('Load or create a game first'); return; }
  
  const timeS = document.getElementById('timeS').value;
  const timeE = document.getElementById('timeE').value;
  const [startMin, startSec] = parseTime(timeS);
  const [endMin, endSec] = parseTime(timeE);
  
  const eventIndex = 1000 + getUniqueEvents().length + 1;
  const videoTime = calcVideoTime(S.period, startMin, startSec);
  
  // Collect players
  const evtPlayers = S.evt.eventPlayers.filter(Boolean);
  const oppPlayers = S.evt.oppPlayers.filter(Boolean);
  const allPlayers = [
    ...evtPlayers.map((p, i) => ({ ...p, role: `event_team_player_${i+1}`, roleNum: i + 1 })),
    ...oppPlayers.map((p, i) => ({ ...p, role: `opp_team_player_${i+1}`, roleNum: i + 1 }))
  ];
  
  // If no players, add one empty row
  if (allPlayers.length === 0) {
    allPlayers.push({ number: '', playerId: '', team: S.team, role: 'event_team_player_1', roleNum: 1 });
  }
  
  // Get primary puck position (first point or last point)
  const puckPos = S.evt.puckXYPoints.length > 0 ? S.evt.puckXYPoints[S.evt.puckXYPoints.length - 1] : null;
  
  // Create event rows
  allPlayers.forEach((p, i) => {
    const row = {
      event_index: eventIndex,
      event_index_flag_: i === 0 ? 1 : '',
      period: S.period,
      event_start_min_: i === 0 ? startMin : '',
      event_start_sec_: i === 0 ? startSec : '',
      event_end_min_: i === 0 ? endMin : '',
      event_end_sec_: i === 0 ? endSec : '',
      player_game_number_: p.number,
      player_id: p.playerId,
      player_role: p.role,
      role_number: p.roleNum,
      event_team_zone_: S.evt.zone,
      event_type_: S.evt.type,
      event_detail_: document.getElementById('detail1').value,
      event_detail_2_: document.getElementById('detail2').value,
      event_successful_: S.evt.success,
      play_detail1_: document.getElementById('playDetail1').value,
      play_detail2_: document.getElementById('playDetail2').value,
      play_detail_successful_: document.getElementById('playSuccess').value,
      pressured_pressurer_: document.getElementById('pressure').value,
      team_: S.team[0],
      team_venue_: S.team === 'home' ? 'Home' : 'Away',
      team_venue_abv_: S.team[0],
      linked_event_index_: S.evt.linkedTo || '',
      running_video_time: videoTime,
      shift_index: S.currentShiftIdx,
      game_id: S.gameId,
      // XY data - primary puck position
      xy_x: puckPos ? puckPos.x : '',
      xy_y: puckPos ? puckPos.y : '',
      // Net location for shots
      net_location: S.evt.netLocation ? S.evt.netLocation.code : ''
    };
    
    S.events.push(row);
  });
  
  // Store puck XY data for Supabase (10 points per event)
  if (S.evt.puckXYPoints.length > 0) {
    S.puckXYData.push({
      event_index: eventIndex,
      points: S.evt.puckXYPoints.map(p => ({ x: p.x, y: p.y, z: p.z || 0, timestamp: p.timestamp }))
    });
  }
  
  // Store player XY data for Supabase
  if (S.evt.playerXYPoints.length > 0) {
    // Group by player
    const playerGroups = {};
    S.evt.playerXYPoints.forEach(p => {
      if (!playerGroups[p.playerId]) {
        playerGroups[p.playerId] = { playerId: p.playerId, points: [] };
      }
      playerGroups[p.playerId].points.push({ x: p.x, y: p.y, timestamp: p.timestamp });
    });
    
    Object.values(playerGroups).forEach(pg => {
      S.playerXYData.push({
        event_index: eventIndex,
        player_id: pg.playerId,
        team_venue: S.team === 'home' ? 'Home' : 'Away',
        points: pg.points
      });
    });
  }
  
  // Store shot XY data for shots/goals
  if (['Shot', 'Goal'].includes(S.evt.type) && puckPos) {
    S.shotXYData.push({
      event_index: eventIndex,
      player_id: evtPlayers[0]?.playerId || '',
      team_venue: S.team === 'home' ? 'Home' : 'Away',
      period: S.period,
      shot_x: puckPos.x,
      shot_y: puckPos.y,
      target_x: S.evt.netLocation?.x || '',
      target_y: S.evt.netLocation?.y || '',
      net_location: S.evt.netLocation?.code || '',
      shot_type: document.getElementById('detail1').value,
      shot_result: document.getElementById('detail2').value,
      is_goal: S.evt.type === 'Goal' ? '1' : '0',
      running_video_time: videoTime
    });
  }
  
  // Auto-link: if Shot, prepare for Save
  const et = EVENT_TYPES.find(e => e.key === S.evt.type);
  const prevEventIdx = eventIndex;
  
  clearEventForm();
  
  // Auto-advance to linked event type
  if (et && et.autoLink) {
    setEventType(et.autoLink);
    S.evt.linkedTo = prevEventIdx;
    document.getElementById('linkTo').value = prevEventIdx;
    // Swap team for opponent goalie
    setTeam(S.team === 'home' ? 'away' : 'home');
    S.playerSlotMode = 'opp';
  }
  
  // Decrement clock
  advanceClock(startMin, startSec);
  
  renderEvents();
  updateStats();
  autoSave();
}

function updateEvent() {
  if (S.editingEventIdx === null) return;
  
  // Remove old event rows
  S.events = S.events.filter(e => e.event_index !== S.editingEventIdx);
  
  // Save as new with same index
  const timeS = document.getElementById('timeS').value;
  const timeE = document.getElementById('timeE').value;
  const [startMin, startSec] = parseTime(timeS);
  const [endMin, endSec] = parseTime(timeE);
  const videoTime = calcVideoTime(S.period, startMin, startSec);
  
  const evtPlayers = S.evt.eventPlayers.filter(Boolean);
  const oppPlayers = S.evt.oppPlayers.filter(Boolean);
  const allPlayers = [
    ...evtPlayers.map((p, i) => ({ ...p, role: `event_team_player_${i+1}`, roleNum: i + 1 })),
    ...oppPlayers.map((p, i) => ({ ...p, role: `opp_team_player_${i+1}`, roleNum: i + 1 }))
  ];
  
  if (allPlayers.length === 0) {
    allPlayers.push({ number: '', playerId: '', team: S.team, role: 'event_team_player_1', roleNum: 1 });
  }
  
  allPlayers.forEach((p, i) => {
    S.events.push({
      event_index: S.editingEventIdx,
      event_index_flag_: i === 0 ? 1 : '',
      period: S.period,
      event_start_min_: i === 0 ? startMin : '',
      event_start_sec_: i === 0 ? startSec : '',
      event_end_min_: i === 0 ? endMin : '',
      event_end_sec_: i === 0 ? endSec : '',
      player_game_number_: p.number,
      player_id: p.playerId,
      player_role: p.role,
      role_number: p.roleNum,
      event_team_zone_: S.evt.zone,
      event_type_: S.evt.type,
      event_detail_: document.getElementById('detail1').value,
      event_detail_2_: document.getElementById('detail2').value,
      event_successful_: S.evt.success,
      play_detail1_: document.getElementById('playDetail1').value,
      play_detail2_: document.getElementById('playDetail2').value,
      play_detail_successful_: document.getElementById('playSuccess').value,
      pressured_pressurer_: document.getElementById('pressure').value,
      team_: S.team[0],
      team_venue_: S.team === 'home' ? 'Home' : 'Away',
      linked_event_index_: S.evt.linkedTo || '',
      running_video_time: videoTime,
      shift_index: S.currentShiftIdx,
      game_id: S.gameId,
      xy_x: S.evt.puckXY ? S.evt.puckXY.x : '',
      xy_y: S.evt.puckXY ? S.evt.puckXY.y : '',
      net_location: S.evt.netLocation ? S.evt.netLocation.code : ''
    });
  });
  
  S.editingEventIdx = null;
  document.getElementById('editingLabel').style.display = 'none';
  document.getElementById('saveBtn').style.display = '';
  document.getElementById('updateBtn').style.display = 'none';
  
  clearEventForm();
  renderEvents();
  updateStats();
  autoSave();
}

function advanceClock(min, sec) {
  let newSec = sec > 0 ? sec - 1 : 59;
  let newMin = sec > 0 ? min : min - 1;
  if (newMin >= 0) {
    const t = `${newMin}:${String(newSec).padStart(2, '0')}`;
    document.getElementById('timeS').value = t;
    document.getElementById('timeE').value = t;
    document.getElementById('clockDisplay').textContent = t;
    updateVideoTime();
  }
}

function clearEventForm() {
  S.evt = {
    type: null, detail1: '', detail2: '', playDetail1: '', playDetail2: '', playSuccess: '',
    zone: 'n', success: 's', pressure: '', linkedTo: null,
    eventPlayers: [null, null, null, null, null, null],
    oppPlayers: [null, null, null, null, null, null],
    playerXYPoints: [], puckXYPoints: [], netLocation: null
  };
  
  S.editingEventIdx = null;
  S.playerSlotMode = 'event';
  S.xyMode = 'puck';
  
  document.querySelectorAll('.evt-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('detail1').innerHTML = '<option value="">--</option>';
  document.getElementById('detail2').innerHTML = '<option value="">--</option>';
  document.getElementById('playDetail1').value = '';
  document.getElementById('playDetail2').value = '';
  document.getElementById('playSuccess').value = '';
  document.getElementById('zoneSelect').value = 'n';
  setSuccess('s');
  document.getElementById('pressure').value = '';
  document.getElementById('linkTo').value = '';
  document.getElementById('autoLinkHint').textContent = '';
  document.getElementById('xyMarkers').innerHTML = '';
  document.getElementById('xyText').textContent = 'Click rink';
  document.getElementById('zoneText').textContent = '-';
  document.getElementById('netMarker').innerHTML = '';
  document.getElementById('netInfo').textContent = '-';
  document.getElementById('editingLabel').style.display = 'none';
  document.getElementById('saveBtn').style.display = '';
  document.getElementById('updateBtn').style.display = 'none';
  
  // Clear XY displays
  renderPuckXYPoints();
  renderPlayerXYPoints();
  setXYMode('puck');
  
  renderPlayerSlots();
  renderRoster();
}

function clearAllXY() {
  S.evt.puckXYPoints = [];
  S.evt.playerXYPoints = [];
  renderPuckXYPoints();
  renderPlayerXYPoints();
  renderRinkMarkers();
}

// ============================================================================
// EVENTS LIST
// ============================================================================
function getUniqueEvents() {
  const seen = new Set();
  return S.events.filter(e => {
    if (seen.has(e.event_index)) return false;
    seen.add(e.event_index);
    return true;
  });
}

function renderEvents() {
  const unique = getUniqueEvents();
  document.getElementById('evtCount').textContent = unique.length;
  
  document.getElementById('eventList').innerHTML = unique.map(e => {
    const players = S.events.filter(x => x.event_index === e.event_index)
      .map(x => x.player_game_number_).filter(Boolean).join(',');
    const linked = e.linked_event_index_ ? 'linked' : '';
    const editing = S.editingEventIdx === e.event_index ? 'editing' : '';
    
    return `<div class="event-row ${linked} ${editing}" onclick="selectEvent(${e.event_index})">
      <span class="idx">${e.event_index}</span>
      <span class="time">P${e.period} ${e.event_start_min_}:${String(e.event_start_sec_||0).padStart(2,'0')}</span>
      <span class="type">${e.event_type_}</span>
      <span class="players">#${players || '-'}</span>
      <span class="zone">${e.event_team_zone_ || '-'}</span>
      <span class="del" onclick="event.stopPropagation();deleteEvent(${e.event_index})">√ó</span>
    </div>`;
  }).join('');
  
  // Update link dropdown
  document.getElementById('linkTo').innerHTML = '<option value="">None</option>' + 
    unique.slice(-20).reverse().map(e => `<option value="${e.event_index}">${e.event_index}: ${e.event_type_}</option>`).join('');
}

function selectEvent(idx) {
  // Highlight in list
  document.querySelectorAll('.event-row').forEach(r => r.classList.remove('active'));
  const row = [...document.querySelectorAll('.event-row')].find(r => r.querySelector('.idx').textContent == idx);
  if (row) row.classList.add('active');
}

function editSelectedEvent() {
  const activeRow = document.querySelector('.event-row.active');
  if (!activeRow) { alert('Select an event first'); return; }
  
  const idx = parseInt(activeRow.querySelector('.idx').textContent);
  loadEventForEdit(idx);
}

function loadEventForEdit(idx) {
  const rows = S.events.filter(e => e.event_index === idx);
  if (rows.length === 0) return;
  
  const primary = rows.find(r => r.event_index_flag_ === 1) || rows[0];
  
  S.editingEventIdx = idx;
  document.getElementById('editingLabel').style.display = '';
  document.getElementById('editingIdx').textContent = idx;
  document.getElementById('saveBtn').style.display = 'none';
  document.getElementById('updateBtn').style.display = '';
  
  // Load data into form
  setEventType(primary.event_type_);
  document.getElementById('detail1').value = primary.event_detail_ || '';
  document.getElementById('detail2').value = primary.event_detail_2_ || '';
  document.getElementById('playDetail1').value = primary.play_detail1_ || '';
  document.getElementById('playDetail2').value = primary.play_detail2_ || '';
  document.getElementById('playSuccess').value = primary.play_detail_successful_ || '';
  document.getElementById('zoneSelect').value = primary.event_team_zone_ || 'n';
  setSuccess(primary.event_successful_ || 's');
  document.getElementById('pressure').value = primary.pressured_pressurer_ || '';
  document.getElementById('linkTo').value = primary.linked_event_index_ || '';
  
  S.period = primary.period;
  document.querySelectorAll('.period-btn').forEach((b, i) => b.classList.toggle('active', i + 1 === S.period));
  
  const t = `${primary.event_start_min_ || 0}:${String(primary.event_start_sec_ || 0).padStart(2, '0')}`;
  document.getElementById('timeS').value = t;
  document.getElementById('timeE').value = `${primary.event_end_min_ || 0}:${String(primary.event_end_sec_ || 0).padStart(2, '0')}`;
  document.getElementById('clockDisplay').textContent = t;
  
  // Load players
  S.evt.eventPlayers = [null, null, null, null, null, null];
  S.evt.oppPlayers = [null, null, null, null, null, null];
  
  rows.forEach(r => {
    if (r.player_role && r.player_role.includes('event_team_player_')) {
      const slot = parseInt(r.player_role.replace('event_team_player_', '')) - 1;
      if (slot >= 0 && slot < 6) {
        S.evt.eventPlayers[slot] = { number: r.player_game_number_, playerId: r.player_id, team: r.team_venue_ === 'Home' ? 'home' : 'away' };
      }
    }
    if (r.player_role && r.player_role.includes('opp_team_player_')) {
      const slot = parseInt(r.player_role.replace('opp_team_player_', '')) - 1;
      if (slot >= 0 && slot < 6) {
        S.evt.oppPlayers[slot] = { number: r.player_game_number_, playerId: r.player_id, team: r.team_venue_ === 'Home' ? 'away' : 'home' };
      }
    }
  });
  
  renderPlayerSlots();
  renderEvents();
}

function deleteEvent(idx) {
  if (!confirm(`Delete event #${idx}?`)) return;
  S.events = S.events.filter(e => e.event_index !== idx);
  renderEvents();
  updateStats();
  autoSave();
}

function scrollToLatest() {
  const list = document.getElementById('eventList');
  list.scrollTop = list.scrollHeight;
}

// ============================================================================
// SHIFTS
// ============================================================================
function newShift() {
  endCurrentShift();
  
  S.currentShiftIdx++;
  document.getElementById('shiftNum').textContent = S.currentShiftIdx;
  document.getElementById('shiftStart').value = document.getElementById('timeS').value;
  document.getElementById('shiftEnd').value = '';
  document.getElementById('shiftType').value = 'OtherFaceoff';
  
  updateStats();
  autoSave();
}

function endCurrentShift() {
  const [startMin, startSec] = parseTime(document.getElementById('shiftStart').value);
  const [endMin, endSec] = parseTime(document.getElementById('shiftEnd').value || document.getElementById('timeS').value);
  
  const shift = {
    shift_index: S.currentShiftIdx,
    Period: S.period,
    shift_start_min: startMin,
    shift_start_sec: startSec,
    shift_end_min: endMin,
    shift_end_sec: endSec,
    shift_start_type: document.getElementById('shiftType').value,
    home_forward_1: S.onIce.home.F1,
    home_forward_2: S.onIce.home.F2,
    home_forward_3: S.onIce.home.F3,
    home_defense_1: S.onIce.home.D1,
    home_defense_2: S.onIce.home.D2,
    home_goalie: S.onIce.home.G,
    away_forward_1: S.onIce.away.F1,
    away_forward_2: S.onIce.away.F2,
    away_forward_3: S.onIce.away.F3,
    away_defense_1: S.onIce.away.D1,
    away_defense_2: S.onIce.away.D2,
    away_goalie: S.onIce.away.G,
    game_id: S.gameId
  };
  
  // Update or add
  const existing = S.shifts.findIndex(s => s.shift_index === S.currentShiftIdx);
  if (existing >= 0) S.shifts[existing] = shift;
  else S.shifts.push(shift);
}

function showShiftEditor() {
  let html = '<h3>Edit Shifts</h3><div style="max-height:400px;overflow-y:auto">';
  html += '<table style="width:100%;font-size:10px;border-collapse:collapse">';
  html += '<tr><th>Shift</th><th>Period</th><th>Start</th><th>End</th><th>Type</th><th></th></tr>';
  
  S.shifts.forEach((s, i) => {
    html += `<tr style="border-bottom:1px solid var(--border)">
      <td>${s.shift_index}</td>
      <td>${s.Period}</td>
      <td>${s.shift_start_min}:${String(s.shift_start_sec||0).padStart(2,'0')}</td>
      <td>${s.shift_end_min}:${String(s.shift_end_sec||0).padStart(2,'0')}</td>
      <td>${s.shift_start_type || '-'}</td>
      <td><button onclick="deleteShift(${i})" style="font-size:9px">√ó</button></td>
    </tr>`;
  });
  
  html += '</table></div>';
  html += '<div class="modal-actions"><button onclick="hideModal()">Close</button></div>';
  
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalBg').classList.add('show');
}

function deleteShift(idx) {
  if (confirm('Delete shift?')) {
    S.shifts.splice(idx, 1);
    showShiftEditor();
    updateStats();
    autoSave();
  }
}

// ============================================================================
// STATS
// ============================================================================
function updateStats() {
  const unique = getUniqueEvents();
  const goals = S.events.filter(e => e.event_type_ === 'Goal' && e.event_index_flag_ === 1);
  
  document.getElementById('statHomeG').textContent = goals.filter(e => e.team_venue_ === 'Home').length;
  document.getElementById('statAwayG').textContent = goals.filter(e => e.team_venue_ === 'Away').length;
  document.getElementById('statShots').textContent = unique.filter(e => ['Shot','Goal'].includes(e.event_type_)).length;
  document.getElementById('statPasses').textContent = unique.filter(e => e.event_type_ === 'Pass').length;
  document.getElementById('statShifts').textContent = S.shifts.length;
  document.getElementById('statEvents').textContent = unique.length;
}

// ============================================================================
// LOCAL SAVE / EXPORT
// ============================================================================
function autoSave() {
  if (S.gameId) saveLocal();
}

function saveLocal() {
  if (!S.gameId) return;
  const data = {
    gameId: S.gameId, game: S.game, events: S.events, shifts: S.shifts,
    onIce: S.onIce, roster: S.roster, currentShiftIdx: S.currentShiftIdx,
    period: S.period, videoOffset: S.videoOffset
  };
  localStorage.setItem('bst_game_' + S.gameId, JSON.stringify(data));
  updateStatus('Saved ' + new Date().toLocaleTimeString());
}

function loadLocalState() {
  if (!S.gameId) return;
  const saved = localStorage.getItem('bst_game_' + S.gameId);
  if (saved) {
    try {
      const data = JSON.parse(saved);
      if (data.events && data.events.length > S.events.length) {
        // Local has more data
        S.events = data.events;
        S.shifts = data.shifts || [];
        S.currentShiftIdx = data.currentShiftIdx || 1;
      }
      if (data.onIce) S.onIce = data.onIce;
      if (data.roster) S.roster = data.roster;
      S.videoOffset = data.videoOffset || 0;
    } catch (e) {
      console.error('Error loading local state:', e);
    }
  }
}

async function pushToSupabase() {
  if (!S.gameId) { alert('No game loaded'); return; }
  
  showLoading('Pushing to Supabase...');
  
  try {
    // Push events (convert to fact_events format)
    const uniqueEvents = getUniqueEvents();
    const factEvents = uniqueEvents.map(e => ({
      event_key: `EVT_${S.gameId}_${e.event_index}`,
      game_id: S.gameId,
      event_index: e.event_index,
      period: e.period,
      event_type: e.event_type_,
      event_detail: e.event_detail_,
      event_detail_2: e.event_detail_2_,
      event_successful: e.event_successful_,
      play_detail1: e.play_detail1_,
      play_detail2: e.play_detail2_,
      play_detail_successful: e.play_detail_successful_,
      zone: e.event_team_zone_,
      running_video_time: e.running_video_time,
      linked_event_index: e.linked_event_index_ || null,
      team_venue: e.team_venue_,
      shift_index: e.shift_index,
      x_coord: e.xy_x || null,
      y_coord: e.xy_y || null,
      net_location: e.net_location || null
    }));
    
    await sbUpsert('fact_events', factEvents);
    
    // Push event players
    const eventPlayers = S.events.filter(e => e.player_game_number_).map(e => ({
      event_player_key: `EP_${S.gameId}_${e.event_index}_${e.role_number || 1}`,
      event_key: `EVT_${S.gameId}_${e.event_index}`,
      game_id: S.gameId,
      event_index: e.event_index,
      player_id: e.player_id,
      player_game_number: e.player_game_number_,
      player_role: e.player_role,
      role_number: e.role_number,
      team_venue: e.team_venue_
    }));
    
    if (eventPlayers.length > 0) {
      await sbUpsert('fact_events_player', eventPlayers);
    }
    
    // Push shifts
    const factShifts = S.shifts.map(s => ({
      shift_key: `SHF_${S.gameId}_${s.shift_index}`,
      game_id: S.gameId,
      shift_index: s.shift_index,
      period: s.Period,
      shift_start_min: s.shift_start_min,
      shift_start_sec: s.shift_start_sec,
      shift_end_min: s.shift_end_min,
      shift_end_sec: s.shift_end_sec,
      shift_start_type: s.shift_start_type,
      home_forward_1: s.home_forward_1,
      home_forward_2: s.home_forward_2,
      home_forward_3: s.home_forward_3,
      home_defense_1: s.home_defense_1,
      home_defense_2: s.home_defense_2,
      home_goalie: s.home_goalie,
      away_forward_1: s.away_forward_1,
      away_forward_2: s.away_forward_2,
      away_forward_3: s.away_forward_3,
      away_defense_1: s.away_defense_1,
      away_defense_2: s.away_defense_2,
      away_goalie: s.away_goalie
    }));
    
    if (factShifts.length > 0) {
      await sbUpsert('fact_shifts', factShifts);
    }
    
    // Push puck XY data (long format)
    const puckXYLong = [];
    S.puckXYData.forEach(evt => {
      evt.points.forEach((pt, i) => {
        puckXYLong.push({
          puck_xy_key: `PXY_${S.gameId}_${evt.event_index}_${i + 1}`,
          game_id: S.gameId,
          event_index: evt.event_index,
          event_key: `EVT_${S.gameId}_${evt.event_index}`,
          point_number: i + 1,
          x: pt.x,
          y: pt.y,
          z: pt.z || 0,
          event_timestamp: pt.timestamp
        });
      });
    });
    
    if (puckXYLong.length > 0) {
      await sbUpsert('fact_puck_xy_long', puckXYLong);
    }
    
    // Push puck XY wide format
    const puckXYWide = S.puckXYData.map(evt => {
      const row = {
        puck_xy_key: `PXYW_${S.gameId}_${evt.event_index}`,
        game_id: S.gameId,
        event_index: evt.event_index,
        event_key: `EVT_${S.gameId}_${evt.event_index}`,
        point_count: evt.points.length
      };
      for (let i = 0; i < 10; i++) {
        if (i < evt.points.length) {
          row[`x_${i + 1}`] = evt.points[i].x;
          row[`y_${i + 1}`] = evt.points[i].y;
          row[`z_${i + 1}`] = evt.points[i].z || 0;
          row[`timestamp_${i + 1}`] = evt.points[i].timestamp;
        }
      }
      return row;
    });
    
    if (puckXYWide.length > 0) {
      await sbUpsert('fact_puck_xy_wide', puckXYWide);
    }
    
    // Push player XY data (long format)
    const playerXYLong = [];
    S.playerXYData.forEach(entry => {
      entry.points.forEach((pt, i) => {
        playerXYLong.push({
          player_xy_key: `PLXY_${S.gameId}_${entry.event_index}_${entry.player_id}_${i + 1}`,
          game_id: S.gameId,
          event_index: entry.event_index,
          event_key: `EVT_${S.gameId}_${entry.event_index}`,
          player_id: entry.player_id,
          team_venue: entry.team_venue,
          point_number: i + 1,
          x: pt.x,
          y: pt.y,
          event_timestamp: pt.timestamp
        });
      });
    });
    
    if (playerXYLong.length > 0) {
      await sbUpsert('fact_player_xy_long', playerXYLong);
    }
    
    // Push shot XY data
    const shotXY = S.shotXYData.map(s => ({
      shot_xy_key: `SHOTXY_${S.gameId}_${s.event_index}`,
      game_id: S.gameId,
      event_index: s.event_index,
      event_key: `EVT_${S.gameId}_${s.event_index}`,
      player_id: s.player_id,
      team_venue: s.team_venue,
      period: s.period,
      shot_x: s.shot_x,
      shot_y: s.shot_y,
      target_x: s.target_x,
      target_y: s.target_y,
      net_location_id: s.net_location,
      shot_type: s.shot_type,
      shot_result: s.shot_result,
      is_goal: s.is_goal,
      running_video_time: s.running_video_time
    }));
    
    if (shotXY.length > 0) {
      await sbUpsert('fact_shot_xy', shotXY);
    }
    
    hideLoading();
    updateStatus(`Pushed: ${factEvents.length} events, ${factShifts.length} shifts, ${puckXYLong.length} puck XY`);
    
    
  } catch (err) {
    hideLoading();
    alert('Error pushing to Supabase: ' + err.message);
  }
}

async function syncFromSupabase() {
  if (!S.gameId) { alert('Select a game first'); return; }
  await loadGameFromSupabase();
}

function exportXLSX() {
  if (!S.gameId) { alert('No game to export'); return; }
  
  // Events sheet (matching your exact format)
  const eventsData = S.events.map(e => ({
    event_index_flag_: e.event_index_flag_,
    sequence_index_flag_: '',
    play_index_flag_: '',
    linked_event_index_flag_: e.linked_event_index_ ? 1 : '',
    event_start_min_: e.event_start_min_,
    event_start_sec_: e.event_start_sec_,
    event_end_min_: e.event_end_min_,
    event_end_sec_: e.event_end_sec_,
    player_game_number_: e.player_game_number_,
    event_team_zone_: e.event_team_zone_,
    event_type_: e.event_type_,
    event_detail_: e.event_detail_,
    event_detail_2_: e.event_detail_2_,
    event_successful_: e.event_successful_,
    play_detail1_: e.play_detail1_,
    play_detail2_: e.play_detail2_,
    play_detail_successful_: e.play_detail_successful_,
    pressured_pressurer_: e.pressured_pressurer_,
    event_index_: e.event_index,
    linked_event_index_: e.linked_event_index_,
    team_: e.team_,
    period: e.period,
    running_video_time: e.running_video_time,
    shift_index: e.shift_index,
    role_number: e.role_number,
    player_role: e.player_role,
    player_id: e.player_id,
    xy_x: e.xy_x,
    xy_y: e.xy_y,
    net_location: e.net_location
  }));
  
  // Shifts sheet
  const shiftsData = S.shifts.map(s => ({
    shift_index: s.shift_index,
    Period: s.Period,
    shift_start_min: s.shift_start_min,
    shift_start_sec: s.shift_start_sec,
    shift_end_min: s.shift_end_min,
    shift_end_sec: s.shift_end_sec,
    shift_start_type: s.shift_start_type,
    home_forward_1: s.home_forward_1,
    home_forward_2: s.home_forward_2,
    home_forward_3: s.home_forward_3,
    home_defense_1: s.home_defense_1,
    home_defense_2: s.home_defense_2,
    home_goalie: s.home_goalie,
    away_forward_1: s.away_forward_1,
    away_forward_2: s.away_forward_2,
    away_forward_3: s.away_forward_3,
    away_defense_1: s.away_defense_1,
    away_defense_2: s.away_defense_2,
    away_goalie: s.away_goalie,
    game_id: s.game_id
  }));
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(eventsData), 'events');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shiftsData), 'shifts');
  XLSX.writeFile(wb, `${S.gameId}_tracking.xlsx`);
  
  updateStatus('Exported!');
}

// ============================================================================
// NEW GAME MODAL
// ============================================================================
function showNewGameModal() {
  let html = '<h3>Create New Game</h3>';
  html += '<div class="modal-row"><label>Game ID</label><input type="text" id="newGameId" placeholder="e.g. 19050"></div>';
  html += '<div class="modal-row"><label>Home Team</label><input type="text" id="newHomeTeam" placeholder="Home Team Name"></div>';
  html += '<div class="modal-row"><label>Away Team</label><input type="text" id="newAwayTeam" placeholder="Away Team Name"></div>';
  html += '<div class="modal-row"><label>Home Roster</label><input type="text" id="newHomeRoster" placeholder="1,2,3,4,5,6... (jersey numbers)"></div>';
  html += '<div class="modal-row"><label>Away Roster</label><input type="text" id="newAwayRoster" placeholder="11,12,13,14,15..."></div>';
  html += '<div class="modal-actions"><button onclick="createNewGame()" class="btn-green">Create</button><button onclick="hideModal()">Cancel</button></div>';
  
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalBg').classList.add('show');
}

function createNewGame() {
  const gid = document.getElementById('newGameId').value.trim();
  if (!gid) { alert('Enter game ID'); return; }
  
  S.gameId = gid;
  S.game = {
    game_id: gid,
    home_team_name: document.getElementById('newHomeTeam').value || 'Home',
    away_team_name: document.getElementById('newAwayTeam').value || 'Away'
  };
  
  S.events = [];
  S.shifts = [];
  S.currentShiftIdx = 1;
  S.onIce = { home: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null}, away: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null} };
  
  // Parse rosters
  const homeNums = document.getElementById('newHomeRoster').value.split(',').map(n => parseInt(n.trim())).filter(n => n);
  const awayNums = document.getElementById('newAwayRoster').value.split(',').map(n => parseInt(n.trim())).filter(n => n);
  
  S.roster.home = homeNums.map(n => ({ number: n, playerId: '', name: '' }));
  S.roster.away = awayNums.map(n => ({ number: n, playerId: '', name: '' }));
  
  hideModal();
  renderAll();
  saveLocal();
  
  // Add to dropdown
  const opt = document.createElement('option');
  opt.value = gid;
  opt.textContent = gid + ' (new)';
  document.getElementById('gameSelect').appendChild(opt);
  document.getElementById('gameSelect').value = gid;
}

// ============================================================================
// RENDER ALL
// ============================================================================
function renderAll() {
  renderOnIce();
  renderRoster();
  renderPlayerSlots();
  renderEvents();
  updateStats();
  document.getElementById('shiftNum').textContent = S.currentShiftIdx;
}

// ============================================================================
// UTILITIES
// ============================================================================
function showLoading(msg) {
  document.getElementById('loadingText').textContent = msg || 'Loading...';
  document.getElementById('loading').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loading').classList.add('hidden');
}

function showModal() {
  document.getElementById('modalBg').classList.add('show');
}

function hideModal() {
  document.getElementById('modalBg').classList.remove('show');
}

function updateStatus(msg) {
  document.getElementById('status').textContent = msg;
}

// ============================================================================
// START
// ============================================================================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

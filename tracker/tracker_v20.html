<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BenchSight Game Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #0a0e14; --card: #12171d; --border: #1e2630; --text: #d4d4d4;
  --muted: #6b7280; --accent: #3b82f6; --home: #22c55e; --away: #ef4444;
  --success: #22c55e; --fail: #ef4444; --warn: #f59e0b; --input: #1a1f26;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); font-size: 12px; height: 100vh; overflow: hidden; }

.app { display: grid; grid-template-rows: 44px 1fr; height: 100vh; }

/* Header */
header { display: flex; align-items: center; gap: 8px; padding: 0 12px; background: var(--card); border-bottom: 1px solid var(--border); }
header h1 { font-size: 14px; color: var(--accent); margin-right: 8px; }
header select, header input, header button { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 4px; font-size: 11px; }
header button { cursor: pointer; } header button:hover { background: var(--border); }
.btn-green { background: var(--success) !important; color: #000 !important; }
.btn-yellow { background: var(--warn) !important; color: #000 !important; }
.spacer { flex: 1; }
#status { font-size: 10px; color: var(--muted); }

/* Main Grid */
.main { display: grid; grid-template-columns: 200px 1fr 260px; gap: 6px; padding: 6px; overflow: hidden; }
.panel { background: var(--card); border-radius: 6px; padding: 8px; display: flex; flex-direction: column; overflow: hidden; }
.panel h3 { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }

/* Left - Roster/Shifts */
.left { display: flex; flex-direction: column; gap: 6px; }
.team-toggle { display: flex; gap: 4px; }
.team-btn { flex: 1; padding: 6px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 10px; opacity: 0.5; }
.team-btn.home { background: var(--home); color: #000; }
.team-btn.away { background: var(--away); color: #fff; }
.team-btn.active { opacity: 1; box-shadow: 0 0 0 2px #fff; }

.period-row { display: flex; gap: 3px; margin-top: 6px; }
.period-btn { flex: 1; padding: 5px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; font-size: 10px; text-align: center; }
.period-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.slot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; margin: 6px 0; }
.slot { background: var(--input); border: 2px solid var(--border); border-radius: 4px; padding: 4px; text-align: center; cursor: pointer; min-height: 40px; }
.slot:hover { border-color: var(--accent); }
.slot.active { border-color: var(--accent); background: #1e3a5f; }
.slot.filled { border-color: var(--success); }
.slot .lbl { font-size: 8px; color: var(--muted); }
.slot .num { font-size: 14px; font-weight: 700; color: var(--accent); }

.roster { flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 3px; align-content: flex-start; padding: 4px 0; }
.player { display: inline-flex; align-items: center; gap: 3px; padding: 3px 6px; background: var(--input); border: 1px solid var(--border); border-radius: 3px; font-size: 9px; cursor: pointer; }
.player:hover { border-color: var(--accent); }
.player.on-ice { background: var(--success); color: #000; border-color: var(--success); }
.player.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
.player .n { font-weight: 700; }

/* Center - Video/Rink/Events */
.center { display: flex; flex-direction: column; gap: 6px; }

.video-box { background: #000; border-radius: 6px; height: 180px; position: relative; }
.video-box iframe { width: 100%; height: 100%; border: none; border-radius: 6px; }
.video-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted); flex-direction: column; gap: 4px; }
.video-controls { display: flex; gap: 6px; margin-top: 4px; }
.video-controls input { flex: 1; padding: 6px; background: var(--input); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 11px; }
.video-controls button { padding: 6px 12px; }

.clock-row { display: flex; gap: 8px; align-items: center; padding: 8px; background: var(--input); border-radius: 6px; }
.clock-big { font-family: 'SF Mono', Monaco, monospace; font-size: 28px; font-weight: 700; color: var(--accent); }
.time-input { display: flex; flex-direction: column; gap: 2px; }
.time-input label { font-size: 8px; color: var(--muted); }
.time-input input { width: 60px; padding: 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; color: var(--text); font-family: monospace; font-size: 12px; text-align: center; }
.video-time { font-family: monospace; font-size: 11px; color: var(--warn); }

.rink-box { flex: 0 0 160px; display: flex; flex-direction: column; align-items: center; background: var(--input); border-radius: 6px; padding: 6px; }
.rink-svg { width: 100%; max-width: 280px; cursor: crosshair; }
.xy-display { font-size: 10px; color: var(--muted); margin-top: 4px; }

.events-panel { flex: 1; min-height: 0; }
.events-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.event-list { flex: 1; overflow-y: auto; font-size: 10px; }
.event-row { display: grid; grid-template-columns: 35px 50px 70px 1fr 50px 25px; gap: 4px; padding: 4px 2px; border-bottom: 1px solid var(--border); cursor: pointer; align-items: center; }
.event-row:hover { background: var(--input); }
.event-row.active { background: var(--accent); color: #fff; }
.event-row.linked { border-left: 3px solid var(--warn); }
.event-row .idx { font-family: monospace; color: var(--muted); font-weight: 600; }
.event-row .time { font-family: monospace; font-size: 9px; }
.event-row .type { font-weight: 600; }
.event-row .players { color: var(--muted); font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.event-row .zone { font-size: 9px; }
.event-row .del { color: var(--fail); cursor: pointer; opacity: 0.5; }
.event-row .del:hover { opacity: 1; }

.stats-row { display: flex; gap: 12px; padding: 6px 8px; background: var(--input); border-radius: 4px; font-size: 10px; }
.stat { display: flex; gap: 4px; }
.stat .l { color: var(--muted); }
.stat .v { font-weight: 600; color: var(--accent); }

/* Right - Event Entry */
.right { display: flex; flex-direction: column; gap: 6px; }

.evt-types { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; }
.evt-btn { padding: 8px 2px; display: flex; flex-direction: column; align-items: center; gap: 1px; background: var(--input); border: 2px solid var(--border); border-radius: 4px; cursor: pointer; transition: all 0.1s; }
.evt-btn:hover { border-color: var(--accent); }
.evt-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.evt-btn span { font-size: 9px; font-weight: 600; }
.evt-btn kbd { font-size: 7px; color: var(--muted); background: var(--bg); padding: 1px 3px; border-radius: 2px; }
.evt-btn.active kbd { color: #fff; background: rgba(255,255,255,0.2); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
.form-row.tri { grid-template-columns: 1fr 1fr 1fr; }
.form-group { display: flex; flex-direction: column; gap: 2px; }
.form-group label { font-size: 9px; color: var(--muted); text-transform: uppercase; }
.form-group select, .form-group input { background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 6px; border-radius: 4px; font-size: 11px; }

.success-row { display: flex; gap: 4px; }
.suc-btn { flex: 1; padding: 8px; border: 2px solid var(--border); border-radius: 4px; background: var(--input); cursor: pointer; font-weight: 600; font-size: 11px; text-align: center; }
.suc-btn.s.active { background: var(--success); color: #000; border-color: var(--success); }
.suc-btn.u.active { background: var(--fail); color: #fff; border-color: var(--fail); }

.link-row { display: flex; gap: 4px; align-items: center; padding: 6px; background: var(--input); border-radius: 4px; margin-top: 6px; }
.link-row label { font-size: 9px; color: var(--muted); }
.link-row select { flex: 1; }

.players-section { margin-top: 6px; }
.players-section h4 { font-size: 9px; color: var(--muted); margin-bottom: 4px; }
.selected-players { min-height: 28px; padding: 4px; background: var(--input); border-radius: 4px; display: flex; flex-wrap: wrap; gap: 3px; }
.sel-player { display: inline-flex; align-items: center; gap: 3px; padding: 3px 6px; background: var(--accent); color: #fff; border-radius: 3px; font-size: 9px; }
.sel-player .role { font-size: 7px; background: rgba(255,255,255,0.2); padding: 1px 3px; border-radius: 2px; }
.sel-player .x { cursor: pointer; opacity: 0.7; }
.sel-player .x:hover { opacity: 1; }

.action-row { display: flex; gap: 6px; margin-top: auto; padding-top: 8px; }
.action-row button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }
.action-row .save { background: var(--success); color: #000; }
.action-row .clear { background: var(--input); color: var(--text); border: 1px solid var(--border); }

/* Shift Entry Panel */
.shift-panel { margin-top: 6px; padding: 8px; background: var(--input); border-radius: 4px; }
.shift-panel h4 { font-size: 9px; color: var(--muted); margin-bottom: 4px; }
.shift-row { display: flex; gap: 4px; align-items: center; }
.shift-row input { width: 50px; }
.shift-row select { flex: 1; }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
.modal-bg.show { display: flex; }
.modal { background: var(--card); border-radius: 8px; padding: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal h3 { margin-bottom: 12px; }
.modal-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end; }

/* Keyboard hint */
.kb-hint { position: fixed; bottom: 6px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 4px 12px; border-radius: 4px; font-size: 9px; color: var(--muted); border: 1px solid var(--border); }
.kb-hint kbd { background: var(--input); padding: 1px 4px; border-radius: 2px; margin: 0 2px; }
</style>
</head>
<body>
<div class="app">
<header>
  <h1>üèí BenchSight</h1>
  <select id="gameSelect"><option value="">-- Select Game --</option></select>
  <button onclick="newGame()" class="btn-green">+ New</button>
  <span class="spacer"></span>
  <span id="status">Ready</span>
  <button onclick="saveLocal()">üíæ Save</button>
  <button onclick="exportXLSX()" class="btn-yellow">üì• Export</button>
</header>

<div class="main">
<!-- LEFT: Roster & Shifts -->
<div class="left">
  <div class="panel">
    <div class="team-toggle">
      <button class="team-btn home active" onclick="setTeam('home')">HOME</button>
      <button class="team-btn away" onclick="setTeam('away')">AWAY</button>
    </div>
    <div class="period-row">
      <button class="period-btn active" onclick="setPeriod(1)">P1</button>
      <button class="period-btn" onclick="setPeriod(2)">P2</button>
      <button class="period-btn" onclick="setPeriod(3)">P3</button>
      <button class="period-btn" onclick="setPeriod(4)">OT</button>
    </div>
  </div>
  
  <div class="panel" style="flex:1">
    <h3>On Ice (<span id="iceTeam">Home</span>)</h3>
    <div class="slot-grid" id="slots"></div>
    <button onclick="newShift()" style="width:100%;padding:6px;margin-bottom:6px" class="btn-green">+ New Shift</button>
    <h3>Roster</h3>
    <div class="roster" id="roster"></div>
  </div>
</div>

<!-- CENTER: Video, Rink, Events -->
<div class="center">
  <div class="panel">
    <div class="video-box" id="videoBox">
      <div class="video-placeholder"><span>üìπ Paste YouTube URL</span></div>
    </div>
    <div class="video-controls">
      <input type="text" id="videoUrl" placeholder="YouTube URL...">
      <button onclick="loadVideo()">Load</button>
      <button onclick="captureTime()" title="Get current video time">‚è±Ô∏è Capture</button>
    </div>
  </div>
  
  <div class="panel">
    <div class="clock-row">
      <div class="clock-big" id="clock">20:00</div>
      <div class="time-input"><label>Start</label><input type="text" id="timeS" value="20:00" onchange="syncClock()"></div>
      <div class="time-input"><label>End</label><input type="text" id="timeE" value="20:00"></div>
      <button onclick="copyStartToEnd()">‚¨áÔ∏è</button>
      <div class="video-time">Video: <span id="videoTime">0s</span></div>
    </div>
  </div>
  
  <div class="panel rink-box">
    <svg class="rink-svg" viewBox="0 0 200 85" onclick="clickRink(event)">
      <rect x="0" y="0" width="200" height="85" fill="#fff" stroke="#333" stroke-width="1" rx="15"/>
      <line x1="100" y1="0" x2="100" y2="85" stroke="#c00" stroke-width="2"/>
      <line x1="25" y1="0" x2="25" y2="85" stroke="#00c" stroke-width="1"/>
      <line x1="175" y1="0" x2="175" y2="85" stroke="#00c" stroke-width="1"/>
      <circle cx="100" cy="42.5" r="15" fill="none" stroke="#00c" stroke-width="1"/>
      <circle cx="100" cy="42.5" r="2" fill="#00c"/>
      <circle cx="31" cy="20.5" r="15" fill="none" stroke="#c00"/>
      <circle cx="31" cy="64.5" r="15" fill="none" stroke="#c00"/>
      <circle cx="169" cy="20.5" r="15" fill="none" stroke="#c00"/>
      <circle cx="169" cy="64.5" r="15" fill="none" stroke="#c00"/>
      <rect x="0" y="35.5" width="4" height="14" fill="#c00"/>
      <rect x="196" y="35.5" width="4" height="14" fill="#c00"/>
      <g id="xyMarker"></g>
    </svg>
    <div class="xy-display">XY: <span id="xyText">Click rink</span></div>
  </div>
  
  <div class="panel events-panel">
    <div class="events-header">
      <h3>Events (<span id="evtCount">0</span>)</h3>
      <button onclick="scrollEvents()" style="font-size:9px;padding:3px 6px">‚¨áÔ∏è Latest</button>
    </div>
    <div class="event-list" id="eventList"></div>
  </div>
  
  <div class="stats-row">
    <div class="stat"><span class="l">Home:</span><span class="v" id="homeG">0</span></div>
    <div class="stat"><span class="l">Away:</span><span class="v" id="awayG">0</span></div>
    <div class="stat"><span class="l">Shots:</span><span class="v" id="shots">0</span></div>
    <div class="stat"><span class="l">Shifts:</span><span class="v" id="shiftCt">0</span></div>
  </div>
</div>

<!-- RIGHT: Event Entry -->
<div class="right">
  <div class="panel" style="flex:1">
    <h3>Event</h3>
    <div class="evt-types">
      <button class="evt-btn" data-t="Faceoff" onclick="setType('Faceoff')"><span>Faceoff</span><kbd>F</kbd></button>
      <button class="evt-btn" data-t="Shot" onclick="setType('Shot')"><span>Shot</span><kbd>S</kbd></button>
      <button class="evt-btn" data-t="Goal" onclick="setType('Goal')"><span>Goal</span><kbd>G</kbd></button>
      <button class="evt-btn" data-t="Save" onclick="setType('Save')"><span>Save</span><kbd>V</kbd></button>
      <button class="evt-btn" data-t="Pass" onclick="setType('Pass')"><span>Pass</span><kbd>P</kbd></button>
      <button class="evt-btn" data-t="Turnover" onclick="setType('Turnover')"><span>Turn</span><kbd>T</kbd></button>
      <button class="evt-btn" data-t="Zone_Entry" onclick="setType('Zone_Entry')"><span>Entry</span><kbd>Z</kbd></button>
      <button class="evt-btn" data-t="Zone_Exit" onclick="setType('Zone_Exit')"><span>Exit</span><kbd>X</kbd></button>
      <button class="evt-btn" data-t="Hit" onclick="setType('Hit')"><span>Hit</span><kbd>H</kbd></button>
      <button class="evt-btn" data-t="Block" onclick="setType('Block')"><span>Block</span><kbd>B</kbd></button>
      <button class="evt-btn" data-t="Retrieval" onclick="setType('Retrieval')"><span>Retrieval</span><kbd>R</kbd></button>
      <button class="evt-btn" data-t="Stoppage" onclick="setType('Stoppage')"><span>Stop</span><kbd>W</kbd></button>
    </div>
    
    <div class="form-row">
      <div class="form-group"><label>Detail 1</label><select id="d1"></select></div>
      <div class="form-group"><label>Detail 2</label><select id="d2"></select></div>
    </div>
    
    <div class="form-row tri">
      <div class="form-group"><label>Zone</label>
        <select id="zone">
          <option value="n">Neutral</option>
          <option value="o">Offensive</option>
          <option value="d">Defensive</option>
        </select>
      </div>
      <div class="form-group"><label>Success</label>
        <div class="success-row">
          <button class="suc-btn s active" onclick="setSuccess('s')">‚úì</button>
          <button class="suc-btn u" onclick="setSuccess('u')">‚úó</button>
        </div>
      </div>
      <div class="form-group"><label>Pressure</label>
        <select id="pressure"><option value="">-</option><option value="1">Yes</option><option value="0">No</option></select>
      </div>
    </div>
    
    <div class="link-row">
      <label>Link:</label>
      <select id="linkTo"><option value="">None</option></select>
      <button onclick="linkPrev()" title="Link to previous">‚¨ÜÔ∏è</button>
    </div>
    
    <div class="players-section">
      <h4>Players (click roster/ice slots)</h4>
      <div class="selected-players" id="selPlayers"><span style="color:var(--muted)">None</span></div>
    </div>
    
    <div class="action-row">
      <button class="clear" onclick="clearEvt()">Clear</button>
      <button class="save" onclick="saveEvt()">Save (Enter)</button>
    </div>
  </div>
  
  <div class="panel shift-panel">
    <h4>Current Shift #<span id="shiftNum">1</span></h4>
    <div class="shift-row">
      <input type="text" id="shiftStart" placeholder="Start" value="20:00">
      <span>‚Üí</span>
      <input type="text" id="shiftEnd" placeholder="End">
      <select id="shiftType">
        <option value="GameStart">Game Start</option>
        <option value="OtherFaceoff">Faceoff</option>
        <option value="Icing">Icing</option>
        <option value="Offside">Offside</option>
        <option value="Penalty">Penalty</option>
        <option value="Goal">Goal</option>
        <option value="">Other</option>
      </select>
    </div>
  </div>
</div>
</div>
</div>

<div class="kb-hint">
  <kbd>F</kbd>aceoff <kbd>S</kbd>hot <kbd>G</kbd>oal <kbd>V</kbd>Save <kbd>P</kbd>ass <kbd>T</kbd>urn <kbd>Z</kbd>Entry <kbd>X</kbd>Exit <kbd>H</kbd>it <kbd>B</kbd>lock | <kbd>Enter</kbd>=Save | <kbd>Space</kbd>=Success | <kbd>1-4</kbd>=Period
</div>

<div class="modal-bg" id="modal"><div class="modal" id="modalContent"></div></div>

<script>
// ============================================================================
// STATE
// ============================================================================
const S = {
  gameId: null,
  game: null,
  period: 1,
  team: 'home',
  events: [],
  shifts: [],
  currentShift: 1,
  onIce: { home: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null}, away: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null} },
  roster: { home: [], away: [] },
  selectedSlot: null,
  evt: { type: null, d1: '', d2: '', zone: 'n', success: 's', link: null, players: [], xy: null, pressure: '' },
  videoStart: 0, // seconds offset for period 1 start
  ytPlayer: null
};

// Detail options per event type
const DETAILS = {
  Faceoff: { d1: ['Faceoff_GameStart','Faceoff_AfterGoal','Faceoff_AfterIcing','Faceoff_AfterOffside','Faceoff_AfterPenalty','Faceoff_AfterStoppage'], d2: [] },
  Shot: { d1: ['Shot_Wrist','Shot_Slap','Shot_Snap','Shot_Backhand','Shot_Tip','Shot_Deflection','Shot_Wrap'], d2: ['Shot-OnNet','Shot-Blocked','Shot-Missed','Shot-Post','Shot Goal'] },
  Goal: { d1: ['Goal_EvenStrength','Goal_PowerPlay','Goal_ShortHanded','Goal_EmptyNet'], d2: ['Goal Scored'] },
  Save: { d1: ['Save_Glove','Save_Blocker','Save_Pad','Save_Body','Save_Stick'], d2: ['Save-Rebound','Save-Freeze','Save-Cover'] },
  Pass: { d1: ['Pass_Completed','Pass_Incomplete','Pass_Intercepted'], d2: ['Pass-Forehand','Pass-Backhand','Pass-Saucer','Pass-Bank','Pass-Chip','Pass-Drop'] },
  Turnover: { d1: ['Turnover_Giveaway','Turnover_Takeaway','Turnover_LostBattle'], d2: ['Giveaway-BadPass','Giveaway-LostPuck','Takeaway-Stick','Takeaway-Body'] },
  Zone_Entry: { d1: ['ZoneEntry-Carry','ZoneEntry-Pass','ZoneEntry-DumpIn','ZoneEntry-DumpChase'], d2: ['Entry-Controlled','Entry-Uncontrolled'] },
  Zone_Exit: { d1: ['ZoneExit-Carry','ZoneExit-Pass','ZoneExit-Clear','ZoneExit-Dump'], d2: ['Exit-Clean','Exit-Pressured'] },
  Hit: { d1: ['Hit_Body','Hit_Stick','Hit_Board'], d2: ['Hit-Clean','Hit-Penalty'] },
  Block: { d1: ['Block_Shot','Block_Pass'], d2: [] },
  Retrieval: { d1: ['Retrieval_Board','Retrieval_Corner','Retrieval_Slot','Retrieval_Rebound'], d2: [] },
  Stoppage: { d1: ['Stoppage_Whistle','Stoppage_Icing','Stoppage_Offside','Stoppage_Penalty','Stoppage_GoalieFreeze','Stoppage_PuckOutOfPlay'], d2: [] }
};

// ============================================================================
// INIT
// ============================================================================
function init() {
  buildSlots();
  setupKeys();
  loadLocal();
  updateUI();
}

function buildSlots() {
  const slots = ['F1','F2','F3','D1','D2','G'];
  const labels = ['LW','C','RW','LD','RD','G'];
  document.getElementById('slots').innerHTML = slots.map((s,i) => 
    `<div class="slot" data-slot="${s}" onclick="selectSlot('${s}')"><div class="lbl">${labels[i]}</div><div class="num" id="slot${s}">-</div></div>`
  ).join('');
}

function setupKeys() {
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
    const map = {f:'Faceoff',s:'Shot',g:'Goal',v:'Save',p:'Pass',t:'Turnover',z:'Zone_Entry',x:'Zone_Exit',h:'Hit',b:'Block',r:'Retrieval',w:'Stoppage'};
    if (map[e.key.toLowerCase()]) { setType(map[e.key.toLowerCase()]); e.preventDefault(); }
    if (e.key === ' ') { toggleSuccess(); e.preventDefault(); }
    if (e.key === 'Enter') { saveEvt(); e.preventDefault(); }
    if (e.key >= '1' && e.key <= '4') { setPeriod(+e.key); e.preventDefault(); }
  });
}

// ============================================================================
// TEAM / PERIOD
// ============================================================================
function setTeam(t) {
  S.team = t;
  document.querySelectorAll('.team-btn').forEach(b => b.classList.toggle('active', b.classList.contains(t)));
  document.getElementById('iceTeam').textContent = t === 'home' ? 'Home' : 'Away';
  renderRoster();
  renderSlots();
}

function setPeriod(p) {
  S.period = p;
  document.querySelectorAll('.period-btn').forEach((b,i) => b.classList.toggle('active', i+1 === p));
  syncClock();
}

// ============================================================================
// ROSTER & SLOTS
// ============================================================================
function renderRoster() {
  const r = S.roster[S.team] || [];
  const onIce = Object.values(S.onIce[S.team]).filter(Boolean);
  document.getElementById('roster').innerHTML = r.map(p => {
    const isOn = onIce.includes(p.number);
    const isSel = S.evt.players.some(ep => ep.number === p.number && ep.team === S.team);
    return `<div class="player ${isOn ? 'on-ice' : ''} ${isSel ? 'selected' : ''}" onclick="clickPlayer(${p.number},'${S.team}')">
      <span class="n">${p.number}</span><span>${p.name || ''}</span>
    </div>`;
  }).join('') || '<span style="color:var(--muted)">No roster loaded</span>';
}

function renderSlots() {
  const ice = S.onIce[S.team];
  ['F1','F2','F3','D1','D2','G'].forEach(s => {
    const el = document.getElementById('slot' + s);
    const slot = document.querySelector(`.slot[data-slot="${s}"]`);
    el.textContent = ice[s] || '-';
    slot.classList.toggle('filled', !!ice[s]);
    slot.classList.toggle('active', S.selectedSlot === s);
  });
}

function selectSlot(s) {
  S.selectedSlot = S.selectedSlot === s ? null : s;
  renderSlots();
}

function clickPlayer(num, team) {
  // If slot selected, assign player to slot
  if (S.selectedSlot && team === S.team) {
    S.onIce[team][S.selectedSlot] = num;
    S.selectedSlot = null;
    renderSlots();
    renderRoster();
    return;
  }
  
  // Otherwise add to event players
  const existing = S.evt.players.findIndex(p => p.number === num && p.team === team);
  if (existing >= 0) {
    S.evt.players.splice(existing, 1);
  } else {
    const role = S.evt.players.length === 0 ? 'P1' : 'P' + (S.evt.players.length + 1);
    S.evt.players.push({ number: num, team, role });
  }
  renderSelectedPlayers();
  renderRoster();
}

function renderSelectedPlayers() {
  const el = document.getElementById('selPlayers');
  if (S.evt.players.length === 0) {
    el.innerHTML = '<span style="color:var(--muted)">None</span>';
  } else {
    el.innerHTML = S.evt.players.map((p,i) => 
      `<div class="sel-player"><span>${p.team[0].toUpperCase()}#${p.number}</span><span class="role">${p.role}</span><span class="x" onclick="removePlayer(${i})">√ó</span></div>`
    ).join('');
  }
}

function removePlayer(i) {
  S.evt.players.splice(i, 1);
  S.evt.players.forEach((p,idx) => p.role = 'P' + (idx + 1));
  renderSelectedPlayers();
  renderRoster();
}

// ============================================================================
// EVENT ENTRY
// ============================================================================
function setType(t) {
  S.evt.type = t;
  document.querySelectorAll('.evt-btn').forEach(b => b.classList.toggle('active', b.dataset.t === t));
  
  // Populate details
  const opts = DETAILS[t] || { d1: [], d2: [] };
  document.getElementById('d1').innerHTML = '<option value="">--</option>' + opts.d1.map(o => `<option value="${o}">${o}</option>`).join('');
  document.getElementById('d2').innerHTML = '<option value="">--</option>' + opts.d2.map(o => `<option value="${o}">${o}</option>`).join('');
  
  // Auto-select first detail
  if (opts.d1.length) document.getElementById('d1').value = opts.d1[0];
  if (t === 'Goal') document.getElementById('d2').value = 'Goal Scored';
}

function setSuccess(s) {
  S.evt.success = s;
  document.querySelector('.suc-btn.s').classList.toggle('active', s === 's');
  document.querySelector('.suc-btn.u').classList.toggle('active', s === 'u');
}

function toggleSuccess() {
  setSuccess(S.evt.success === 's' ? 'u' : 's');
}

function linkPrev() {
  if (S.events.length > 0) {
    const last = S.events[S.events.length - 1];
    document.getElementById('linkTo').value = last.event_index;
    S.evt.link = last.event_index;
  }
}

function saveEvt() {
  if (!S.evt.type) { alert('Select event type'); return; }
  if (!S.gameId) { alert('Create or load a game first'); return; }
  
  const timeS = document.getElementById('timeS').value;
  const timeE = document.getElementById('timeE').value;
  const [startMin, startSec] = parseTime(timeS);
  const [endMin, endSec] = parseTime(timeE);
  
  const eventIndex = 1000 + S.events.length + 1;
  const videoTime = calcVideoTime(S.period, startMin, startSec);
  
  // Create event rows (one per player, or one if no players)
  const players = S.evt.players.length > 0 ? S.evt.players : [{ number: '', team: S.team, role: 'P1' }];
  
  players.forEach((p, i) => {
    const row = {
      event_index: eventIndex,
      event_index_flag_: i === 0 ? 1 : '',
      period: S.period,
      event_start_min_: i === 0 ? startMin : '',
      event_start_sec_: i === 0 ? startSec : '',
      event_end_min_: i === 0 ? endMin : '',
      event_end_sec_: i === 0 ? endSec : '',
      player_game_number_: p.number,
      event_team_zone_: S.evt.zone,
      event_type_: S.evt.type,
      event_detail_: document.getElementById('d1').value,
      event_detail_2_: document.getElementById('d2').value,
      event_successful_: S.evt.success,
      team_: S.team[0],
      team_venue_: S.team === 'home' ? 'Home' : 'Away',
      team_venue_abv_: S.team[0],
      linked_event_index_: S.evt.link || '',
      sequence_index_flag_: '',
      play_index_flag_: '',
      pressured_pressurer_: document.getElementById('pressure').value,
      role_number: i + 1,
      player_role: i === 0 ? 'event_team_player_1' : `event_team_player_${i+1}`,
      running_video_time: videoTime,
      shift_index: S.currentShift,
      xy_x: S.evt.xy ? S.evt.xy.x : '',
      xy_y: S.evt.xy ? S.evt.xy.y : ''
    };
    S.events.push(row);
  });
  
  clearEvt();
  renderEvents();
  updateStats();
  autoSave();
  
  // Decrement clock by 1 second for next event
  const newSec = startSec > 0 ? startSec - 1 : 59;
  const newMin = startSec > 0 ? startMin : startMin - 1;
  if (newMin >= 0) {
    document.getElementById('timeS').value = `${newMin}:${String(newSec).padStart(2,'0')}`;
    document.getElementById('timeE').value = `${newMin}:${String(newSec).padStart(2,'0')}`;
    syncClock();
  }
}

function clearEvt() {
  S.evt = { type: null, d1: '', d2: '', zone: 'n', success: 's', link: null, players: [], xy: null, pressure: '' };
  document.querySelectorAll('.evt-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('d1').innerHTML = '<option value="">--</option>';
  document.getElementById('d2').innerHTML = '<option value="">--</option>';
  document.getElementById('zone').value = 'n';
  setSuccess('s');
  document.getElementById('linkTo').value = '';
  document.getElementById('pressure').value = '';
  document.getElementById('xyMarker').innerHTML = '';
  document.getElementById('xyText').textContent = 'Click rink';
  renderSelectedPlayers();
  renderRoster();
}

function renderEvents() {
  // Show unique events (by event_index)
  const unique = [];
  const seen = new Set();
  S.events.forEach(e => {
    if (!seen.has(e.event_index)) {
      seen.add(e.event_index);
      unique.push(e);
    }
  });
  
  document.getElementById('evtCount').textContent = unique.length;
  document.getElementById('eventList').innerHTML = unique.map(e => {
    const players = S.events.filter(x => x.event_index === e.event_index).map(x => x.player_game_number_).filter(Boolean).join(',');
    const linked = e.linked_event_index_ ? 'linked' : '';
    return `<div class="event-row ${linked}" onclick="selectEvent(${e.event_index})">
      <span class="idx">${e.event_index}</span>
      <span class="time">P${e.period} ${e.event_start_min_}:${String(e.event_start_sec_||0).padStart(2,'0')}</span>
      <span class="type">${e.event_type_}</span>
      <span class="players">#${players || '-'}</span>
      <span class="zone">${e.event_team_zone_}</span>
      <span class="del" onclick="event.stopPropagation();deleteEvent(${e.event_index})">üóë</span>
    </div>`;
  }).join('');
  
  // Update link dropdown
  document.getElementById('linkTo').innerHTML = '<option value="">None</option>' + 
    unique.slice(-20).reverse().map(e => `<option value="${e.event_index}">${e.event_index}: ${e.event_type_}</option>`).join('');
}

function deleteEvent(idx) {
  if (confirm(`Delete event ${idx}?`)) {
    S.events = S.events.filter(e => e.event_index !== idx);
    renderEvents();
    updateStats();
    autoSave();
  }
}

function selectEvent(idx) {
  // Load event for editing (future feature)
  console.log('Selected event', idx);
}

function scrollEvents() {
  const el = document.getElementById('eventList');
  el.scrollTop = el.scrollHeight;
}

// ============================================================================
// SHIFTS
// ============================================================================
function newShift() {
  // Save current shift
  const shiftData = {
    shift_index: S.currentShift,
    Period: S.period,
    shift_start_min: parseTime(document.getElementById('shiftStart').value)[0],
    shift_start_sec: parseTime(document.getElementById('shiftStart').value)[1],
    shift_end_min: parseTime(document.getElementById('shiftEnd').value || document.getElementById('timeS').value)[0],
    shift_end_sec: parseTime(document.getElementById('shiftEnd').value || document.getElementById('timeS').value)[1],
    shift_start_type: document.getElementById('shiftType').value,
    home_forward_1: S.onIce.home.F1, home_forward_2: S.onIce.home.F2, home_forward_3: S.onIce.home.F3,
    home_defense_1: S.onIce.home.D1, home_defense_2: S.onIce.home.D2, home_goalie: S.onIce.home.G,
    away_forward_1: S.onIce.away.F1, away_forward_2: S.onIce.away.F2, away_forward_3: S.onIce.away.F3,
    away_defense_1: S.onIce.away.D1, away_defense_2: S.onIce.away.D2, away_goalie: S.onIce.away.G,
    game_id: S.gameId
  };
  S.shifts.push(shiftData);
  
  // Start new shift
  S.currentShift++;
  document.getElementById('shiftNum').textContent = S.currentShift;
  document.getElementById('shiftStart').value = document.getElementById('timeS').value;
  document.getElementById('shiftEnd').value = '';
  document.getElementById('shiftType').value = 'OtherFaceoff';
  
  updateStats();
  autoSave();
}

// ============================================================================
// CLOCK & VIDEO
// ============================================================================
function parseTime(str) {
  if (!str) return [0, 0];
  const parts = str.split(':');
  return [parseInt(parts[0]) || 0, parseInt(parts[1]) || 0];
}

function syncClock() {
  const t = document.getElementById('timeS').value;
  document.getElementById('clock').textContent = t;
  const [m, s] = parseTime(t);
  const vt = calcVideoTime(S.period, m, s);
  document.getElementById('videoTime').textContent = vt + 's';
}

function copyStartToEnd() {
  document.getElementById('timeE').value = document.getElementById('timeS').value;
}

function calcVideoTime(period, min, sec) {
  // Each period is 20 min, clock counts down from 20:00
  // Video time = (period-1)*20*60 + (20*60 - min*60 - sec) + intermission
  const periodSec = (20 - min) * 60 - sec;
  const priorPeriods = (period - 1) * 20 * 60;
  const intermission = (period - 1) * 60; // ~1 min between periods (adjust as needed)
  return priorPeriods + periodSec + intermission + S.videoStart;
}

function loadVideo() {
  const url = document.getElementById('videoUrl').value;
  if (!url) return;
  
  // Extract YouTube video ID
  let videoId = '';
  if (url.includes('youtu.be/')) {
    videoId = url.split('youtu.be/')[1].split(/[?&]/)[0];
  } else if (url.includes('v=')) {
    videoId = url.split('v=')[1].split(/[?&]/)[0];
  }
  
  if (videoId) {
    document.getElementById('videoBox').innerHTML = 
      `<iframe src="https://www.youtube.com/embed/${videoId}?enablejsapi=1" allowfullscreen></iframe>`;
  }
}

function captureTime() {
  // Get time from video (would need YouTube API for accurate sync)
  // For now, prompt user
  const t = prompt('Enter video time in seconds:');
  if (t) {
    S.videoStart = parseInt(t);
    syncClock();
  }
}

// ============================================================================
// RINK XY
// ============================================================================
function clickRink(e) {
  const svg = e.currentTarget;
  const rect = svg.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width * 200).toFixed(1);
  const y = ((e.clientY - rect.top) / rect.height * 85).toFixed(1);
  
  S.evt.xy = { x: parseFloat(x), y: parseFloat(y) };
  document.getElementById('xyMarker').innerHTML = `<circle cx="${x}" cy="${y}" r="4" fill="var(--accent)"/>`;
  document.getElementById('xyText').textContent = `(${x}, ${y})`;
}

// ============================================================================
// STATS
// ============================================================================
function updateStats() {
  const unique = [...new Set(S.events.map(e => e.event_index))];
  const goals = S.events.filter(e => e.event_type_ === 'Goal' && e.event_index_flag_ === 1);
  const homeGoals = goals.filter(e => e.team_venue_ === 'Home').length;
  const awayGoals = goals.filter(e => e.team_venue_ === 'Away').length;
  const shots = S.events.filter(e => ['Shot','Goal'].includes(e.event_type_) && e.event_index_flag_ === 1).length;
  
  document.getElementById('homeG').textContent = homeGoals;
  document.getElementById('awayG').textContent = awayGoals;
  document.getElementById('shots').textContent = shots;
  document.getElementById('shiftCt').textContent = S.shifts.length;
}

// ============================================================================
// SAVE / LOAD / EXPORT
// ============================================================================
function autoSave() {
  if (S.gameId) saveLocal();
}

function saveLocal() {
  if (!S.gameId) return;
  const data = { gameId: S.gameId, game: S.game, events: S.events, shifts: S.shifts, onIce: S.onIce, roster: S.roster, currentShift: S.currentShift };
  localStorage.setItem('benchsight_game_' + S.gameId, JSON.stringify(data));
  document.getElementById('status').textContent = 'Saved ' + new Date().toLocaleTimeString();
}

function loadLocal() {
  // Check for any saved games
  const keys = Object.keys(localStorage).filter(k => k.startsWith('benchsight_game_'));
  const select = document.getElementById('gameSelect');
  keys.forEach(k => {
    const gid = k.replace('benchsight_game_', '');
    const opt = document.createElement('option');
    opt.value = gid;
    opt.textContent = gid + ' (saved)';
    select.appendChild(opt);
  });
}

function loadGame(gid) {
  if (!gid) return;
  
  const saved = localStorage.getItem('benchsight_game_' + gid);
  if (saved) {
    const data = JSON.parse(saved);
    S.gameId = data.gameId;
    S.game = data.game;
    S.events = data.events || [];
    S.shifts = data.shifts || [];
    S.onIce = data.onIce || { home: {}, away: {} };
    S.roster = data.roster || { home: [], away: [] };
    S.currentShift = data.currentShift || 1;
    
    document.getElementById('shiftNum').textContent = S.currentShift;
    renderRoster();
    renderSlots();
    renderEvents();
    updateStats();
    document.getElementById('status').textContent = 'Loaded ' + gid;
  }
}

function newGame() {
  const gid = prompt('Enter Game ID:');
  if (!gid) return;
  
  S.gameId = gid;
  S.game = { id: gid, homeTeam: 'Home', awayTeam: 'Away' };
  S.events = [];
  S.shifts = [];
  S.currentShift = 1;
  S.onIce = { home: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null}, away: {F1:null,F2:null,F3:null,D1:null,D2:null,G:null} };
  
  // Prompt for roster
  const homeRoster = prompt('Home roster (comma-separated numbers):', '1,2,3,4,5,6,7,8,9,10,99');
  const awayRoster = prompt('Away roster (comma-separated numbers):', '11,12,13,14,15,16,17,18,19,20,39');
  
  S.roster.home = (homeRoster || '').split(',').map(n => ({ number: parseInt(n.trim()), name: '' })).filter(p => p.number);
  S.roster.away = (awayRoster || '').split(',').map(n => ({ number: parseInt(n.trim()), name: '' })).filter(p => p.number);
  
  // Add to dropdown
  const opt = document.createElement('option');
  opt.value = gid;
  opt.textContent = gid;
  document.getElementById('gameSelect').appendChild(opt);
  document.getElementById('gameSelect').value = gid;
  
  renderRoster();
  renderSlots();
  renderEvents();
  updateStats();
  saveLocal();
}

function exportXLSX() {
  if (!S.gameId) { alert('No game to export'); return; }
  
  // Prepare events sheet (matching your format)
  const eventsData = S.events.map(e => ({
    event_index_flag_: e.event_index_flag_,
    sequence_index_flag_: e.sequence_index_flag_,
    play_index_flag_: e.play_index_flag_,
    linked_event_index_flag_: e.linked_event_index_ ? 1 : '',
    event_start_min_: e.event_start_min_,
    event_start_sec_: e.event_start_sec_,
    event_end_min_: e.event_end_min_,
    event_end_sec_: e.event_end_sec_,
    player_game_number_: e.player_game_number_,
    event_team_zone_: e.event_team_zone_,
    event_type_: e.event_type_,
    event_detail_: e.event_detail_,
    event_detail_2_: e.event_detail_2_,
    event_successful_: e.event_successful_,
    play_detail1_: '',
    play_detail2_: '',
    play_detail_successful_: '',
    pressured_pressurer_: e.pressured_pressurer_,
    event_index_: e.event_index,
    linked_event_index_: e.linked_event_index_,
    sequence_index_: '',
    play_index_: '',
    team_: e.team_,
    period: e.period,
    running_video_time: e.running_video_time,
    shift_index: e.shift_index,
    xy_x: e.xy_x,
    xy_y: e.xy_y
  }));
  
  // Prepare shifts sheet
  const shiftsData = S.shifts.map(s => ({
    shift_index: s.shift_index,
    Period: s.Period,
    shift_start_min: s.shift_start_min,
    shift_start_sec: s.shift_start_sec,
    shift_end_min: s.shift_end_min,
    shift_end_sec: s.shift_end_sec,
    shift_start_type: s.shift_start_type,
    shift_stop_type: '',
    home_forward_1: s.home_forward_1,
    home_forward_2: s.home_forward_2,
    home_forward_3: s.home_forward_3,
    home_defense_1: s.home_defense_1,
    home_defense_2: s.home_defense_2,
    home_xtra: '',
    home_goalie: s.home_goalie,
    away_forward_1: s.away_forward_1,
    away_forward_2: s.away_forward_2,
    away_forward_3: s.away_forward_3,
    away_defense_1: s.away_defense_1,
    away_defense_2: s.away_defense_2,
    away_xtra: '',
    away_goalie: s.away_goalie,
    game_id: s.game_id
  }));
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(eventsData), 'events');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shiftsData), 'shifts');
  XLSX.writeFile(wb, `${S.gameId}_tracking.xlsx`);
  
  document.getElementById('status').textContent = 'Exported!';
}

function updateUI() {
  syncClock();
  renderRoster();
  renderSlots();
  renderEvents();
  updateStats();
}

// Start
document.addEventListener('DOMContentLoaded', init);
document.getElementById('gameSelect').addEventListener('change', e => loadGame(e.target.value));
</script>
</body>
</html>

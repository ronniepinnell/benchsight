<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèí BLB Pro Tracker v15</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0d1117;--panel:#161b22;--card:#21262d;--input:#0d1117;--border:#30363d;--accent:#58a6ff;--success:#3fb950;--warn:#d29922;--danger:#f85149;--text:#c9d1d9;--muted:#8b949e;--home:#667788;--away:#9C47E4}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);font-size:11px;overflow:hidden;height:100vh}
.header{background:var(--panel);border-bottom:1px solid var(--border);padding:4px 10px;display:flex;align-items:center;gap:8px;height:36px}
.header h1{font-size:13px;color:var(--accent)}
.header select,.header input{background:var(--input);border:1px solid var(--border);color:var(--text);padding:2px 5px;border-radius:3px;font-size:10px}
.clock{font-family:'SF Mono',monospace;font-size:16px;font-weight:700;color:var(--accent);background:var(--card);padding:2px 8px;border-radius:4px}
.clock input{background:transparent;border:none;color:var(--accent);font-family:inherit;font-size:inherit;font-weight:inherit;width:55px;text-align:center;outline:none}
.score span{padding:2px 6px;border-radius:3px;font-weight:700;font-size:13px}
.header-right{margin-left:auto;display:flex;gap:6px;align-items:center}
.btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:3px;cursor:pointer;font-size:10px;transition:all 0.15s}
.btn:hover{background:var(--border)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#000}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
.btn.success{background:var(--success);border-color:var(--success);color:#000}
.btn.sm{padding:2px 4px;font-size:9px}
kbd{background:var(--input);border:1px solid var(--border);padding:0 3px;border-radius:2px;font-family:monospace;font-size:8px}
.main{display:flex;height:calc(100vh - 36px)}
.panel{background:var(--panel);display:flex;flex-direction:column;overflow:hidden}
.panel-header{background:var(--card);padding:4px 8px;font-size:10px;font-weight:600;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.panel-content{flex:1;overflow-y:auto;padding:6px}
.left-panel{width:280px;border-right:1px solid var(--border)}
.center-panel{flex:1;display:flex;flex-direction:column}
.right-panel{width:340px;border-left:1px solid var(--border)}
.team-section{margin-bottom:8px;background:var(--card);border-radius:6px;padding:6px}
.team-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.team-header h4{font-size:11px;display:flex;align-items:center;gap:4px}
.team-header .dot{width:10px;height:10px;border-radius:50%}
.position-row{display:flex;align-items:center;gap:4px;margin-bottom:4px}
.position-row .label{font-size:9px;color:var(--muted);width:20px}
.position-row .slots{display:flex;gap:3px;flex:1}
.slot-btn{min-width:38px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:9px;cursor:pointer;border:2px solid var(--border);background:var(--input);transition:all 0.15s}
.slot-btn.filled{border-color:var(--success);background:var(--card)}
.slot-btn.selected{box-shadow:0 0 0 2px var(--accent)}
.slot-btn:hover{border-color:var(--accent)}
.roster-picker{background:var(--input);border:1px solid var(--border);border-radius:4px;padding:4px;margin-top:4px;display:none}
.roster-picker.show{display:block}
.roster-grid{display:flex;flex-wrap:wrap;gap:2px}
.roster-btn{padding:2px 5px;font-size:9px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--card)}
.roster-btn:hover{background:var(--accent);color:#000}
.roster-btn.in-shift{opacity:0.4}
.video-area{height:28%;min-height:80px;background:#000;position:relative;border-bottom:1px solid var(--border)}
.video-area.no-video{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.video-area.no-video .prompt{color:var(--muted);font-size:12px}
.video-wrapper{width:100%;height:100%}
.video-wrapper iframe{width:100%;height:100%;border:none}
.video-controls{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.9);padding:4px 8px;display:flex;align-items:center;gap:8px}
.video-controls .time{font-family:monospace;font-size:10px;color:#fff}
.rink-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;position:relative}
#rinkSvg{width:100%;max-width:520px;cursor:crosshair}
.mode-ind{position:absolute;top:8px;left:50%;transform:translateX(-50%);padding:4px 16px;border-radius:20px;font-size:12px;font-weight:600;z-index:5}
.mode-ind.puck{background:#000;color:#fff;border:2px solid #fff}
.mode-ind.player{background:var(--accent);color:#000}
.evt-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px;margin-bottom:8px}
.evt-btn{padding:6px 3px;display:flex;flex-direction:column;align-items:center;gap:1px;border-radius:5px}
.evt-btn span{font-size:9px;font-weight:600}
.evt-btn kbd{font-size:7px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:6px}
.form-row.tri{grid-template-columns:1fr 1fr 1fr}
.form-group{display:flex;flex-direction:column;gap:2px}
.form-group label{font-size:8px;color:var(--muted);text-transform:uppercase}
.form-group select,.form-group input{background:var(--input);border:1px solid var(--border);color:var(--text);padding:3px;border-radius:3px;font-size:10px}
.time-input{font-family:monospace;text-align:center;width:55px}
.player-cards{display:flex;flex-direction:column;gap:3px;margin-bottom:6px}
.player-card{background:var(--card);border-radius:5px;padding:5px;border-left:3px solid var(--accent)}
.player-card.opp{border-left-color:var(--danger)}
.player-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.player-card-header .info{display:flex;align-items:center;gap:4px}
.player-card-header .num{font-size:12px;font-weight:700}
.player-card-header .name{font-size:9px;color:var(--muted)}
.quick-add{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px;padding:4px;background:var(--card);border-radius:4px}
.quick-add-btn{padding:3px 6px;font-size:9px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--input)}
.quick-add-btn:hover{background:var(--accent);color:#000}
.quick-add-btn.in{background:var(--success);color:#fff}
.list{max-height:120px;overflow-y:auto}
.list-item{display:grid;grid-template-columns:auto 50px 1fr 20px;gap:3px;padding:4px;border-bottom:1px solid var(--border);font-size:9px;cursor:pointer;align-items:center}
.list-item:hover{background:var(--card)}
.list-item.active{background:rgba(88,166,255,0.15);border-left:2px solid var(--accent)}
.list-item .chk{width:14px;height:14px}
.list-item .idx{font-family:monospace;font-size:8px;color:var(--accent)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:8px;width:90%;max-width:800px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{background:var(--card);padding:10px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:16px;overflow-y:auto;flex:1}
.modal-footer{padding:10px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.section{margin-bottom:8px}
.section-title{font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:3px;display:flex;justify-content:space-between}
.box-scores{background:var(--card);border-radius:6px;padding:8px;margin-bottom:8px}
.box-row{display:flex;justify-content:space-between;font-size:9px;padding:2px 0;border-bottom:1px solid var(--border)}
.box-row:last-child{border:none}
.tabs{display:flex;gap:2px;margin-bottom:8px}
.tab{flex:1;padding:6px;text-align:center;font-size:10px;cursor:pointer;border-radius:4px;background:var(--card)}
.tab.active{background:var(--accent);color:#000}
.tab-panel{display:none}
.tab-panel.active{display:block}
</style>
</head>
<body>

<div class="header">
  <h1>üèí v15</h1>
  <a href="index.html" class="btn sm">‚Üê Portal</a>
  <select id="gameSelect" onchange="switchGame(this.value)"></select>
  <span id="matchup">-- vs --</span>
  <select id="period" onchange="S.period=+this.value">
    <option value="1">P1</option><option value="2">P2</option><option value="3">P3</option><option value="4">OT</option>
  </select>
  <div class="clock"><input type="text" id="clockInput" value="18:00" onfocus="S.timeOverride=true" onblur="formatClockInput()" onkeydown="if(event.key==='Enter')formatClockInput()"></div>
  <button class="btn sm" onclick="adjClock(-1)">‚àí1</button>
  <button class="btn sm" onclick="adjClock(1)">+1</button>
  <div class="score"><span id="hScore" style="background:var(--home);color:#fff">0</span>-<span id="aScore" style="background:var(--away);color:#fff">0</span></div>
  <div class="header-right">
    <label style="font-size:9px" id="syncLabel"><input type="checkbox" id="syncVid"> Sync</label>
    <span>Sh:<b id="shiftN">0</b></span>
    <span>Ev:<b id="evtN">0</b></span>
    <span id="saveStatus">üíæ</span>
    <button class="btn sm" onclick="showModal('settings')">‚öôÔ∏è</button>
    <button class="btn sm" onclick="showModal('hotkeys')">‚å®Ô∏è</button>
  </div>
</div>

<div class="main">
  
  <!-- LEFT PANEL - SHIFTS -->
  <div class="panel left-panel">
    <div class="panel-header">
      Shifts
      <div style="display:flex;gap:4px">
        <button class="btn sm" onclick="selectAllShifts()">‚òë All</button>
        <button class="btn sm danger" onclick="deleteSelectedShifts()">üóëÔ∏è</button>
        <button class="btn sm success" id="logShiftBtn" onclick="logShift()">LOG SHIFT</button>
      </div>
    </div>
    <div class="panel-content">
      
      <!-- HOME TEAM -->
      <div class="team-section">
        <div class="team-header">
          <h4><span class="dot" style="background:var(--home)"></span><span id="homeLabel">Home</span></h4>
          <button class="btn sm" onclick="clearTeam('home')">Clear</button>
        </div>
        <div class="position-row"><span class="label">F</span><div class="slots" id="homeF"></div></div>
        <div class="position-row"><span class="label">D</span><div class="slots" id="homeD"></div></div>
        <div class="position-row"><span class="label">G</span><div class="slots" id="homeG"></div></div>
        <div class="roster-picker" id="homeRoster"></div>
      </div>
      
      <!-- AWAY TEAM -->
      <div class="team-section">
        <div class="team-header">
          <h4><span class="dot" style="background:var(--away)"></span><span id="awayLabel">Away</span></h4>
          <button class="btn sm" onclick="clearTeam('away')">Clear</button>
        </div>
        <div class="position-row"><span class="label">F</span><div class="slots" id="awayF"></div></div>
        <div class="position-row"><span class="label">D</span><div class="slots" id="awayD"></div></div>
        <div class="position-row"><span class="label">G</span><div class="slots" id="awayG"></div></div>
        <div class="roster-picker" id="awayRoster"></div>
      </div>
      
      <!-- SHIFT LIST -->
      <div class="section">
        <div class="section-title">Shift History</div>
        <div class="list" id="shiftList"></div>
      </div>
      
    </div>
  </div>
  
  <!-- CENTER PANEL - RINK & VIDEO -->
  <div class="panel center-panel">
    <div class="video-area" id="videoArea">
      <div class="no-video" id="noVideoPrompt">
        <div class="prompt">No video loaded</div>
        <input type="text" id="youtubeUrl" placeholder="Paste YouTube URL..." style="width:300px;padding:6px;border-radius:4px;border:1px solid var(--border);background:var(--input);color:var(--text)">
        <button class="btn primary" onclick="loadYouTube()">Load Video</button>
        <div style="font-size:10px;color:var(--muted);margin-top:4px">Or use external video player (sync disabled)</div>
      </div>
      <div class="video-wrapper" id="videoWrapper" style="display:none">
        <iframe id="ytPlayer" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
    </div>
    
    <div class="rink-area">
      <div class="mode-ind puck" id="modeInd">üèí Puck XY</div>
      <svg id="rinkSvg" viewBox="-105 -50 210 100" onclick="handleRinkClick(event)">
        <defs>
          <linearGradient id="iceGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#f8fafc"/><stop offset="100%" style="stop-color:#e2e8f0"/>
          </linearGradient>
        </defs>
        <rect x="-100" y="-42.5" width="200" height="85" rx="28" fill="url(#iceGrad)" stroke="#94a3b8" stroke-width="1"/>
        <line x1="0" y1="-42.5" x2="0" y2="42.5" stroke="#dc2626" stroke-width="2"/>
        <line x1="-25" y1="-42.5" x2="-25" y2="42.5" stroke="#2563eb" stroke-width="2"/>
        <line x1="25" y1="-42.5" x2="25" y2="42.5" stroke="#2563eb" stroke-width="2"/>
        <line x1="-89" y1="-42.5" x2="-89" y2="42.5" stroke="#dc2626" stroke-width="1"/>
        <line x1="89" y1="-42.5" x2="89" y2="42.5" stroke="#dc2626" stroke-width="1"/>
        <circle cx="0" cy="0" r="15" fill="none" stroke="#2563eb" stroke-width="1"/>
        <circle cx="0" cy="0" r="1" fill="#2563eb"/>
        <circle cx="-69" cy="-22" r="15" fill="none" stroke="#dc2626" stroke-width="0.5"/>
        <circle cx="-69" cy="22" r="15" fill="none" stroke="#dc2626" stroke-width="0.5"/>
        <circle cx="69" cy="-22" r="15" fill="none" stroke="#dc2626" stroke-width="0.5"/>
        <circle cx="69" cy="22" r="15" fill="none" stroke="#dc2626" stroke-width="0.5"/>
        <rect x="-95" y="-3" width="4" height="6" fill="#1e293b"/>
        <rect x="91" y="-3" width="4" height="6" fill="#1e293b"/>
        <g id="xyMarkers"></g>
      </svg>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="setXYMode('puck')"><kbd>`</kbd> Puck</button>
        <button class="btn" onclick="clearXY()">Clear XY</button>
        <span style="color:var(--muted);font-size:10px" id="xyStatus">Click rink to set XY</span>
      </div>
    </div>
  </div>
  
  <!-- RIGHT PANEL - EVENT LOGGING -->
  <div class="panel right-panel">
    <div class="panel-header">Event Logging<button class="btn sm success" onclick="logEvent()">LOG EVENT</button></div>
    <div class="panel-content">
      
      <!-- EVENT TYPE GRID -->
      <div class="evt-grid">
        <button class="btn evt-btn" onclick="setEvtType('Shot')" data-type="Shot"><span>Shot</span><kbd>S</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Pass')" data-type="Pass"><span>Pass</span><kbd>P</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Faceoff')" data-type="Faceoff"><span>Faceoff</span><kbd>F</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Goal')" data-type="Goal"><span>Goal</span><kbd>G</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Zone')" data-type="Zone"><span>Zone</span><kbd>Z</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Turnover')" data-type="Turnover"><span>Turnover</span><kbd>T</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Takeaway')" data-type="Takeaway"><span>Takeaway</span><kbd>O</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Possession')" data-type="Possession"><span>Poss</span><kbd>V</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Defensive')" data-type="Defensive"><span>Defense</span><kbd>D</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Penalty')" data-type="Penalty"><span>Penalty</span><kbd>X</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Rush')" data-type="Rush"><span>Rush</span><kbd>R</kbd></button>
        <button class="btn evt-btn" onclick="setEvtType('Other')" data-type="Other"><span>Other</span><kbd>N</kbd></button>
      </div>
      
      <!-- EVENT FORM -->
      <div class="form-row">
        <div class="form-group">
          <label>Event Type</label>
          <select id="evtType" onchange="updateDetailOptions()">
            <option>Shot</option><option>Pass</option><option>Faceoff</option><option>Goal</option>
            <option>Zone</option><option>Turnover</option><option>Takeaway</option><option>Possession</option>
            <option>Defensive</option><option>Penalty</option><option>Rush</option><option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Detail</label>
          <select id="evtDetail"></select>
        </div>
      </div>
      
      <div class="form-row tri">
        <div class="form-group">
          <label>Team</label>
          <select id="evtTeam"><option value="home">Home</option><option value="away">Away</option></select>
        </div>
        <div class="form-group">
          <label>Success</label>
          <select id="evtSuccess"><option value="">-</option><option value="1">Yes</option><option value="0">No</option></select>
        </div>
        <div class="form-group">
          <label>Zone</label>
          <select id="evtZone"><option value="">-</option><option>OZ</option><option>NZ</option><option>DZ</option></select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Clock Start</label>
          <input type="text" id="clockStart" class="time-input" placeholder="18:00">
        </div>
        <div class="form-group">
          <label>Clock End</label>
          <input type="text" id="clockEnd" class="time-input" placeholder="17:55">
        </div>
      </div>
      
      <!-- QUICK ADD PLAYERS -->
      <div class="section">
        <div class="section-title">Quick Add Players <span style="font-size:8px">(1-9 = Event, Ctrl+1-9 = Opponent)</span></div>
        <div class="quick-add" id="quickAddBar"></div>
      </div>
      
      <!-- EVENT PLAYERS -->
      <div class="section">
        <div class="section-title">Event Players <button class="btn sm" onclick="addEventPlayer()">+ Add</button></div>
        <div class="player-cards" id="eventPlayers"></div>
      </div>
      
      <!-- XY DISPLAY -->
      <div class="section">
        <div class="section-title">Puck XY</div>
        <div id="puckXYDisplay" style="font-size:10px;color:var(--muted)">No XY set</div>
      </div>
      
      <!-- BOX SCORES MINI -->
      <div class="box-scores">
        <div style="font-size:9px;color:var(--muted);margin-bottom:4px">üìä Box Scores (this game)</div>
        <div id="miniBoxScores"></div>
      </div>
      
      <!-- EVENT LIST -->
      <div class="section">
        <div class="section-title">Events</div>
        <div class="list" id="eventList"></div>
      </div>
      
    </div>
  </div>
  
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-header"><h3>Settings</h3><button class="btn" onclick="closeModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="tabs">
        <div class="tab active" onclick="showSettingsTab('import')">Import</div>
        <div class="tab" onclick="showSettingsTab('export')">Export</div>
        <div class="tab" onclick="showSettingsTab('video')">Video</div>
      </div>
      <div class="tab-panel active" id="importPanel">
        <div class="form-group" style="margin-bottom:12px">
          <label>Import Excel (Events/Shifts)</label>
          <input type="file" id="importFile" accept=".xlsx,.xls" onchange="importExcel(this.files[0])">
        </div>
        <div class="form-group">
          <label>Import JSON</label>
          <input type="file" id="importJson" accept=".json" onchange="importJSON(this.files[0])">
        </div>
      </div>
      <div class="tab-panel" id="exportPanel">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="exportExcel()">üì• Export Excel</button>
          <button class="btn" onclick="exportJSON()">üì• Export JSON</button>
          <button class="btn danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>
      </div>
      <div class="tab-panel" id="videoPanel">
        <div class="form-group" style="margin-bottom:12px">
          <label>YouTube URL</label>
          <input type="text" id="settingsYouTube" placeholder="https://youtube.com/watch?v=...">
          <button class="btn" onclick="loadYouTubeFromSettings()" style="margin-top:4px">Load</button>
        </div>
        <div class="form-row">
          <div class="form-group"><label>P1 Offset (sec)</label><input type="number" id="p1Offset" value="0"></div>
          <div class="form-group"><label>P2 Offset (sec)</label><input type="number" id="p2Offset" value="1200"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>P3 Offset (sec)</label><input type="number" id="p3Offset" value="2400"></div>
          <div class="form-group"><label>OT Offset (sec)</label><input type="number" id="otOffset" value="3600"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HOTKEYS MODAL -->
<div class="modal-overlay" id="hotkeysModal">
  <div class="modal" style="max-width:500px">
    <div class="modal-header"><h3>Keyboard Shortcuts</h3><button class="btn" onclick="closeModal()">‚úï</button></div>
    <div class="modal-body" style="font-size:11px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <h4 style="color:var(--accent);margin-bottom:8px">Event Types</h4>
          <div><kbd>S</kbd> Shot</div>
          <div><kbd>P</kbd> Pass</div>
          <div><kbd>F</kbd> Faceoff</div>
          <div><kbd>G</kbd> Goal</div>
          <div><kbd>Z</kbd> Zone</div>
          <div><kbd>T</kbd> Turnover</div>
          <div><kbd>O</kbd> Takeaway</div>
          <div><kbd>V</kbd> Possession</div>
        </div>
        <div>
          <h4 style="color:var(--accent);margin-bottom:8px">Actions</h4>
          <div><kbd>1-9</kbd> Add player to event</div>
          <div><kbd>Ctrl+1-9</kbd> Add opponent</div>
          <div><kbd>Enter</kbd> Log event</div>
          <div><kbd>Esc</kbd> Clear form</div>
          <div><kbd>`</kbd> Puck XY mode</div>
          <div><kbd>H</kbd> Home team</div>
          <div><kbd>A</kbd> Away team</div>
          <div><kbd>Tab</kbd> Toggle team</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============ GAME DATA ============
const GAMES = {
  18955:{id:18955,home:"Velodrome",away:"Orphans",date:"2025-08-10",homeColor:"#9C47E4",awayColor:"#000"},
  18959:{id:18959,home:"Amos",away:"Velodrome",date:"2025-08-17",homeColor:"#641C28",awayColor:"#9C47E4"},
  18965:{id:18965,home:"Velodrome",away:"OS Offices",date:"2025-08-24",homeColor:"#9C47E4",awayColor:"#2C8A5E"},
  18969:{id:18969,home:"Platinum",away:"Velodrome",date:"2025-09-07",homeColor:"#919294",awayColor:"#9C47E4"},
  18977:{id:18977,home:"Velodrome",away:"HollowBrook",date:"2025-09-14",homeColor:"#9C47E4",awayColor:"#4D2640"},
  18981:{id:18981,home:"Nelson",away:"Velodrome",date:"2025-09-28",homeColor:"#F3C323",awayColor:"#9C47E4"},
  18987:{id:18987,home:"Outlaws",away:"Velodrome",date:"2025-10-05",homeColor:"#02007B",awayColor:"#9C47E4"},
  18991:{id:18991,home:"Triple J",away:"Velodrome",date:"2025-10-12",homeColor:"#4EB9E5",awayColor:"#9C47E4"},
  18993:{id:18993,home:"Ace",away:"Velodrome",date:"2025-10-19",homeColor:"#CA0527",awayColor:"#9C47E4"},
  19032:{id:19032,home:"Velodrome",away:"Nelson",date:"2025-11-24",homeColor:"#9C47E4",awayColor:"#F3C323"}
};

const ROSTERS = {
  "Velodrome": [
    {n:"6",name:"Sam Downs",pos:"F",rating:6},{n:"5",name:"Josh Cronk",pos:"F",rating:5},
    {n:"4",name:"Kevin White",pos:"F",rating:4},{n:"5",name:"Garrett Ashcroft",pos:"F",rating:5},
    {n:"3",name:"James Rynearson",pos:"F",rating:3},{n:"5",name:"Galen Wood",pos:"F",rating:5},
    {n:"2",name:"Jennifer Valente",pos:"D",rating:2},{n:"3",name:"Robert Mayfield",pos:"D",rating:3},
    {n:"3",name:"Kaitlyn Shain",pos:"F",rating:3},{n:"4",name:"Maxwell Donaty",pos:"D",rating:4},
    {n:"4",name:"Nick Ciampoli",pos:"F",rating:4},{n:"4",name:"Ronnie Pinnell",pos:"D",rating:4},
    {n:"2",name:"Nicole Downs",pos:"F",rating:2},{n:"5",name:"Wyatt Crandall",pos:"G",rating:5},
    {n:"3",name:"Pat Major",pos:"D",rating:3},{n:"4",name:"Hayden Perea",pos:"D",rating:4}
  ],
  "Platinum": [
    {n:"53",name:"Chris Premo",pos:"F",rating:5},{n:"21",name:"Andrew Marshall",pos:"F",rating:5},
    {n:"47",name:"Josh Simonds",pos:"F",rating:4},{n:"34",name:"Chris Dube",pos:"F",rating:4},
    {n:"78",name:"Matt Quinn",pos:"D",rating:4},{n:"45",name:"Keegan Mantaro",pos:"D",rating:4},
    {n:"99",name:"Francis Forte",pos:"G",rating:5}
  ]
};

const DETAILS = {
  Shot:["OnNet_Saved","OnNet_Goal","Missed","Blocked"],
  Pass:["Completed","Incomplete","Intercepted"],
  Faceoff:["Won","Lost"],
  Goal:["EvenStrength","PowerPlay","ShortHanded","EmptyNet"],
  Zone:["Entry_Carry","Entry_Dump","Entry_Pass","Exit_Clear","Exit_Carry"],
  Turnover:["Lost_Pass","Lost_Possession","Giveaway"],
  Takeaway:["Stick","Body","Intercept"],
  Possession:["Gained","Maintained","Lost"],
  Defensive:["Block","Clear","BodyCheck"],
  Penalty:["Minor","Major","Misconduct"],
  Rush:["Odd_Man","Breakaway","2on1","3on2"],
  Other:["Whistle","Icing","Offside","TV_Timeout"]
};

// ============ STATE ============
let S = {
  gameId: 18969,
  period: 1,
  clockSec: 18*60,
  timeOverride: false,
  shifts: [],
  events: [],
  currentShift: null,
  shiftSlots: {home:{F1:null,F2:null,F3:null,D1:null,D2:null,G:null},away:{F1:null,F2:null,F3:null,D1:null,D2:null,G:null}},
  selectedSlot: null,
  evtPlayers: [],
  puckXY: [],
  xyMode: 'puck',
  xySlot: 0,
  currentPlayer: null,
  boxScores: {},
  hGoals: 0,
  aGoals: 0,
  hasVideo: false
};

// ============ INITIALIZATION ============
function init() {
  // Populate game select
  const sel = document.getElementById('gameSelect');
  sel.innerHTML = Object.values(GAMES).map(g => 
    `<option value="${g.id}">${g.id} - ${g.home} vs ${g.away}</option>`
  ).join('');
  sel.value = S.gameId;
  
  // Load saved data
  loadFromStorage();
  
  // Setup UI
  updateGameDisplay();
  renderShiftSlots();
  updateDetailOptions();
  renderLists();
  renderQuickAdd();
  updateBoxScores();
  
  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeydown);
  
  // Auto-save
  setInterval(saveToStorage, 30000);
}

function switchGame(gameId) {
  saveToStorage();
  S.gameId = +gameId;
  S.shifts = [];
  S.events = [];
  S.currentShift = null;
  S.hGoals = 0;
  S.aGoals = 0;
  S.boxScores = {};
  clearShiftSlots();
  clearEventForm();
  loadFromStorage();
  updateGameDisplay();
  renderLists();
  updateBoxScores();
}

function updateGameDisplay() {
  const g = GAMES[S.gameId];
  if (!g) return;
  document.getElementById('matchup').textContent = `${g.home} vs ${g.away}`;
  document.getElementById('homeLabel').textContent = g.home;
  document.getElementById('awayLabel').textContent = g.away;
  document.documentElement.style.setProperty('--home', g.homeColor);
  document.documentElement.style.setProperty('--away', g.awayColor);
  document.getElementById('hScore').textContent = S.hGoals;
  document.getElementById('aScore').textContent = S.aGoals;
  renderRosters();
}

// ============ CLOCK ============
function formatClockInput() {
  const input = document.getElementById('clockInput');
  let val = input.value.replace(/[^0-9]/g, '');
  
  if (val.length === 3) val = '0' + val;
  if (val.length === 4) {
    const min = parseInt(val.slice(0,2));
    const sec = parseInt(val.slice(2,4));
    S.clockSec = min * 60 + sec;
    input.value = `${min}:${String(sec).padStart(2,'0')}`;
  } else if (val.length <= 2) {
    S.clockSec = parseInt(val || 0) * 60;
    input.value = `${val || 0}:00`;
  }
  S.timeOverride = false;
  document.getElementById('clockStart').value = input.value;
}

function adjClock(sec) {
  S.clockSec = Math.max(0, S.clockSec + sec);
  updateClockDisplay();
}

function updateClockDisplay() {
  const min = Math.floor(S.clockSec / 60);
  const sec = S.clockSec % 60;
  document.getElementById('clockInput').value = `${min}:${String(sec).padStart(2,'0')}`;
  document.getElementById('clockStart').value = `${min}:${String(sec).padStart(2,'0')}`;
}

// ============ SHIFT MANAGEMENT ============
function renderShiftSlots() {
  ['home','away'].forEach(team => {
    const fSlots = ['F1','F2','F3'].map(pos => 
      `<div class="slot-btn ${S.shiftSlots[team][pos]?'filled':''}" data-team="${team}" data-pos="${pos}" onclick="selectSlot(this)">${S.shiftSlots[team][pos]?.n || pos}</div>`
    ).join('');
    const dSlots = ['D1','D2'].map(pos =>
      `<div class="slot-btn ${S.shiftSlots[team][pos]?'filled':''}" data-team="${team}" data-pos="${pos}" onclick="selectSlot(this)">${S.shiftSlots[team][pos]?.n || pos}</div>`
    ).join('');
    const gSlot = `<div class="slot-btn ${S.shiftSlots[team].G?'filled':''}" data-team="${team}" data-pos="G" onclick="selectSlot(this)">${S.shiftSlots[team].G?.n || 'G'}</div>`;
    
    document.getElementById(`${team}F`).innerHTML = fSlots;
    document.getElementById(`${team}D`).innerHTML = dSlots;
    document.getElementById(`${team}G`).innerHTML = gSlot;
  });
}

function renderRosters() {
  const g = GAMES[S.gameId];
  ['home','away'].forEach(team => {
    const teamName = team === 'home' ? g.home : g.away;
    const roster = ROSTERS[teamName] || ROSTERS['Velodrome'];
    const picker = document.getElementById(`${team}Roster`);
    picker.innerHTML = `<div class="roster-grid">${roster.map(p => 
      `<div class="roster-btn" onclick="assignPlayer('${team}','${p.n}','${p.name}')">#${p.n} ${fmtName(p.name)}</div>`
    ).join('')}</div>`;
  });
}

function selectSlot(el) {
  document.querySelectorAll('.slot-btn').forEach(s => s.classList.remove('selected'));
  el.classList.add('selected');
  S.selectedSlot = {team: el.dataset.team, pos: el.dataset.pos};
  document.getElementById(`${el.dataset.team}Roster`).classList.add('show');
  document.getElementById(`${el.dataset.team === 'home' ? 'away' : 'home'}Roster`).classList.remove('show');
}

function assignPlayer(team, num, name) {
  if (!S.selectedSlot || S.selectedSlot.team !== team) return;
  S.shiftSlots[team][S.selectedSlot.pos] = {n: num, name: name};
  document.getElementById(`${team}Roster`).classList.remove('show');
  renderShiftSlots();
  renderQuickAdd();
}

function clearTeam(team) {
  ['F1','F2','F3','D1','D2','G'].forEach(pos => S.shiftSlots[team][pos] = null);
  renderShiftSlots();
  renderQuickAdd();
}

function clearShiftSlots() {
  clearTeam('home');
  clearTeam('away');
}

function logShift() {
  // Validate at least one player
  const homePlayers = Object.values(S.shiftSlots.home).filter(p => p);
  const awayPlayers = Object.values(S.shiftSlots.away).filter(p => p);
  
  if (homePlayers.length === 0 && awayPlayers.length === 0) {
    alert('Please assign at least one player to the shift');
    return;
  }
  
  const shift = {
    idx: S.shifts.length,
    id: `SH${S.gameId}-${String(S.shifts.length + 1).padStart(3,'0')}`,
    gameId: S.gameId,
    period: S.period,
    start: document.getElementById('clockInput').value,
    end: '',
    startType: 'Faceoff',
    stopType: '',
    home: {...S.shiftSlots.home},
    away: {...S.shiftSlots.away},
    events: []
  };
  
  S.shifts.push(shift);
  S.currentShift = shift;
  
  renderLists();
  renderQuickAdd();
  updateCounts();
  saveToStorage();
  
  console.log('Shift logged:', shift);
}

function selectAllShifts() {
  document.querySelectorAll('#shiftList .chk').forEach(c => c.checked = true);
}

function deleteSelectedShifts() {
  const toDelete = [];
  document.querySelectorAll('#shiftList .chk:checked').forEach(c => {
    toDelete.push(+c.dataset.idx);
  });
  if (toDelete.length === 0) return;
  if (!confirm(`Delete ${toDelete.length} shift(s) and their events?`)) return;
  
  S.shifts = S.shifts.filter((s, i) => !toDelete.includes(i));
  S.events = S.events.filter(e => !toDelete.includes(e.shiftIdx));
  S.currentShift = S.shifts.length > 0 ? S.shifts[S.shifts.length - 1] : null;
  
  renderLists();
  saveToStorage();
}

// ============ EVENT LOGGING ============
function setEvtType(type) {
  document.getElementById('evtType').value = type;
  updateDetailOptions();
  document.querySelectorAll('.evt-btn').forEach(b => b.classList.remove('primary'));
  document.querySelector(`.evt-btn[data-type="${type}"]`)?.classList.add('primary');
}

function updateDetailOptions() {
  const type = document.getElementById('evtType').value;
  const details = DETAILS[type] || [];
  document.getElementById('evtDetail').innerHTML = details.map(d => `<option>${d}</option>`).join('');
}

function renderQuickAdd() {
  if (!S.currentShift) {
    document.getElementById('quickAddBar').innerHTML = '<span style="color:var(--muted);font-size:9px">Log a shift first</span>';
    return;
  }
  
  const players = [];
  ['F1','F2','F3','D1','D2','G'].forEach(pos => {
    if (S.currentShift.home[pos]) players.push({...S.currentShift.home[pos], team:'home', pos});
    if (S.currentShift.away[pos]) players.push({...S.currentShift.away[pos], team:'away', pos});
  });
  
  document.getElementById('quickAddBar').innerHTML = players.slice(0,9).map((p, i) => {
    const inEvt = S.evtPlayers.some(ep => ep.n === p.n && ep.team === p.team);
    return `<button class="quick-add-btn ${inEvt?'in':''}" onclick="toggleEventPlayer('${p.team}','${p.n}','${p.name}')">${i+1}:#${p.n}</button>`;
  }).join('');
}

function toggleEventPlayer(team, num, name) {
  const idx = S.evtPlayers.findIndex(p => p.n === num && p.team === team);
  if (idx >= 0) {
    S.evtPlayers.splice(idx, 1);
  } else {
    S.evtPlayers.push({n: num, name: name, team: team, xy: [], pd1: '', pd2: ''});
  }
  renderEventPlayers();
  renderQuickAdd();
  
  // Auto-set puck XY to player XY for possession/zone events
  const evtType = document.getElementById('evtType').value;
  if (['Possession','Zone','Rush'].includes(evtType) && S.evtPlayers.length === 1 && S.puckXY.length === 0) {
    // Will be set when XY is clicked
  }
}

function addEventPlayer() {
  const g = GAMES[S.gameId];
  const team = document.getElementById('evtTeam').value;
  const teamName = team === 'home' ? g.home : g.away;
  const roster = ROSTERS[teamName] || ROSTERS['Velodrome'];
  
  const num = prompt('Player number:');
  if (!num) return;
  
  const player = roster.find(p => p.n === num);
  S.evtPlayers.push({
    n: num,
    name: player?.name || `#${num}`,
    team: team,
    xy: [],
    pd1: '',
    pd2: ''
  });
  renderEventPlayers();
  renderQuickAdd();
}

function renderEventPlayers() {
  document.getElementById('eventPlayers').innerHTML = S.evtPlayers.map((p, i) => `
    <div class="player-card ${p.team === 'away' ? 'opp' : ''}">
      <div class="player-card-header">
        <div class="info">
          <span class="num">#${p.n}</span>
          <span class="name">${fmtName(p.name)}</span>
        </div>
        <button class="btn sm danger" onclick="removeEventPlayer(${i})">‚úï</button>
      </div>
    </div>
  `).join('');
}

function removeEventPlayer(idx) {
  S.evtPlayers.splice(idx, 1);
  renderEventPlayers();
  renderQuickAdd();
}

function logEvent() {
  if (!S.currentShift) {
    alert('Please log a shift first');
    return;
  }
  
  const evtType = document.getElementById('evtType').value;
  const detail = document.getElementById('evtDetail').value;
  
  const evt = {
    idx: S.events.length,
    id: `EV${S.gameId}-${String(S.events.length + 1).padStart(3,'0')}`,
    gameId: S.gameId,
    shiftIdx: S.currentShift.idx,
    shiftId: S.currentShift.id,
    period: S.period,
    type: evtType,
    detail: detail,
    team: document.getElementById('evtTeam').value,
    success: document.getElementById('evtSuccess').value,
    zone: document.getElementById('evtZone').value,
    clockStart: document.getElementById('clockStart').value,
    clockEnd: document.getElementById('clockEnd').value,
    puckXY: [...S.puckXY],
    players: S.evtPlayers.map(p => ({...p}))
  };
  
  S.events.push(evt);
  S.currentShift.events.push(evt.id);
  
  // Update box scores
  updateBoxScoreForEvent(evt);
  
  // Check for linked events
  const needsLinked = checkLinkedEvent(evtType, detail);
  
  // Clear form (unless linked event expected)
  if (!needsLinked) {
    clearEventForm();
  }
  
  // Auto-advance clock
  S.clockSec = Math.max(0, S.clockSec - 5);
  updateClockDisplay();
  
  renderLists();
  updateCounts();
  saveToStorage();
  
  console.log('Event logged:', evt);
}

function checkLinkedEvent(type, detail) {
  // Events that typically have linked responses
  if (type === 'Shot' && detail === 'OnNet_Saved') return true;
  if (type === 'Turnover') return true;
  if (type === 'Faceoff') return true;
  return false;
}

function updateBoxScoreForEvent(evt) {
  if (!evt.players || evt.players.length === 0) return;
  
  evt.players.forEach((p, i) => {
    const key = `${p.team}_${p.n}`;
    if (!S.boxScores[key]) {
      S.boxScores[key] = {n: p.n, name: p.name, team: p.team, g: 0, a: 0, s: 0, to: 0, tk: 0};
    }
    
    if (evt.type === 'Goal') {
      if (i === 0) S.boxScores[key].g++;
      else S.boxScores[key].a++;
      
      if (evt.team === 'home') S.hGoals++;
      else S.aGoals++;
      document.getElementById('hScore').textContent = S.hGoals;
      document.getElementById('aScore').textContent = S.aGoals;
    }
    if (evt.type === 'Shot' && i === 0) S.boxScores[key].s++;
    if (evt.type === 'Turnover' && i === 0) S.boxScores[key].to++;
    if (evt.type === 'Takeaway' && i === 0) S.boxScores[key].tk++;
  });
  
  updateBoxScores();
}

function updateBoxScores() {
  const scores = Object.values(S.boxScores).sort((a,b) => (b.g + b.a) - (a.g + a.a)).slice(0, 5);
  document.getElementById('miniBoxScores').innerHTML = scores.map(p => 
    `<div class="box-row"><span>#${p.n} ${fmtName(p.name)}</span><span>${p.g}G ${p.a}A ${p.s}S</span></div>`
  ).join('') || '<div style="color:var(--muted);font-size:9px">No stats yet</div>';
}

function clearEventForm() {
  S.evtPlayers = [];
  S.puckXY = [];
  S.xyMode = 'puck';
  S.xySlot = 0;
  renderEventPlayers();
  renderQuickAdd();
  document.getElementById('puckXYDisplay').textContent = 'No XY set';
  document.getElementById('xyMarkers').innerHTML = '';
  document.getElementById('modeInd').textContent = 'üèí Puck XY';
  document.getElementById('modeInd').className = 'mode-ind puck';
}

// ============ XY TRACKING ============
function handleRinkClick(e) {
  const svg = document.getElementById('rinkSvg');
  const pt = svg.createSVGPoint();
  pt.x = e.clientX;
  pt.y = e.clientY;
  const loc = pt.matrixTransform(svg.getScreenCTM().inverse());
  
  const x = Math.round(loc.x);
  const y = Math.round(loc.y);
  
  if (S.xyMode === 'puck') {
    S.puckXY.push({x, y});
    document.getElementById('puckXYDisplay').textContent = S.puckXY.map((p,i) => `XY${i+1}: (${p.x}, ${p.y})`).join(' | ');
    
    // Auto-advance or stay in puck mode
    if (S.puckXY.length >= 3) {
      // Max 3 puck XY
    }
  } else if (S.currentPlayer) {
    S.currentPlayer.xy.push({x, y});
    renderEventPlayers();
  }
  
  renderXYMarkers();
}

function renderXYMarkers() {
  const markers = document.getElementById('xyMarkers');
  let html = '';
  
  S.puckXY.forEach((p, i) => {
    html += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#000" stroke="#fff" stroke-width="1.5"/>`;
    html += `<text x="${p.x + 6}" y="${p.y + 3}" fill="#000" font-size="6">${i+1}</text>`;
  });
  
  S.evtPlayers.forEach(player => {
    const color = player.team === 'home' ? 'var(--home)' : 'var(--away)';
    player.xy?.forEach(p => {
      html += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="${color}" stroke="#fff" stroke-width="1"/>`;
    });
  });
  
  markers.innerHTML = html;
}

function setXYMode(mode) {
  S.xyMode = mode;
  if (mode === 'puck') {
    document.getElementById('modeInd').textContent = 'üèí Puck XY';
    document.getElementById('modeInd').className = 'mode-ind puck';
  }
}

function clearXY() {
  S.puckXY = [];
  S.evtPlayers.forEach(p => p.xy = []);
  renderXYMarkers();
  document.getElementById('puckXYDisplay').textContent = 'No XY set';
}

// ============ LISTS ============
function renderLists() {
  // Shifts
  const shiftList = document.getElementById('shiftList');
  shiftList.innerHTML = S.shifts.map((sh, i) => {
    const isActive = S.currentShift?.idx === i;
    const playerCount = Object.values(sh.home).filter(p=>p).length + Object.values(sh.away).filter(p=>p).length;
    return `<div class="list-item ${isActive?'active':''}" onclick="selectShift(${i})">
      <input type="checkbox" class="chk" data-idx="${i}" onclick="event.stopPropagation()">
      <span class="idx">${sh.id}</span>
      <span>P${sh.period} ${sh.start} ‚Ä¢ ${playerCount}pl</span>
      <span>${sh.events.length}ev</span>
    </div>`;
  }).join('');
  
  // Events
  const eventList = document.getElementById('eventList');
  eventList.innerHTML = S.events.slice(-20).reverse().map(ev => {
    const player1 = ev.players?.[0];
    return `<div class="list-item" onclick="editEvent(${ev.idx})">
      <span></span>
      <span class="idx">${ev.id}</span>
      <span>${ev.clockStart} ${ev.type}${player1 ? ` #${player1.n}` : ''}</span>
      <span>${ev.success === '1' ? '‚úì' : ''}</span>
    </div>`;
  }).join('');
  
  document.getElementById('shiftN').textContent = S.shifts.length;
  document.getElementById('evtN').textContent = S.events.length;
}

function selectShift(idx) {
  S.currentShift = S.shifts[idx];
  renderLists();
  renderQuickAdd();
}

function updateCounts() {
  document.getElementById('shiftN').textContent = S.shifts.length;
  document.getElementById('evtN').textContent = S.events.length;
}

// ============ VIDEO ============
function loadYouTube() {
  const url = document.getElementById('youtubeUrl').value;
  loadVideo(url);
}

function loadYouTubeFromSettings() {
  const url = document.getElementById('settingsYouTube').value;
  loadVideo(url);
  closeModal();
}

function loadVideo(url) {
  if (!url) return;
  
  let videoId = '';
  const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
  if (match) videoId = match[1];
  
  if (!videoId) {
    alert('Invalid YouTube URL');
    return;
  }
  
  document.getElementById('noVideoPrompt').style.display = 'none';
  document.getElementById('videoWrapper').style.display = 'block';
  document.getElementById('ytPlayer').src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
  document.getElementById('syncLabel').style.display = 'flex';
  S.hasVideo = true;
}

// ============ MODALS ============
function showModal(id) {
  document.getElementById(id + 'Modal').classList.add('show');
}

function closeModal() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
}

function showSettingsTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tab + 'Panel').classList.add('active');
}

// ============ IMPORT/EXPORT ============
function exportExcel() {
  const eventsData = S.events.map(e => ({
    id: e.id,
    game_id: e.gameId,
    shift_id: e.shiftId,
    period: e.period,
    type: e.type,
    detail: e.detail,
    team: e.team,
    success: e.success,
    zone: e.zone,
    clock_start: e.clockStart,
    clock_end: e.clockEnd,
    puck_x: e.puckXY?.[0]?.x || '',
    puck_y: e.puckXY?.[0]?.y || '',
    player_1: e.players?.[0]?.n || '',
    player_1_name: e.players?.[0]?.name || '',
    player_2: e.players?.[1]?.n || '',
    player_3: e.players?.[2]?.n || ''
  }));
  
  const shiftsData = S.shifts.map(sh => ({
    id: sh.id,
    game_id: sh.gameId,
    period: sh.period,
    start: sh.start,
    end: sh.end,
    home_F1: sh.home.F1?.n || '',
    home_F2: sh.home.F2?.n || '',
    home_F3: sh.home.F3?.n || '',
    home_D1: sh.home.D1?.n || '',
    home_D2: sh.home.D2?.n || '',
    home_G: sh.home.G?.n || '',
    away_F1: sh.away.F1?.n || '',
    away_F2: sh.away.F2?.n || '',
    away_F3: sh.away.F3?.n || '',
    away_D1: sh.away.D1?.n || '',
    away_D2: sh.away.D2?.n || '',
    away_G: sh.away.G?.n || ''
  }));
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(eventsData), 'Events');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shiftsData), 'Shifts');
  XLSX.writeFile(wb, `${S.gameId}_tracking.xlsx`);
}

function exportJSON() {
  const data = {
    gameId: S.gameId,
    shifts: S.shifts,
    events: S.events,
    boxScores: S.boxScores,
    goals: {home: S.hGoals, away: S.aGoals}
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${S.gameId}_tracking.json`;
  a.click();
}

function importJSON(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      S.shifts = data.shifts || [];
      S.events = data.events || [];
      S.boxScores = data.boxScores || {};
      S.hGoals = data.goals?.home || 0;
      S.aGoals = data.goals?.away || 0;
      S.currentShift = S.shifts.length > 0 ? S.shifts[S.shifts.length - 1] : null;
      renderLists();
      updateGameDisplay();
      renderQuickAdd();
      updateBoxScores();
      closeModal();
      alert('Import successful!');
    } catch (err) {
      alert('Import failed: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function importExcel(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, {type: 'array'});
      
      // Import events
      if (wb.SheetNames.includes('events') || wb.SheetNames.includes('Events')) {
        const sheet = wb.Sheets['events'] || wb.Sheets['Events'];
        const data = XLSX.utils.sheet_to_json(sheet);
        console.log('Imported events:', data.length);
      }
      
      // Import shifts
      if (wb.SheetNames.includes('shifts') || wb.SheetNames.includes('Shifts')) {
        const sheet = wb.Sheets['shifts'] || wb.Sheets['Shifts'];
        const data = XLSX.utils.sheet_to_json(sheet);
        console.log('Imported shifts:', data.length);
      }
      
      closeModal();
      alert('Import complete - check console for details');
    } catch (err) {
      alert('Import failed: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function clearAllData() {
  if (!confirm('Clear all tracking data for this game?')) return;
  S.shifts = [];
  S.events = [];
  S.boxScores = {};
  S.hGoals = 0;
  S.aGoals = 0;
  S.currentShift = null;
  clearShiftSlots();
  clearEventForm();
  renderLists();
  updateGameDisplay();
  updateBoxScores();
  localStorage.removeItem(`blb_${S.gameId}`);
  closeModal();
}

// ============ STORAGE ============
function saveToStorage() {
  const data = {
    shifts: S.shifts,
    events: S.events,
    boxScores: S.boxScores,
    hGoals: S.hGoals,
    aGoals: S.aGoals
  };
  localStorage.setItem(`blb_${S.gameId}`, JSON.stringify(data));
  document.getElementById('saveStatus').textContent = 'üíæ‚úì';
  setTimeout(() => document.getElementById('saveStatus').textContent = 'üíæ', 2000);
}

function loadFromStorage() {
  const saved = localStorage.getItem(`blb_${S.gameId}`);
  if (saved) {
    const data = JSON.parse(saved);
    S.shifts = data.shifts || [];
    S.events = data.events || [];
    S.boxScores = data.boxScores || {};
    S.hGoals = data.hGoals || 0;
    S.aGoals = data.aGoals || 0;
    S.currentShift = S.shifts.length > 0 ? S.shifts[S.shifts.length - 1] : null;
  }
}

// ============ KEYBOARD ============
function handleKeydown(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  
  const keyMap = {s:'Shot',p:'Pass',f:'Faceoff',g:'Goal',z:'Zone',t:'Turnover',o:'Takeaway',v:'Possession',d:'Defensive',x:'Penalty',r:'Rush',n:'Other'};
  
  if (keyMap[e.key.toLowerCase()]) {
    setEvtType(keyMap[e.key.toLowerCase()]);
    e.preventDefault();
  }
  
  if (e.key === 'Enter') {
    logEvent();
    e.preventDefault();
  }
  
  if (e.key === 'Escape') {
    clearEventForm();
  }
  
  if (e.key === '`') {
    setXYMode('puck');
  }
  
  if (e.key === 'h') document.getElementById('evtTeam').value = 'home';
  if (e.key === 'a') document.getElementById('evtTeam').value = 'away';
  if (e.key === 'Tab') {
    const sel = document.getElementById('evtTeam');
    sel.value = sel.value === 'home' ? 'away' : 'home';
    e.preventDefault();
  }
  
  // Number keys for quick add
  if (e.key >= '1' && e.key <= '9' && S.currentShift) {
    const players = [];
    const team = e.ctrlKey ? 'away' : 'home';
    ['F1','F2','F3','D1','D2','G'].forEach(pos => {
      if (S.currentShift[team][pos]) players.push({...S.currentShift[team][pos], team});
    });
    const idx = parseInt(e.key) - 1;
    if (players[idx]) {
      toggleEventPlayer(players[idx].team, players[idx].n, players[idx].name);
    }
    e.preventDefault();
  }
}

// ============ HELPERS ============
function fmtName(name) {
  if (!name) return '';
  const parts = name.split(' ');
  if (parts.length < 2) return name;
  return parts[0][0] + '. ' + parts.slice(1).join(' ');
}

// Initialize
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

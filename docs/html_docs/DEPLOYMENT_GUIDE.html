<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEPLOYMENT_GUIDE - BenchSight</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #7f8c8d; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Monaco', 'Menlo', monospace; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
        pre code { background: none; color: inherit; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #3498db; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        a { color: #3498db; }
        blockquote { border-left: 4px solid #3498db; margin: 0; padding-left: 20px; color: #666; }
        .nav { background: #2c3e50; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        .nav a { color: white; margin-right: 15px; text-decoration: none; }
        .nav a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="INDEX.html">Index</a>
        <a href="DEPLOYMENT_GUIDE.html">Deploy</a>
        <a href="STATS_REFERENCE_COMPLETE.html">Stats</a>
        <a href="DATA_DICTIONARY.html">Data Dict</a>
    </div>
<h1>BenchSight Supabase Deployment Guide</h1>

<h2>Quick Summary</h2>

<p>You have 96 CSV files in <code>data/output/</code>. These need to be:</p>
<p>1. Tables created in Supabase (via SQL)</p>
<p>2. Data loaded (via <code>flexible_loader.py</code>)</p>

<p>---</p>

<h2>Step 1: Prerequisites</h2>

<pre><code><h1>Install Python dependencies</h1>
<p>pip install supabase pandas</p>

<h1>Verify you have the files</h1>
<table>
</table>
</code></pre>

<p>---</p>

<h2>Step 2: Configure Supabase Credentials</h2>

<pre><code><h1>Copy the example config</h1>
<p>cp config/config_local.ini.example config/config_local.ini</p>
</code></pre>

<p>Edit <code>config/config_local.ini</code>:</p>
<pre><code>[supabase]
<p>url = https://YOUR_PROJECT_ID.supabase.co</p>
<p>service_key = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...YOUR_SERVICE_ROLE_KEY</p>

<p>[etl]</p>
<p>batch_size = 500</p>
<p>data_dir = data/output</p>
</code></pre>

<strong>IMPORTANT:</strong> Use the <code>service_role</code> key, NOT the <code>anon</code> key!
<p>- Find it in Supabase Dashboard → Settings → API → Service Role Key</p>

<p>---</p>

<h2>Step 3: Create Tables in Supabase</h2>

<p>Go to Supabase Dashboard → SQL Editor → New Query</p>

<strong>Run in order:</strong>

<h3>3a. Create all 96 tables</h3>
<p>Copy and run: <code>sql/01_CREATE_ALL_TABLES.sql</code></p>

<h3>3b. Fix column types (important!)</h3>
<p>Copy and run: <code>sql/02_TYPE_FIXES.sql</code></p>

<p>This fixes columns like:</p>
<p>- <code>period_number</code>: INTEGER → TEXT (has &quot;OT&quot;, &quot;SO&quot;)</p>
<p>- <code>player_game_number</code>: INTEGER → TEXT (has &quot;FA&quot;)</p>
<p>- <code>norad_experience</code>: INTEGER → TEXT (has &quot;10+&quot;)</p>

<p>---</p>

<h2>Step 4: Load Data</h2>

<h3>Load ALL 96 tables (recommended first time)</h3>
<pre><code>python scripts/flexible_loader.py --scope full --operation replace
</code></pre>

<h3>Or load by category</h3>
<pre><code><h1>Dimensions first</h1>
<p>python scripts/flexible_loader.py --scope category --category dims --operation replace</p>

<h1>Then facts</h1>
<p>python scripts/flexible_loader.py --scope category --category all_facts --operation replace</p>

<h1>Then QA</h1>
<p>python scripts/flexible_loader.py --scope category --category qa --operation replace</p>
</code></pre>

<h3>Or load a single table</h3>
<pre><code>python scripts/flexible_loader.py --scope table --table dim_player --operation replace
<p>python scripts/flexible_loader.py --scope table --table fact_player_game_stats --operation replace</p>
</code></pre>

<p>---</p>

<h2>Step 5: Verify Deployment</h2>

<h3>Check row counts</h3>
<pre><code>python scripts/flexible_loader.py --counts
</code></pre>

<h3>Expected counts (sample)</h3>
<table>
<tr><th>Table</th><th>Rows</th></tr>
<tr><td>dim_player</td><td>337</td></tr>
<tr><td>dim_team</td><td>26</td></tr>
<tr><th>dim_schedule</th><th>562</th></tr>
<tr><th>fact_events</th><th>5,833</th></tr>
<tr><th>fact_shifts</th><th>672</th></tr>
<tr><th>fact_player_game_stats</th><th>107</th></tr>
</table>

<p>---</p>

<h2>Troubleshooting</h2>

<h3>&quot;403 Forbidden&quot;</h3>
<p>- You&#x27;re using <code>anon</code> key instead of <code>service_role</code> key</p>
<p>- Fix: Use service_role key in config_local.ini</p>

<h3>&quot;Column does not exist&quot;</h3>
<p>- Table schema doesn&#x27;t match CSV</p>
<p>- Fix: Run <code>sql/02_TYPE_FIXES.sql</code></p>
<p>- Or check if table was created with wrong columns</p>

<h3>&quot;Duplicate key value violates unique constraint&quot;</h3>
<p>- Data already exists</p>
<p>- Fix: Use <code>--operation replace</code> (truncates first)</p>

<h3>&quot;Table doesn&#x27;t exist&quot;</h3>
<p>- Table not created yet</p>
<p>- Fix: Run <code>sql/01_CREATE_ALL_TABLES.sql</code> in Supabase SQL Editor</p>

<h3>Missing tables in Supabase</h3>
<pre><code><h1>List all tables that should exist</h1>
<p>python scripts/flexible_loader.py --dry-run --scope full</p>

<h1>Load specific missing table</h1>
<p>python scripts/flexible_loader.py --scope table --table YOUR_TABLE --operation replace</p>
</code></pre>

<p>---</p>

<h2>Categories Reference</h2>

<table>
<tr><th>Category</th><th>Tables</th><th>Description</th></tr>
<tr><td><code>dims</code></td><td>44</td><td>Dimension/lookup tables</td></tr>
<tr><td><code>core_facts</code></td><td>11</td><td>Core event/shift tables</td></tr>
<tr><th><code>stats_facts</code></th><th>11</th><th>Player/team statistics</th></tr>
<tr><th><code>analytics_facts</code></th><th>9</th><th>H2H, WOWY, line combos</th></tr>
<tr><th><code>zone_facts</code></th><th>7</th><th>Zone/danger analysis</th></tr>
<tr><th><code>tracking_facts</code></th><th>5</th><th>XY coordinate data</th></tr>
<tr><th><code>other_facts</code></th><th>8</th><th>Video, draft, registration</th></tr>
<tr><th><code>qa</code></th><th>1</th><th>Quality assurance</th></tr>
<tr><th><code>all_facts</code></th><th>51</th><th>All fact tables</th></tr>
<tr><th><code>all</code></th><th>96</th><th>Everything</th></tr>
</table>

<p>---</p>

<h2>Operation Modes</h2>

<table>
<tr><th>Mode</th><th>Behavior</th></tr>
<tr><td><code>replace</code></td><td>TRUNCATE table, then INSERT (clean slate)</td></tr>
<tr><td><code>append</code></td><td>INSERT only (add to existing)</td></tr>
<tr><th><code>upsert</code></th><th>INSERT or UPDATE on conflict</th></tr>
</table>

<strong>Recommended:</strong> Use <code>replace</code> for initial load and full refreshes.

<p>---</p>

<h2>Full Reload Procedure</h2>

<pre><code><h1>1. Truncate all data (optional - replace does this)</h1>
<h1>Run sql/03_TRUNCATE_DATA.sql in Supabase</h1>

<h1>2. Load everything fresh</h1>
<p>python scripts/flexible_loader.py --scope full --operation replace</p>

<h1>3. Verify</h1>
<p>python scripts/flexible_loader.py --counts</p>
</code></pre>

<p>---</p>

<h2>Convenience Scripts</h2>

<h3><code>run_deploy.sh</code> - Deploy to Supabase</h3>
<pre><code><h1>Deploy all tables</h1>
<p>./run_deploy.sh</p>

<h1>With custom options</h1>
<p>./run_deploy.sh --scope table --table dim_player --operation replace</p>

<h1>Check counts</h1>
<p>./run_deploy.sh --counts</p>
</code></pre>

<h3><code>run_etl.sh</code> - Run ETL Pipeline</h3>
<pre><code><h1>Process single game</h1>
<p>./run_etl.sh --game 18969</p>

<h1>Process multiple games</h1>
<p>./run_etl.sh --games 18969,18977,18981</p>

<h1>Export to CSV</h1>
<p>./run_etl.sh --export</p>

<h1>Show status</h1>
<p>./run_etl.sh --status</p>

<h1>List available games</h1>
<p>./run_etl.sh --list-games</p>
</code></pre>

<p>---</p>

<h2>Common Workflows</h2>

<h3>Initial Setup</h3>
<pre><code><h1>1. Configure credentials</h1>
<p>cp config/config_local.ini.example config/config_local.ini</p>
<h1>Edit with your Supabase URL and service_role key</h1>

<h1>2. Create tables in Supabase SQL Editor</h1>
<h1>Run: sql/01_CREATE_ALL_TABLES.sql</h1>
<h1>Run: sql/02_TYPE_FIXES.sql</h1>

<h1>3. Deploy all data</h1>
<p>./run_deploy.sh</p>

<h1>4. Verify</h1>
<p>./run_deploy.sh --counts</p>
</code></pre>

<h3>Add New Game</h3>
<pre><code><h1>1. Place tracking file in data/raw/games/{game_id}/</h1>
<h1>2. Run ETL</h1>
<p>./run_etl.sh --game {game_id}</p>

<h1>3. Re-deploy affected tables</h1>
<p>./run_deploy.sh --scope category --category all_facts --operation replace</p>
</code></pre>

<h3>Full Refresh</h3>
<pre><code><h1>Regenerate all CSVs</h1>
<p>./run_etl.sh --process-all --export</p>

<h1>Reload all data to Supabase</h1>
<p>./run_deploy.sh</p>
</code></pre>

<p>---</p>

<h2>Complete Table List (96 Tables)</h2>

<h3>Load Missing Tables</h3>

<p>If you have missing tables in Supabase:</p>

<pre><code><h1>First create the table in Supabase SQL Editor using sql/01_CREATE_ALL_TABLES.sql</h1>
<h1>Find the CREATE TABLE statement for your missing table and run it</h1>

<h1>Then load the data:</h1>
<p>python scripts/flexible_loader.py --scope table --table TABLE_NAME --operation replace</p>
</code></pre>

<h3>All 44 Dimension Tables</h3>
<pre><code>dim_comparison_type, dim_composite_rating, dim_danger_zone, dim_event_detail,
<p>dim_event_detail_2, dim_event_type, dim_giveaway_type, dim_league,</p>
<p>dim_micro_stat, dim_net_location, dim_pass_type, dim_period,</p>
<p>dim_play_detail, dim_play_detail_2, dim_player, dim_player_role,</p>
<p>dim_playerurlref, dim_position, dim_randomnames, dim_rink_coord,</p>
<p>dim_rinkboxcoord, dim_rinkcoordzones, dim_schedule, dim_season,</p>
<p>dim_shift_slot, dim_shift_start_type, dim_shift_stop_type, dim_shot_type,</p>
<p>dim_situation, dim_stat, dim_stat_category, dim_stat_type,</p>
<p>dim_stoppage_type, dim_strength, dim_success, dim_takeaway_type,</p>
<p>dim_team, dim_terminology_mapping, dim_turnover_quality, dim_turnover_type,</p>
<p>dim_venue, dim_zone, dim_zone_entry_type, dim_zone_exit_type</p>
</code></pre>

<h3>All 51 Fact Tables</h3>
<pre><code>fact_cycle_events, fact_draft, fact_event_chains, fact_events,
<p>fact_events_long, fact_events_player, fact_events_tracking, fact_game_status,</p>
<p>fact_gameroster, fact_goalie_game_stats, fact_h2h, fact_head_to_head,</p>
<p>fact_leadership, fact_league_leaders_snapshot, fact_line_combos, fact_linked_events,</p>
<p>fact_matchup_summary, fact_player_boxscore_all, fact_player_event_chains,</p>
<p>fact_player_game_position, fact_player_game_stats, fact_player_micro_stats,</p>
<p>fact_player_pair_stats, fact_player_period_stats, fact_player_stats_long,</p>
<p>fact_player_xy_long, fact_player_xy_wide, fact_playergames, fact_plays,</p>
<p>fact_possession_time, fact_puck_xy_long, fact_puck_xy_wide, fact_registration,</p>
<p>fact_rush_events, fact_scoring_chances, fact_sequences, fact_shift_players,</p>
<p>fact_shift_quality, fact_shift_quality_logical, fact_shifts, fact_shifts_long,</p>
<p>fact_shifts_player, fact_shifts_tracking, fact_shot_danger, fact_shot_xy,</p>
<p>fact_suspicious_stats, fact_team_game_stats, fact_team_standings_snapshot,</p>
<p>fact_team_zone_time, fact_video, fact_wowy</p>
</code></pre>

<h3>1 QA Table</h3>
<pre><code>qa_suspicious_stats
</code></pre>

</body></html>

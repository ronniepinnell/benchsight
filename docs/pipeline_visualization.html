<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Analytics ETL Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .header p { color: #a0a0a0; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .section h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .key-format {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .key-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        .key-card code {
            font-size: 1.1rem;
            color: #81c784;
        }
        .key-card .prefix {
            font-weight: bold;
            color: #ffb74d;
        }
        
        .table-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
        }
        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
        }
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        .stat-card .label { color: #a0a0a0; }
        
        .mermaid { 
            background: #1e1e2e; 
            padding: 20px; 
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .flow-step .step-num {
            background: #4fc3f7;
            color: #1a1a2e;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .flow-step .step-content h3 { margin-bottom: 5px; }
        .flow-step .step-content p { color: #a0a0a0; font-size: 0.9rem; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { color: #4fc3f7; }
        tr:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèí Hockey Analytics ETL Pipeline</h1>
        <p>Complete Data Processing Flow with Standardized Keys</p>
    </div>
    
    <div class="container">
        <!-- Table Summary -->
        <div class="section">
            <h2>üìä Database Summary</h2>
            <div class="table-summary">
                <div class="stat-card">
                    <div class="number">21</div>
                    <div class="label">Stage Tables</div>
                </div>
                <div class="stat-card">
                    <div class="number">13</div>
                    <div class="label">Intermediate Tables</div>
                </div>
                <div class="stat-card">
                    <div class="number">20</div>
                    <div class="label">Datamart Tables</div>
                </div>
                <div class="stat-card">
                    <div class="number">56</div>
                    <div class="label">Total Tables</div>
                </div>
            </div>
        </div>
        
        <!-- Key Format -->
        <div class="section">
            <h2>üîë Standardized Key Format</h2>
            <p style="margin-bottom: 15px; color: #a0a0a0;">
                All keys follow: <code style="color: #81c784;">{PREFIX}{GAME_ID:05d}{INDEX:05d}</code> = 12 characters
            </p>
            <div class="key-format">
                <div class="key-card">
                    <span class="prefix">EV</span> Event<br>
                    <code>EV1896901000</code>
                </div>
                <div class="key-card">
                    <span class="prefix">SH</span> Shift<br>
                    <code>SH1896900001</code>
                </div>
                <div class="key-card">
                    <span class="prefix">EP</span> Event Player<br>
                    <code>EP1896900001</code>
                </div>
                <div class="key-card">
                    <span class="prefix">GP</span> Game Player<br>
                    <code>GP1896900021</code>
                </div>
                <div class="key-card">
                    <span class="prefix">SQ</span> Sequence<br>
                    <code>SQ1896905001</code>
                </div>
                <div class="key-card">
                    <span class="prefix">PL</span> Play<br>
                    <code>PL1896906001</code>
                </div>
                <div class="key-card">
                    <span class="prefix">LK</span> Linked Event<br>
                    <code>LK1896909001</code>
                </div>
                <div class="key-card">
                    <span class="prefix">XY</span> XY Event<br>
                    <code>XY1896900000</code>
                </div>
                <div class="key-card">
                    <span class="prefix">XS</span> XY Shot<br>
                    <code>XS1896900000</code>
                </div>
                <div class="key-card">
                    <span class="prefix">VD</span> Video<br>
                    <code>VD1896900000</code>
                </div>
            </div>
        </div>
        
        <!-- Execution Flow -->
        <div class="section">
            <h2>‚ö° Execution Flow</h2>
            
            <div class="flow-step">
                <div class="step-num">1</div>
                <div class="step-content">
                    <h3>Load BLB Tables</h3>
                    <p>load_blb_tables.py ‚Üí Creates 14 stg_dim_* and stg_fact_* tables from BLB_Tables.xlsx</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">2</div>
                <div class="step-content">
                    <h3>Load dim_dates</h3>
                    <p>Creates stg_dim_dates (4,747 rows) from dim_dates.csv</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">3</div>
                <div class="step-content">
                    <h3>Transform BLB to Intermediate</h3>
                    <p>transform_blb.py ‚Üí Creates int_dim_player, int_dim_team, int_dim_schedule, int_fact_gameroster</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">4</div>
                <div class="step-content">
                    <h3>Publish Dimensions to Datamart</h3>
                    <p>publish_dimensions.py ‚Üí Creates 15 dim_* tables + 7 static dimensions</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">5</div>
                <div class="step-content">
                    <h3>Load Game Tracking</h3>
                    <p>load_game_tracking.py ‚Üí Creates stg_events_{game_id} and stg_shifts_{game_id}</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">6</div>
                <div class="step-content">
                    <h3>Transform Game with Standardized Keys</h3>
                    <p>transform_game.py ‚Üí Creates int_events, int_event_players, int_shifts, int_game_players with EV, SH, EP, GP, SQ, PL, LK keys</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">7</div>
                <div class="step-content">
                    <h3>Build Box Score</h3>
                    <p>build_box_score.py ‚Üí Aggregates player stats, calculates TOI, per-60 metrics ‚Üí fact_box_score</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">8</div>
                <div class="step-content">
                    <h3>Build Events</h3>
                    <p>build_events.py ‚Üí Publishes int_events to fact_events</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">9</div>
                <div class="step-content">
                    <h3>Generate XY Data</h3>
                    <p>build_enhanced_data.py ‚Üí Creates fact_xy_events (1,594) and fact_xy_shots (181) with rink zone FKs</p>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-num">10</div>
                <div class="step-content">
                    <h3>Generate Video Data</h3>
                    <p>build_enhanced_data.py ‚Üí Creates dim_video (11 records: full game + periods + goals)</p>
                </div>
            </div>
        </div>
        
        <!-- Data Flow Diagram -->
        <div class="section">
            <h2>üìà Data Flow Diagram</h2>
            <div class="mermaid">
flowchart LR
    subgraph SOURCE["SOURCE"]
        BLB["BLB_Tables.xlsx"]
        DATES["dim_dates.csv"]
        GAME["{game_id}_tracking.xlsx"]
    end
    
    subgraph STAGE["STAGE"]
        S1["stg_dim_*"]
        S2["stg_fact_*"]
        S3["stg_events_{gid}"]
        S4["stg_xy_*_{gid}"]
    end
    
    subgraph INT["INTERMEDIATE"]
        I1["int_dim_*"]
        I2["int_events_{gid}<br/>üîë EV keys"]
        I3["int_xy_*_{gid}<br/>üîë XY keys"]
    end
    
    subgraph DM["DATAMART"]
        D1["dim_* (15)"]
        D2["fact_events<br/>fact_box_score"]
        D3["fact_xy_events<br/>fact_xy_shots"]
        D4["dim_video"]
    end
    
    BLB --> S1 & S2
    DATES --> S1
    GAME --> S3
    
    S1 --> I1
    S2 --> I1
    S3 --> I2
    I2 --> S4
    S4 --> I3
    
    I1 --> D1
    I2 --> D2
    I3 --> D3
    I3 --> D4
            </div>
        </div>
        
        <!-- FK Relationships -->
        <div class="section">
            <h2>üîó Foreign Key Relationships</h2>
            <table>
                <thead>
                    <tr>
                        <th>Fact Table</th>
                        <th>Column</th>
                        <th>References</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>fact_events</td>
                        <td>game_id</td>
                        <td>dim_schedule.game_id</td>
                    </tr>
                    <tr>
                        <td>fact_events</td>
                        <td>period</td>
                        <td>dim_period.period_id</td>
                    </tr>
                    <tr>
                        <td>fact_box_score</td>
                        <td>player_id</td>
                        <td>dim_player.player_id</td>
                    </tr>
                    <tr>
                        <td>fact_xy_events</td>
                        <td>event_key</td>
                        <td>fact_events.event_key</td>
                    </tr>
                    <tr>
                        <td>fact_xy_events</td>
                        <td>rink_box_id</td>
                        <td>dim_rink_box.box_id</td>
                    </tr>
                    <tr>
                        <td>fact_xy_events</td>
                        <td>rink_zone_id</td>
                        <td>dim_rink_zone.box_id</td>
                    </tr>
                    <tr>
                        <td>fact_xy_shots</td>
                        <td>event_key</td>
                        <td>fact_events.event_key</td>
                    </tr>
                    <tr>
                        <td>dim_video</td>
                        <td>event_key</td>
                        <td>fact_events.event_key</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark',
            flowchart: { curve: 'basis' }
        });
    </script>
</body>
</html>

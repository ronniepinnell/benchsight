flowchart TB
    subgraph Sources["ğŸ“ Source Data"]
        BLB["BLB_Tables.xlsx<br/>(Master Dimensions)"]
        TR["Game Tracking Files<br/>{game_id}_tracking.xlsx"]
        VT["Video Time Files<br/>{game_id}_video_times.xlsx"]
    end

    subgraph Ingestion["ğŸ”„ Ingestion Layer"]
        BLB_LOAD["load_blb_tables.py"]
        TR_LOAD["tracking_loader.py"]
        VT_LOAD["video_loader.py"]
    end

    subgraph Transform["âš™ï¸ Transform Layer"]
        EVENTS["extract_events.py"]
        SHIFTS["extract_shifts.py"]
        PLUS["plus_minus_calculator.py"]
        SEQ["sequence_builder.py"]
        PLAYS["play_builder.py"]
        RUSH["rush_detector.py"]
        CYCLE["cycle_detector.py"]
        H2H["h2h_wowy_builder.py"]
    end

    subgraph Enrich["âœ¨ Enrichment Layer"]
        FK["fix_dim_mappings.py<br/>(Add FKs)"]
        CHAIN["complete_chain_builder.py<br/>(Play Chains)"]
        STATS["stats_builder.py<br/>(Corsi, xG, etc.)"]
    end

    subgraph Output["ğŸ“Š Output Layer"]
        DIM["Dimension Tables<br/>(20+ tables)"]
        FACT["Fact Tables<br/>(50+ tables)"]
        XY["XY Tables<br/>(5 tables, schema only)"]
    end

    subgraph Consumers["ğŸ¯ Consumers"]
        SUPA["Supabase<br/>PostgreSQL"]
        PBI["Power BI<br/>Dashboards"]
        API["Future API"]
    end

    %% Connections
    BLB --> BLB_LOAD
    TR --> TR_LOAD
    VT --> VT_LOAD

    BLB_LOAD --> DIM
    TR_LOAD --> EVENTS
    TR_LOAD --> SHIFTS
    VT_LOAD --> EVENTS

    EVENTS --> PLUS
    SHIFTS --> PLUS
    EVENTS --> SEQ
    SEQ --> PLAYS
    EVENTS --> RUSH
    EVENTS --> CYCLE
    SHIFTS --> H2H

    PLUS --> FACT
    SEQ --> FACT
    PLAYS --> FACT
    RUSH --> FACT
    CYCLE --> FACT
    H2H --> FACT

    FACT --> FK
    FK --> CHAIN
    CHAIN --> STATS
    STATS --> FACT

    DIM --> SUPA
    FACT --> SUPA
    XY --> SUPA
    SUPA --> PBI
    SUPA --> API

    style Sources fill:#e1f5fe
    style Ingestion fill:#fff3e0
    style Transform fill:#f3e5f5
    style Enrich fill:#e8f5e9
    style Output fill:#fce4ec
    style Consumers fill:#e0f2f1

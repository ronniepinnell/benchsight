%% Hockey Analytics ETL Pipeline - Complete Flow Diagram
%% Render at: https://mermaid.live/

%%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '14px'}}}%%

flowchart TB
    subgraph SOURCE["üìÅ SOURCE FILES"]
        direction TB
        BLB["üìä BLB_Tables.xlsx<br/>(14 sheets)"]
        DATES["üìÖ dim_dates.csv<br/>(4,747 rows)"]
        GAME["üèí {game_id}_tracking.xlsx<br/>(events + shifts)"]
    end

    subgraph STAGE["üîµ STAGE LAYER (stg_*)"]
        direction TB
        
        subgraph STG_DIM["Dimension Tables"]
            SD1["stg_dim_player (335)"]
            SD2["stg_dim_team (26)"]
            SD3["stg_dim_schedule (552)"]
            SD4["stg_dim_dates (4,747)"]
            SD5["stg_dim_rinkboxcoord (50)"]
            SD6["stg_dim_rinkcoordzones (297)"]
        end
        
        subgraph STG_FACT["Fact Tables"]
            SF1["stg_fact_gameroster (14,239)"]
            SF2["stg_fact_draft (160)"]
        end
        
        subgraph STG_GAME["Per-Game Tables"]
            SG1["stg_events_{game_id}"]
            SG2["stg_shifts_{game_id}"]
            SG3["stg_xy_events_{game_id}"]
            SG4["stg_xy_shots_{game_id}"]
            SG5["stg_video_{game_id}"]
        end
    end

    subgraph INTERMEDIATE["üü° INTERMEDIATE LAYER (int_*)"]
        direction TB
        
        subgraph INT_DIM["Dimension Tables"]
            ID1["int_dim_player"]
            ID2["int_dim_team"]
            ID3["int_dim_schedule"]
        end
        
        subgraph INT_FACT["Fact Tables"]
            IF1["int_fact_gameroster"]
        end
        
        subgraph INT_GAME["Per-Game Tables<br/>üîë STANDARDIZED KEYS"]
            IG1["int_events_{game_id}<br/>event_key: EV{gid}{idx}"]
            IG2["int_event_players_{game_id}<br/>event_player_key: EP{gid}{idx}"]
            IG3["int_shifts_{game_id}<br/>shift_key: SH{gid}{idx}"]
            IG4["int_game_players_{game_id}<br/>player_game_key: GP{gid}{idx}"]
            IG5["int_xy_events_{game_id}<br/>xy_event_key: XY{gid}{idx}"]
            IG6["int_xy_shots_{game_id}<br/>xy_shot_key: XS{gid}{idx}"]
            IG7["int_video_{game_id}<br/>video_key: VD{gid}{idx}"]
        end
    end

    subgraph DATAMART["üü¢ DATAMART LAYER"]
        direction TB
        
        subgraph DIM_TABLES["üìê Dimension Tables (15)"]
            DT1["dim_player (335)"]
            DT2["dim_team (26)"]
            DT3["dim_schedule (552)"]
            DT4["dim_dates (4,747)"]
            DT5["dim_seconds (4,800)"]
            DT6["dim_period (5)"]
            DT7["dim_event_type (7)"]
            DT8["dim_strength (9)"]
            DT9["dim_position (8)"]
            DT10["dim_rink_box (50)"]
            DT11["dim_rink_zone (297)"]
            DT12["dim_video (11+)"]
        end
        
        subgraph FACT_TABLES["üìä Fact Tables (5)"]
            FT1["fact_gameroster (13,960)"]
            FT2["fact_box_score (27+)"]
            FT3["fact_events (1,594+)"]
            FT4["fact_xy_events (1,594+)"]
            FT5["fact_xy_shots (181+)"]
        end
    end

    subgraph OUTPUT["üì§ OUTPUT"]
        CSV["üìÅ CSV Files"]
        PBI["üìä Power BI"]
    end

    %% Connections
    BLB --> STG_DIM
    BLB --> STG_FACT
    DATES --> SD4
    GAME --> SG1
    GAME --> SG2
    
    STG_DIM --> INT_DIM
    STG_FACT --> INT_FACT
    SG1 --> IG1
    SG2 --> IG3
    IG1 --> IG2
    IG1 --> IG4
    
    SG1 --> SG3
    SG1 --> SG4
    SG1 --> SG5
    SG3 --> IG5
    SG4 --> IG6
    SG5 --> IG7
    
    INT_DIM --> DIM_TABLES
    INT_FACT --> FT1
    IG1 --> FT3
    IG1 --> FT2
    IG5 --> FT4
    IG6 --> FT5
    IG7 --> DT12
    
    SD5 --> DT10
    SD6 --> DT11
    
    DATAMART --> CSV
    DATAMART --> PBI

    %% Styling
    classDef source fill:#e1f5fe,stroke:#01579b
    classDef stage fill:#e3f2fd,stroke:#1565c0
    classDef intermediate fill:#fff9c4,stroke:#f9a825
    classDef datamart fill:#e8f5e9,stroke:#2e7d32
    classDef output fill:#fce4ec,stroke:#c2185b
    
    class SOURCE source
    class STAGE,STG_DIM,STG_FACT,STG_GAME stage
    class INTERMEDIATE,INT_DIM,INT_FACT,INT_GAME intermediate
    class DATAMART,DIM_TABLES,FACT_TABLES datamart
    class OUTPUT output

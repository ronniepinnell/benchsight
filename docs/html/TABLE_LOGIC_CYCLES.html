<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BenchSight - Cycle Detection Logic</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--light); color: var(--dark); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 2rem; margin-bottom: 2rem; border-radius: 8px; }
        header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        header p { opacity: 0.9; }
        .nav { margin-bottom: 2rem; }
        .nav a { color: var(--primary); text-decoration: none; margin-right: 1rem; }
        .nav a:hover { text-decoration: underline; }
        .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { color: var(--primary); margin-bottom: 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }
        .card h3 { color: var(--secondary); margin: 1rem 0 0.5rem; }
        pre { background: var(--dark); color: #e5e7eb; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.875rem; margin: 1rem 0; }
        code { background: #e5e7eb; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.875rem; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--light); font-weight: 600; }
        tr:hover { background: #f9fafb; }
        .tag { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.25rem; }
        .tag-pk { background: #dbeafe; color: #1e40af; }
        .tag-fk { background: #dcfce7; color: #166534; }
        .tag-derived { background: #fef3c7; color: #92400e; }
        .tag-flag { background: #f3e8ff; color: #7c3aed; }
        .formula-box { background: #eff6ff; border-left: 4px solid var(--primary); padding: 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; }
        .warning-box { background: #fef3c7; border-left: 4px solid var(--warning); padding: 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; }
        .success-box { background: #dcfce7; border-left: 4px solid var(--success); padding: 1rem; margin: 1rem 0; border-radius: 0 4px 4px 0; }
        ul { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
<div style="background:#f0f0f0;padding:10px;margin-bottom:20px;border-bottom:1px solid #ccc;">
<strong>Last Updated:</strong> January 7, 2026| <strong>Version:</strong> 12.03
</div>

<!-- ================================================================== -->
<!-- CHANGELOG - MUST BE UPDATED WITH EVERY MODIFICATION -->
<!-- ================================================================== -->
<!--
CHANGELOG:
---------------------------------------------------------------------------
2026-01-06 v8.0.5:
  - CRITICAL FIX: Restored 4 missing src/advanced/ modules:
    * create_additional_tables.py
    * enhance_all_stats.py
    * final_stats_enhancement.py
    * extended_tables.py
  - Created fact_events_player.csv (7,476 rows)
  - Extended tables now run: +15 tables created
  - Table count: 131 (54 dim, 73 fact, 3 QA, 1 other)
  - Added comprehensive code audit documentation
  - Fixed column name mismatches (Type -> event_type)

2026-01-06 v8.0.4:
  - CRITICAL: Recovered 72 missing tables from v7 backup
  - Table count restored from 53 to 130
  - Created 4 new outcome dimension tables
  - Regenerated ERD with all tables
  - Added table integrity tests

2026-01-05 v8.0.0:
  - Major schema expansion: 96 -> 111 tables planned
  - Added 317 player metrics
  - Created comprehensive foreign key relationships
  - Added QA validation tables

RULES FOR UPDATING THIS CHANGELOG:
1. ALWAYS add entry BEFORE making changes
2. Include: date, version, what changed, table counts
3. Never delete old entries
4. Be specific about what was added/changed/removed
---------------------------------------------------------------------------
-->

    <div class="container">
        <header>
            <h1>üîÑ Cycle Detection Logic</h1>
            <p>BenchSight v16.08 - Offensive Zone Cycle Analysis</p>
        </header>

        <div class="nav">
            <a href="index.html">‚Üê Back to Documentation Hub</a>
            <a href="../index.html">Main Index</a>
            <a href="TABLE_LOGIC_EVENTS.html">Events Logic</a>
            <a href="TABLE_LOGIC_SHIFTS.html">Shifts Logic</a>
        </div>

        <div class="card">
            <h2>üìñ Definition</h2>
            <div class="formula-box">
                <strong>Offensive Zone Cycle:</strong> A sequence of 3+ consecutive passes by the same team while maintaining possession in the offensive zone.
            </div>
            <h3>Cycle Characteristics</h3>
            <ul>
                <li><strong>Minimum passes:</strong> 3 (to qualify as a cycle)</li>
                <li><strong>Zone:</strong> Offensive zone only (event_team_zone = 'o')</li>
                <li><strong>Team continuity:</strong> Same team must maintain possession</li>
                <li><strong>Event types included:</strong> Pass, Possession</li>
            </ul>
        </div>

        <div class="card">
            <h2>üîç Zone Inference Algorithm</h2>
            <p>Not all games have explicit <code>event_team_zone</code> data. The algorithm infers zones from Zone_Entry/Exit events:</p>
            
            <pre>
# Zone inference from Zone_Entry_Exit events
for each event in game (chronological order):
    if event_team_zone is explicit ('o', 'd', 'n'):
        team_zones[team] = explicit_zone
    elif event_type == 'Zone_Entry_Exit':
        if event_detail in ['Zone_Entry', 'Zone_Keepin']:
            team_zones[team] = 'o'  # Now in offensive zone
        elif event_detail == 'Zone_Exit':
            team_zones[team] = 'n'  # Exited to neutral zone
    else:
        use last known zone for team (default: 'n')
            </pre>

            <div class="warning-box">
                <strong>Note:</strong> Zone inference enables cycle detection across all games, even when explicit zone data is missing (e.g., games 18977, 18981, 18987 had 0-38% zone fill rate).
            </div>
        </div>

        <div class="card">
            <h2>‚ö° Cycle Detection Algorithm</h2>
            <pre>
def detect_cycles(game_events):
    current_cycle_events = []
    current_cycle_passes = 0
    current_team = None
    
    for event in game_events:
        zone = infer_zone(event)
        
        # Not in offensive zone - end cycle if qualifying
        if zone != 'o':
            if current_cycle_passes >= 3:
                save_cycle(current_cycle_events, 'zone_change')
            reset_cycle()
            continue
        
        # In offensive zone
        if event_type in ['Pass', 'Possession']:
            if same_team_or_new:
                add_to_cycle(event)
                if event_type == 'Pass':
                    current_cycle_passes += 1
            else:
                # Team changed - end current cycle
                if current_cycle_passes >= 3:
                    save_cycle(current_cycle_events, 'possession_change')
                start_new_cycle(event)
        
        elif event_type in CYCLE_ENDERS:
            # Shot, Goal, Turnover, etc.
            if same_team and event_type in ['Shot', 'Goal']:
                add_to_cycle(event)  # Include shot in cycle
            if current_cycle_passes >= 3:
                save_cycle(current_cycle_events, event_type)
            reset_cycle()
            </pre>

            <h3>Cycle Ending Events</h3>
            <table>
                <tr><th>Event Type</th><th>ended_with Value</th><th>Description</th></tr>
                <tr><td>Shot</td><td><code>shot</code></td><td>Cycle ended with shot attempt (included in cycle)</td></tr>
                <tr><td>Goal</td><td><code>goal</code></td><td>Cycle ended with goal (included in cycle)</td></tr>
                <tr><td>Turnover</td><td><code>turnover</code></td><td>Lost possession via giveaway/takeaway</td></tr>
                <tr><td>Zone_Entry_Exit</td><td><code>zone_entry_exit</code></td><td>Puck left offensive zone</td></tr>
                <tr><td>Stoppage</td><td><code>stoppage</code></td><td>Whistle stopped play</td></tr>
                <tr><td>Zone change</td><td><code>zone_change</code></td><td>Inferred zone changed to non-offensive</td></tr>
                <tr><td>Possession change</td><td><code>possession_change</code></td><td>Other team gained possession</td></tr>
            </table>
        </div>

        <div class="card">
            <h2>üìä fact_cycle_events Schema</h2>
            <table>
                <tr><th>Column</th><th>Type</th><th>Tags</th><th>Description</th></tr>
                <tr><td>cycle_key</td><td>string</td><td><span class="tag tag-pk">PK</span></td><td>CY{game_id}{counter:04d} e.g., CY189690001</td></tr>
                <tr><td>game_id</td><td>int</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_schedule</td></tr>
                <tr><td>season_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_season</td></tr>
                <tr><td>team_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_team (team that cycled)</td></tr>
                <tr><td>team_name</td><td>string</td><td></td><td>Team name (denormalized)</td></tr>
                <tr><td>home_team_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_team</td></tr>
                <tr><td>away_team_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_team</td></tr>
                <tr><td>pass_count</td><td>int</td><td><span class="tag tag-derived">derived</span></td><td>Number of passes in cycle (‚â•3)</td></tr>
                <tr><td>event_count</td><td>int</td><td><span class="tag tag-derived">derived</span></td><td>Total events in cycle</td></tr>
                <tr><td>player_count</td><td>int</td><td><span class="tag tag-derived">derived</span></td><td>Unique players involved</td></tr>
                <tr><td>start_event_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí fact_events (first event)</td></tr>
                <tr><td>end_event_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí fact_events (last event)</td></tr>
                <tr><td>start_time</td><td>float</td><td></td><td>Running video time (seconds)</td></tr>
                <tr><td>end_time</td><td>float</td><td></td><td>Running video time (seconds)</td></tr>
                <tr><td>duration_seconds</td><td>float</td><td><span class="tag tag-derived">derived</span></td><td>end_time - start_time</td></tr>
                <tr><td>ended_with</td><td>string</td><td></td><td>How cycle ended (shot, turnover, etc.)</td></tr>
                <tr><td>ended_with_shot</td><td>int</td><td><span class="tag tag-flag">flag</span></td><td>1 if ended with shot or goal</td></tr>
                <tr><td>ended_with_goal</td><td>int</td><td><span class="tag tag-flag">flag</span></td><td>1 if ended with goal</td></tr>
                <tr><td>event_ids</td><td>string</td><td></td><td>Comma-separated event IDs in cycle</td></tr>
                <tr><td>player_ids</td><td>string</td><td></td><td>Comma-separated player IDs</td></tr>
                <tr><td>period</td><td>int</td><td></td><td>Period number</td></tr>
                <tr><td>period_id</td><td>string</td><td><span class="tag tag-fk">FK</span></td><td>‚Üí dim_period</td></tr>
            </table>
        </div>

        <div class="card">
            <h2>üîó Related Updates</h2>
            <h3>fact_events</h3>
            <ul>
                <li><code>cycle_key</code> - FK to fact_cycle_events (NULL if not in cycle)</li>
                <li><code>is_cycle</code> - Flag: 1 if event is part of a cycle</li>
            </ul>
            
            <h3>fact_event_players</h3>
            <ul>
                <li><code>cycle_key</code> - FK to fact_cycle_events</li>
                <li><code>is_cycle</code> - Flag: 1 if event is part of a cycle</li>
            </ul>

            <div class="success-box">
                <strong>Usage:</strong> To get all events in cycles, filter <code>WHERE is_cycle = 1</code> or <code>WHERE cycle_key IS NOT NULL</code>
            </div>
        </div>

        <div class="card">
            <h2>üìà Statistics (v8.0.3)</h2>
            <table>
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Total cycles detected</td><td>32</td></tr>
                <tr><td>Games covered</td><td>4 of 4 (100%)</td></tr>
                <tr><td>Avg passes per cycle</td><td>3.4</td></tr>
                <tr><td>Avg duration</td><td>10.8 seconds</td></tr>
                <tr><td>Avg events per cycle</td><td>6.4</td></tr>
                <tr><td>Avg players per cycle</td><td>3.1</td></tr>
                <tr><td>Shot generation rate</td><td>17/32 (53%)</td></tr>
                <tr><td>Goal generation rate</td><td>0/32 (0%)</td></tr>
            </table>

            <h3>Per-Game Breakdown</h3>
            <table>
                <tr><th>Game</th><th>Cycles</th><th>Avg Passes</th><th>Shots</th></tr>
                <tr><td>18969</td><td>7</td><td>3.4</td><td>6</td></tr>
                <tr><td>18977</td><td>10</td><td>3.2</td><td>4</td></tr>
                <tr><td>18981</td><td>7</td><td>3.1</td><td>4</td></tr>
                <tr><td>18987</td><td>8</td><td>3.9</td><td>3</td></tr>
            </table>
        </div>

        <div class="card">
            <h2>üíª ETL Implementation</h2>
            <p>Location: <code>src/core/base_etl.py</code></p>
            <ul>
                <li><code>_build_cycle_events()</code> - Main cycle detection function</li>
                <li><code>_make_cycle_record()</code> - Helper to build cycle records</li>
            </ul>
            <p>Called during Phase 5.6 (Enhance Derived Event Tables), after fact_linked_events processing.</p>
        </div>

        <footer style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center; color: #6b7280;">
            <p>BenchSight Hockey Analytics Platform ‚Ä¢ v16.08 ‚Ä¢ Generated January 2026</p>
        </footer>
    </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TABLE LOGIC RATINGS</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
               max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #1a1a2e; border-bottom: 2px solid #4a4a8a; padding-bottom: 10px; }
        h2 { color: #2a2a4e; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
        h3 { color: #3a3a5e; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4a4a8a; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
        pre code { background: transparent; color: inherit; }
        a { color: #4a4a8a; }
        .nav { background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        .nav a { margin-right: 15px; }
    </style>
</head>
<body>

<!-- ================================================================== -->
<!-- CHANGELOG - MUST BE UPDATED WITH EVERY MODIFICATION -->
<!-- ================================================================== -->
<!--
CHANGELOG:
---------------------------------------------------------------------------
2026-01-06 v8.0.5:
  - CRITICAL FIX: Restored 4 missing src/advanced/ modules:
    * create_additional_tables.py
    * enhance_all_stats.py
    * final_stats_enhancement.py
    * extended_tables.py
  - Created fact_events_player.csv (7,476 rows)
  - Extended tables now run: +15 tables created
  - Table count: 131 (54 dim, 73 fact, 3 QA, 1 other)
  - Added comprehensive code audit documentation
  - Fixed column name mismatches (Type -> event_type)

2026-01-06 v8.0.4:
  - CRITICAL: Recovered 72 missing tables from v7 backup
  - Table count restored from 53 to 130
  - Created 4 new outcome dimension tables
  - Regenerated ERD with all tables
  - Added table integrity tests

2026-01-05 v8.0.0:
  - Major schema expansion: 96 -> 111 tables planned
  - Added 317 player metrics
  - Created comprehensive foreign key relationships
  - Added QA validation tables

RULES FOR UPDATING THIS CHANGELOG:
1. ALWAYS add entry BEFORE making changes
2. Include: date, version, what changed, table counts
3. Never delete old entries
4. Be specific about what was added/changed/removed
---------------------------------------------------------------------------
-->

<div class="nav">
    <a href="index.html">Home</a>
    <a href="DATA_DICTIONARY.html">Data Dictionary</a>
    <a href="LLM_HANDOFF.html">LLM Handoff</a>
    <a href="TABLE_LOGIC_EVENTS.html">Events Logic</a>
    <a href="TABLE_LOGIC_SHIFTS.html">Shifts Logic</a>
    <a href="TABLE_LOGIC_RATINGS.html">Ratings Logic</a>
    <a href="CHANGELOG.html">Changelog</a>
</div>
<p><h1>Rating-Adjusted Analytics - Logic & Documentation</h1></p>
<p><strong>Last Updated:</strong> January 7, 2026<strong>Version:</strong> 12.03</p>
<p>---</p>
<p><h2>Overview</h2></p>
<p>Rating-adjusted analytics account for the quality of competition when evaluating player performance. A goal against a 5-rated team is worth more than against a 2-rated team.</p>
<p>---</p>
<p><h2>Rating Scale</h2></p>
<p><table>
<tr><th>Rating</th><th>Name</th><th>Description</th></tr>
<tr><td>2</td><td>Beginner</td><td>Entry level player</td></tr>
<tr><td>3</td><td>Developing</td><td>Below average</td></tr>
<tr><td>4</td><td>Average</td><td>League average (baseline)</td></tr>
<tr><td>5</td><td>Skilled</td><td>Above average</td></tr>
<tr><td>6</td><td>Elite</td><td>Top tier player</td></tr>
</table></p>
<p><strong>Mean Rating:</strong> 3.84 (slightly below average)
<strong>Baseline for Adjustments:</strong> 4.0</p>
<p>---</p>
<p><h2>Core Concepts</h2></p>
<p><h3>1. Opponent Multiplier</h3></p>
<p>The multiplier adjusts raw stats based on opponent quality:</p>
<p><pre><code>BASELINE_RATING = 4.0
opp_multiplier = opponent_avg_rating / BASELINE_RATING</p>
<p><h1>Examples:</h1>
<h1>vs 5.0 rated opponents: multiplier = 1.25 (25% bonus)</h1>
<h1>vs 4.0 rated opponents: multiplier = 1.00 (baseline)</h1>
<h1>vs 3.0 rated opponents: multiplier = 0.75 (25% penalty)</h1>
<h1>vs 2.5 rated opponents: multiplier = 0.625 (37.5% penalty)</h1></code></pre></p>
<p><h3>2. Adjusted Stats</h3></p>
<p><strong>For "For" stats (goals for, corsi for, etc.):</strong>
<pre><code>stat_adj = stat_raw × opp_multiplier</code></pre>
Scoring against better teams gives a bonus.</p>
<p><strong>For "Against" stats (goals against, corsi against, etc.):</strong>
<pre><code>stat_adj = stat_raw / opp_multiplier</code></pre>
Allowing goals against better teams is less penalized.</p>
<p><h3>3. Competition Tier</h3></p>
<p><table>
<tr><th>Tier ID</th><th>Name</th><th>Opponent Avg Rating</th></tr>
<tr><td>CT01</td><td>Elite</td><td>5.0+</td></tr>
<tr><td>CT02</td><td>Strong</td><td>4.0 - 5.0</td></tr>
<tr><td>CT03</td><td>Average</td><td>3.0 - 4.0</td></tr>
<tr><td>CT04</td><td>Weak</td><td>< 3.0</td></tr>
</table></p>
<p><h3>4. Matchup Category</h3></p>
<p><table>
<tr><th>ID</th><th>Name</th><th>Rating Differential</th></tr>
<tr><td>RM01</td><td>Dominated</td><td>< -1.5</td></tr>
<tr><td>RM02</td><td>Disadvantage</td><td>-1.5 to -0.5</td></tr>
<tr><td>RM03</td><td>Even</td><td>-0.5 to 0.5</td></tr>
<tr><td>RM04</td><td>Advantage</td><td>0.5 to 1.5</td></tr>
<tr><td>RM05</td><td>Dominant</td><td>> 1.5</td></tr>
</table></p>
<p><h3>5. Expected Models</h3></p>
<p><strong>Expected CF%:</strong>
<pre><code>expected_cf_pct = 50 + (rating_differential × 5)
<h1>Each +1.0 rating advantage = +5% expected CF%</h1></code></pre></p>
<p><strong>Expected Plus/Minus:</strong>
<pre><code>expected_pm = rating_advantage × 0.5
<h1>Each +1.0 rating advantage = +0.5 expected +/-</h1></code></pre></p>
<p><strong>Performance vs Expected:</strong>
<pre><code>cf_pct_vs_expected = actual_cf_pct - expected_cf_pct
pm_vs_expected = actual_pm - expected_pm</p>
<p><h1>Over/Under flag:</h1>
if pm_vs_expected > 0.5: "Over"
elif pm_vs_expected < -0.5: "Under"
else: "Expected"</code></pre></p>
<p>---</p>
<p><h2>Rating Columns by Table</h2></p>
<p><h3>fact_shifts (39 new columns)</h3></p>
<p><strong>Rating Context:</strong>
<table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>home_skater_count</td><td>Number of home skaters with ratings</td></tr>
<tr><td>home_rating_sum</td><td>Sum of home skater ratings</td></tr>
<tr><td>home_rating_avg</td><td>Average home skater rating</td></tr>
<tr><td>home_rating_min</td><td>Min home skater rating</td></tr>
<tr><td>home_rating_max</td><td>Max home skater rating</td></tr>
<tr><td>home_goalie_rating</td><td>Home goalie rating (separate)</td></tr>
<tr><td>away_*</td><td>Same for away team</td></tr>
</table></p>
<p><strong>Derived:</strong>
<table>
<tr><th>Column</th><th>Calculation</th></tr>
<tr><td>rating_differential</td><td>home_rating_avg - away_rating_avg</td></tr>
<tr><td>home_competition_tier_id</td><td>Based on away_rating_avg</td></tr>
<tr><td>home_matchup_id</td><td>Based on rating_differential</td></tr>
<tr><td>home_opp_multiplier</td><td>away_rating_avg / 4.0</td></tr>
</table></p>
<p><strong>Adjusted Stats (per team):</strong>
<table>
<tr><th>Column</th><th>Formula</th></tr>
<tr><td>home_gf_adj</td><td>home_gf_all × home_opp_multiplier</td></tr>
<tr><td>home_ga_adj</td><td>home_ga_all / home_opp_multiplier</td></tr>
<tr><td>home_pm_adj</td><td>home_gf_adj - home_ga_adj</td></tr>
<tr><td>home_cf_adj</td><td>cf × home_opp_multiplier</td></tr>
<tr><td>home_ca_adj</td><td>ca / home_opp_multiplier</td></tr>
<tr><td>home_cf_pct_adj</td><td>home_cf_adj / (home_cf_adj + home_ca_adj)</td></tr>
<tr><td>home_scf_adj, home_sca_adj</td><td>Scoring chances adjusted</td></tr>
<tr><td>home_hdf_adj, home_hda_adj</td><td>High danger adjusted</td></tr>
</table></p>
<p><h3>fact_events (17 new columns)</h3></p>
<p><table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>player_rating</td><td>Primary player (event_player_1) rating</td></tr>
<tr><td>player_2_rating</td><td>Secondary player rating</td></tr>
<tr><td>event_team_rating_count</td><td>Players on event team</td></tr>
<tr><td>event_team_rating_avg/min/max</td><td>Event team stats</td></tr>
<tr><td>opp_team_rating_count</td><td>Opponents on ice</td></tr>
<tr><td>opp_team_rating_avg/min/max</td><td>Opponent stats</td></tr>
<tr><td>rating_advantage</td><td>player_rating - opp_team_rating_avg</td></tr>
<tr><td>team_rating_differential</td><td>event_team_avg - opp_team_avg</td></tr>
<tr><td>event_competition_tier_id</td><td>Based on opp_team_rating_avg</td></tr>
<tr><td>event_matchup_id</td><td>Based on rating_advantage</td></tr>
<tr><td>event_opp_multiplier</td><td>opp_team_rating_avg / 4.0</td></tr>
</table></p>
<p><h3>fact_shift_players (21 new columns)</h3></p>
<p><table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>player_rating</td><td>This player's rating</td></tr>
<tr><td>teammate_avg_rating</td><td>Avg of 5 other skaters (same team)</td></tr>
<tr><td>opp_avg_rating</td><td>Avg of 6 opposing skaters</td></tr>
<tr><td>team_rating_avg</td><td>Full team average</td></tr>
<tr><td>team_goalie_rating</td><td>Own goalie rating</td></tr>
<tr><td>opp_goalie_rating</td><td>Opposing goalie rating</td></tr>
<tr><td>rating_advantage</td><td>player_rating - opp_avg_rating</td></tr>
<tr><td>rating_differential</td><td>team_avg - opp_avg</td></tr>
<tr><td>competition_tier_id</td><td>FK to dim_competition_tier</td></tr>
<tr><td>matchup_id</td><td>FK to dim_rating_matchup</td></tr>
<tr><td>opp_multiplier</td><td>For adjusted calculations</td></tr>
<tr><td>gf_adj, ga_adj, pm_adj</td><td>Adjusted goals</td></tr>
<tr><td>cf_adj, ca_adj, cf_pct_adj</td><td>Adjusted Corsi</td></tr>
<tr><td>scf_adj, sca_adj</td><td>Adjusted scoring chances</td></tr>
<tr><td>hdf_adj, hda_adj</td><td>Adjusted high danger</td></tr>
</table></p>
<p><h3>fact_shift_quality_logical (24 new columns)</h3></p>
<p><table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>player_rating</td><td>Player's rating</td></tr>
<tr><td>avg_teammate_rating</td><td>Avg QoT for game</td></tr>
<tr><td>avg_opp_rating</td><td>Avg QoC for game</td></tr>
<tr><td>avg_rating_advantage</td><td>Avg advantage faced</td></tr>
<tr><td>avg_opp_multiplier</td><td>Avg multiplier</td></tr>
<tr><td>qoc</td><td>Quality of Competition (= avg_opp_rating)</td></tr>
<tr><td>qot</td><td>Quality of Teammates (= avg_teammate_rating)</td></tr>
<tr><td>gf_adj, ga_adj, pm_adj</td><td>Game totals adjusted</td></tr>
<tr><td>cf_adj, ca_adj, cf_pct_adj</td><td>Corsi adjusted</td></tr>
<tr><td>gf_adj_per_60, cf_adj_per_60</td><td>Adjusted per-60 rates</td></tr>
<tr><td>expected_pm</td><td>Based on rating_advantage</td></tr>
<tr><td>pm_vs_expected</td><td>actual - expected</td></tr>
<tr><td>performance_vs_expected</td><td>Over/Under/Expected flag</td></tr>
<tr><td>avg_quality_score_adj</td><td>Adjusted quality score</td></tr>
</table></p>
<p>---</p>
<p><h2>New Analytics Tables</h2></p>
<p><h3>fact_player_stats_by_competition_tier (240 rows)</h3></p>
<p><strong>Grain:</strong> Player × Game × Competition Tier</p>
<p>Stats broken down by opponent quality tier (CT01-CT04).</p>
<p><table>
<tr><th>Key Columns</th><th>Description</th></tr>
<tr><td>competition_tier_id</td><td>CT01 (Elite) to CT04 (Weak)</td></tr>
<tr><td>toi_seconds</td><td>Time against this tier</td></tr>
<tr><td>gf_all, ga_all, pm_all</td><td>Raw stats vs tier</td></tr>
<tr><td>gf_adj, ga_adj, pm_adj</td><td>Adjusted stats</td></tr>
<tr><td>cf, ca, cf_pct</td><td>Corsi vs tier</td></tr>
<tr><td>cf_adj, ca_adj, cf_pct_adj</td><td>Adjusted Corsi</td></tr>
</table></p>
<p><strong>Use Case:</strong> "How does Player X perform against elite vs weak competition?"</p>
<p><h3>fact_player_qoc_summary (105 rows)</h3></p>
<p><strong>Grain:</strong> Player × Game</p>
<p>TOI-weighted Quality of Competition/Teammates.</p>
<p><table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>qoc_weighted</td><td>TOI-weighted opponent rating</td></tr>
<tr><td>qot_weighted</td><td>TOI-weighted teammate rating</td></tr>
<tr><td>min/max_opp_rating</td><td>Range of opponents faced</td></tr>
<tr><td>min/max_teammate_rating</td><td>Range of linemates</td></tr>
<tr><td>qoc_range</td><td>max - min opponent rating</td></tr>
<tr><td>primary_competition_tier_id</td><td>Most common tier faced</td></tr>
</table></p>
<p><strong>Use Case:</strong> "Who faces the toughest matchups on the team?"</p>
<p><h3>fact_matchup_performance (265 rows)</h3></p>
<p><strong>Grain:</strong> Player × Game × Matchup Type</p>
<p>Performance broken down by matchup category.</p>
<p><table>
<tr><th>Column</th><th>Description</th></tr>
<tr><td>matchup_id</td><td>RM01-RM05</td></tr>
<tr><td>rating_advantage</td><td>Avg advantage in these shifts</td></tr>
<tr><td>cf_pct</td><td>Actual CF% in matchup type</td></tr>
<tr><td>expected_cf_pct</td><td>Expected based on matchup</td></tr>
<tr><td>cf_pct_vs_expected</td><td>Over/under performance</td></tr>
</table></p>
<p><strong>Use Case:</strong> "Does Player X perform better when at advantage vs disadvantage?"</p>
<p>---</p>
<p><h2>Quality of Competition (QoC) Analysis</h2></p>
<p>QoC measures the average rating of opponents a player faces.</p>
<p><strong>High QoC:</strong> Player faces tough assignments (defensive role)
<strong>Low QoC:</strong> Player faces easier matchups (sheltered role)</p>
<p><strong>Calculation:</strong>
<pre><code><h1>Simple average</h1>
qoc_simple = mean(opponent_ratings_per_shift)</p>
<p><h1>TOI-weighted (more accurate)</h1>
qoc_weighted = sum(opponent_rating × shift_duration) / total_toi</code></pre></p>
<p><h2>Quality of Teammates (QoT) Analysis</h2></p>
<p>QoT measures the average rating of linemates.</p>
<p><strong>High QoT:</strong> Player plays with good linemates (boosted by environment)
<strong>Low QoT:</strong> Player elevates weaker linemates (carries the line)</p>
<p>---</p>
<p><h2>Goalie Rating Treatment</h2></p>
<p>Goalie ratings are tracked <strong>separately</strong> from skater ratings:
- <code>home_goalie_rating</code> / <code>away_goalie_rating</code>
- <code>team_goalie_rating</code> / <code>opp_goalie_rating</code></p>
<p><strong>Why separate?</strong>
1. Goalies don't contribute to skater matchups
2. Goalie quality affects save expectations differently
3. Cleaner analytics for skater-vs-skater comparisons</p>
<p>---</p>
<p><h2>FK Relationships</h2></p>
<p><pre><code>fact_shifts
    ├── home_competition_tier_id → dim_competition_tier
    ├── away_competition_tier_id → dim_competition_tier
    ├── home_matchup_id → dim_rating_matchup
    └── away_matchup_id → dim_rating_matchup</p>
<p>fact_shift_players
    ├── competition_tier_id → dim_competition_tier
    └── matchup_id → dim_rating_matchup</p>
<p>fact_events
    ├── event_competition_tier_id → dim_competition_tier
    └── event_matchup_id → dim_rating_matchup</code></pre></p>
<p>---</p>
<p><h2>Future Enhancements</h2></p>
<p>1. <strong>Calibrated Expected Models:</strong> Use historical data to tune expected goal rates
2. <strong>Position-Weighted Ratings:</strong> Weight defensemen differently than forwards
3. <strong>Hot/Cold Adjustments:</strong> Recent form vs season rating
4. <strong>Goalie-Adjusted Expected Goals:</strong> Account for opposing goalie quality
5. <strong>Shift-by-Shift Expected:</strong> xG per shift based on matchup
</p>
</body>
</html>
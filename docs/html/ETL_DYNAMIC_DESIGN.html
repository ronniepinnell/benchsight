<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ETL DYNAMIC DESIGN</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
               max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #1a1a2e; border-bottom: 2px solid #4a4a8a; padding-bottom: 10px; }
        h2 { color: #2a2a4e; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
        h3 { color: #3a3a5e; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4a4a8a; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; }
        pre code { background: transparent; color: inherit; }
        a { color: #4a4a8a; }
        .nav { background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        .nav a { margin-right: 15px; }
    </style>
</head>
<body>

<!-- ================================================================== -->
<!-- CHANGELOG - MUST BE UPDATED WITH EVERY MODIFICATION -->
<!-- ================================================================== -->
<!--
CHANGELOG:
---------------------------------------------------------------------------
2026-01-06 v8.0.5:
  - CRITICAL FIX: Restored 4 missing src/advanced/ modules:
    * create_additional_tables.py
    * enhance_all_stats.py
    * final_stats_enhancement.py
    * extended_tables.py
  - Created fact_events_player.csv (7,476 rows)
  - Extended tables now run: +15 tables created
  - Table count: 131 (54 dim, 73 fact, 3 QA, 1 other)
  - Added comprehensive code audit documentation
  - Fixed column name mismatches (Type -> event_type)

2026-01-06 v8.0.4:
  - CRITICAL: Recovered 72 missing tables from v7 backup
  - Table count restored from 53 to 130
  - Created 4 new outcome dimension tables
  - Regenerated ERD with all tables
  - Added table integrity tests

2026-01-05 v8.0.0:
  - Major schema expansion: 96 -> 111 tables planned
  - Added 317 player metrics
  - Created comprehensive foreign key relationships
  - Added QA validation tables

RULES FOR UPDATING THIS CHANGELOG:
1. ALWAYS add entry BEFORE making changes
2. Include: date, version, what changed, table counts
3. Never delete old entries
4. Be specific about what was added/changed/removed
---------------------------------------------------------------------------
-->

<div class="nav">
    <a href="index.html">Home</a>
    <a href="DATA_DICTIONARY.html">Data Dictionary</a>
    <a href="LLM_HANDOFF.html">LLM Handoff</a>
    <a href="TABLE_LOGIC_EVENTS.html">Events Logic</a>
    <a href="TABLE_LOGIC_SHIFTS.html">Shifts Logic</a>
    <a href="TABLE_LOGIC_RATINGS.html">Ratings Logic</a>
    <a href="CHANGELOG.html">Changelog</a>
</div>
<p><h1>BenchSight ETL Dynamic Design</h1></p>
<p><strong>Last Updated:</strong> January 7, 2026<strong>Version:</strong> 12.03</p>
<p><h2>Overview</h2></p>
<p>The BenchSight ETL is designed to be fully dynamic and work with any new games without code changes.</p>
<p><h2>Dynamic Components</h2></p>
<p><h3>1. Game Discovery</h3>
Games are automatically discovered from <code>data/raw/games/</code> folder:</p>
<p><pre><code>VALID_TRACKING_GAMES, EXCLUDED_GAMES = discover_games()</code></pre></p>
<p>- Scans all subdirectories in <code>data/raw/games/</code>
- Validates each game has complete tracking data
- Excluded games listed in <code>config/excluded_games.txt</code></p>
<p><h3>2. Key Generation</h3>
All keys are generated dynamically based on data:</p>
<p><pre><code><h1>Format: {PREFIX}{game_id}{index:05d}</h1>
format_key('EV', game_id, event_index)  # Works for any game</code></pre></p>
<p><h3>3. FK Lookups</h3>
Foreign key mappings are built dynamically from dimension tables:</p>
<p><pre><code><h1>Built from dim_event_type.csv, dim_event_detail.csv, etc.</h1>
lookups = build_fk_lookups(output_dir)</code></pre></p>
<p><h3>4. Data Normalization</h3>
Applied generically to all code values:</p>
<p><pre><code>normalize_code(value)  # Converts - to _, fixes typos
normalize_dataframe_codes(df)  # Applies to all code columns</code></pre></p>
<p><h2>Intentional Constants (Domain Logic)</h2></p>
<p>These are <strong>not</strong> hard-coded data but domain logic:</p>
<p><h3>Sequence End Events</h3>
<pre><code>SEQUENCE_END_EVENTS = ['Stoppage', 'Goal', 'Penalty', 'GameEnd', 
                       'Intermission', 'DeadIce', 'Timeout', 'Clockstop']</code></pre>
Events that end a whistle-to-whistle sequence.</p>
<p><h3>Play End Details</h3>
<pre><code>PLAY_END_DETAILS = ['Turnover_Giveaway', 'Turnover_Takeaway', 
                    'Zone_Entry', 'Zone_Exit', 'Zone_Entryfailed', 'Zone_ExitFailed']</code></pre>
Event details that end a possession/zone play.</p>
<p><h2>Configuration Files</h2></p>
<p><h3>config/excluded_games.txt</h3>
Lists games to exclude from ETL (incomplete data):
<pre><code><h1>Games with incomplete tracking data</h1>
18965
18993
19032</code></pre></p>
<p>Add new game IDs here to exclude them.</p>
<p><h2>Adding New Games</h2></p>
<p>1. Create folder: <code>data/raw/games/{game_id}/</code>
2. Add tracking file: <code>{game_id}_tracking.xlsx</code>
3. Run ETL: <code>python3 -m src.core.base_etl</code></p>
<p>The ETL will automatically:
- Discover the new game
- Generate all keys
- Create all FK relationships
- Validate output</p>
<p><h2>No Hard-Coded Values</h2></p>
<p>The ETL contains <strong>no</strong>:
- ❌ Hard-coded game IDs (except examples in docstrings)
- ❌ Hard-coded team names or IDs
- ❌ Hard-coded player names or IDs
- ❌ Hard-coded file paths (all use Path objects)
- ❌ One-off patch scripts (archived to <code>scripts/archive/</code>)</p>
<p><h2>Archived Scripts</h2></p>
<p>One-off migration scripts moved to <code>scripts/archive/</code>:
- <code>standardize_event_dim_tables.py</code> - Logic now in ETL
- <code>standardize_fact_event_codes.py</code> - Logic now in ETL</p>
<p>These are kept for reference but no longer needed.
</p>
</body>
</html>
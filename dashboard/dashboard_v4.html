<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BenchSight Analytics Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0d1117; --bg2: #161b22; --bg3: #21262d; --border: #30363d;
  --text: #f0f6fc; --muted: #8b949e; --accent: #58a6ff; --accent2: #1f6feb;
  --success: #3fb950; --warning: #d29922; --danger: #f85149;
  --home: #238636; --away: #da3633;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Navigation */
.nav { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 0 20px; display: flex; align-items: center; height: 56px; position: sticky; top: 0; z-index: 100; }
.nav-brand { font-size: 18px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }
.nav-links { display: flex; height: 100%; margin-left: 30px; }
.nav-link { padding: 0 16px; display: flex; align-items: center; gap: 6px; color: var(--muted); height: 100%; border-bottom: 2px solid transparent; transition: all 0.2s; }
.nav-link:hover { color: var(--text); background: var(--bg3); text-decoration: none; }
.nav-link.active { color: var(--text); border-bottom-color: var(--accent); }
.nav-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
.nav-right select { background: var(--bg3); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; font-size: 13px; }

/* Container */
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Cards */
.card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.card-title { font-size: 14px; font-weight: 600; color: var(--text); }
.card-subtitle { font-size: 12px; color: var(--muted); }

/* Grid */
.grid { display: grid; gap: 16px; }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }
@media (max-width: 900px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

/* Score Header */
.score-header { background: linear-gradient(135deg, var(--bg2) 0%, #1a2332 100%); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); }
.score-content { display: flex; align-items: center; justify-content: center; gap: 40px; }
.team-block { text-align: center; flex: 1; max-width: 180px; }
.team-logo { width: 64px; height: 64px; border-radius: 50%; background: var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 8px; }
.team-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.team-record { font-size: 12px; color: var(--muted); }
.score-center { text-align: center; }
.final-score { font-size: 48px; font-weight: 700; letter-spacing: 4px; }
.final-score .home { color: var(--home); }
.final-score .away { color: var(--away); }
.game-info { font-size: 12px; color: var(--muted); margin-top: 8px; }

/* Stats Grid */
.stat-box { background: var(--bg3); border-radius: 6px; padding: 12px; text-align: center; }
.stat-value { font-size: 24px; font-weight: 700; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-compare { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; }
.stat-compare .home { color: var(--home); }
.stat-compare .away { color: var(--away); }

/* Tables */
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border); }
th { background: var(--bg3); color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; position: sticky; top: 0; }
tr:hover { background: var(--bg3); }
.num { text-align: right; font-family: 'SF Mono', Monaco, monospace; }
.highlight { color: var(--accent); font-weight: 600; }
.positive { color: var(--success); }
.negative { color: var(--danger); }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
.tab { padding: 8px 16px; background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 13px; border-radius: 4px; }
.tab:hover { background: var(--bg3); color: var(--text); }
.tab.active { background: var(--accent2); color: var(--text); }

/* Shot Chart */
.shot-chart { position: relative; background: linear-gradient(to bottom, #e8f4f8, #d0e8f0); border-radius: 8px; overflow: hidden; }
.shot-chart svg { width: 100%; height: auto; }
.shot-dot { cursor: pointer; transition: all 0.2s; }
.shot-dot:hover { transform: scale(1.5); }
.shot-dot.goal { fill: var(--success); }
.shot-dot.save { fill: var(--accent); }
.shot-dot.miss { fill: var(--muted); }
.shot-dot.block { fill: var(--warning); }

/* Player Card */
.player-card { display: flex; gap: 16px; padding: 12px; background: var(--bg3); border-radius: 8px; margin-bottom: 8px; }
.player-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: var(--accent); }
.player-info { flex: 1; }
.player-name { font-weight: 600; font-size: 14px; }
.player-meta { font-size: 11px; color: var(--muted); }
.player-stats { display: flex; gap: 16px; margin-top: 6px; }
.player-stat { text-align: center; }
.player-stat-value { font-size: 16px; font-weight: 700; color: var(--accent); }
.player-stat-label { font-size: 9px; color: var(--muted); text-transform: uppercase; }

/* Radar Chart Container */
.radar-container { max-width: 300px; margin: 0 auto; }

/* Progress Bars */
.progress-bar { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; margin: 4px 0; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
.progress-fill.home { background: var(--home); }
.progress-fill.away { background: var(--away); }

/* Comparison Bar */
.compare-bar { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
.compare-label { width: 80px; font-size: 11px; color: var(--muted); }
.compare-track { flex: 1; height: 20px; background: var(--bg); border-radius: 4px; display: flex; overflow: hidden; }
.compare-home { background: var(--home); transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 4px; font-size: 10px; font-weight: 600; }
.compare-away { background: var(--away); transition: width 0.3s; display: flex; align-items: center; padding-left: 4px; font-size: 10px; font-weight: 600; }

/* Timeline */
.timeline { display: flex; height: 40px; background: var(--bg); border-radius: 4px; overflow: hidden; margin: 16px 0; }
.timeline-period { flex: 1; border-right: 1px solid var(--border); position: relative; }
.timeline-period:last-child { border-right: none; }
.timeline-label { position: absolute; bottom: 2px; left: 4px; font-size: 9px; color: var(--muted); }
.timeline-event { position: absolute; width: 8px; height: 8px; border-radius: 50%; top: 50%; transform: translateY(-50%); cursor: pointer; }
.timeline-event.goal-home { background: var(--home); }
.timeline-event.goal-away { background: var(--away); }
.timeline-event.penalty { background: var(--warning); }

/* Buttons */
.btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
.btn-primary { background: var(--accent2); color: var(--text); }
.btn-primary:hover { background: var(--accent); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { background: var(--bg3); }

/* Filters */
.filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.filter-group { display: flex; align-items: center; gap: 6px; }
.filter-group label { font-size: 11px; color: var(--muted); }
.filter-group select { background: var(--bg3); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 4px; font-size: 12px; }

/* Loading */
.loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Empty State */
.empty-state { text-align: center; padding: 40px; color: var(--muted); }
.empty-state-icon { font-size: 48px; margin-bottom: 16px; }

/* Tooltip */
.tooltip { position: absolute; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-size: 11px; z-index: 1000; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
</style>
</head>
<body>

<!-- Navigation -->
<nav class="nav">
  <div class="nav-brand">üèí BenchSight</div>
  <div class="nav-links">
    <a href="#" class="nav-link active" data-view="overview">Overview</a>
    <a href="#" class="nav-link" data-view="boxscore">Box Score</a>
    <a href="#" class="nav-link" data-view="shots">Shot Chart</a>
    <a href="#" class="nav-link" data-view="players">Players</a>
    <a href="#" class="nav-link" data-view="advanced">Advanced</a>
    <a href="#" class="nav-link" data-view="h2h">H2H</a>
  </div>
  <div class="nav-right">
    <select id="gameSelect" onchange="loadGame(this.value)">
      <option value="">Select Game...</option>
    </select>
    <a href="tracker_v22.html" class="btn btn-primary">üé¨ Tracker</a>
  </div>
</nav>

<!-- Main Content -->
<div class="container">
  <div id="content">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<script>
// =============================================================================
// CONFIG
// =============================================================================
const SUPABASE_URL = 'https://uuaowslhpgyiudmbvqze.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YW93c2xocGd5aXVkbWJ2cXplIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Njg1NDk4NywiZXhwIjoyMDgyNDMwOTg3fQ.BV5d03x9Hv83XZsveGdU7k7D7gAZ7Yi1tqNB7DeDkrM';

// =============================================================================
// STATE
// =============================================================================
const state = {
  games: [],
  currentGame: null,
  gameData: null,
  view: 'overview'
};

// =============================================================================
// API
// =============================================================================
async function fetchSupabase(table, query = '') {
  const resp = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
  });
  return resp.json();
}

// =============================================================================
// INIT
// =============================================================================
async function init() {
  // Load games
  state.games = await fetchSupabase('dim_schedule', 'select=game_id,game_date_str,home_team_name,away_team_name,home_total_goals,away_total_goals&order=game_date_str.desc&limit=50');
  
  // Populate select
  const select = document.getElementById('gameSelect');
  state.games.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.game_id;
    opt.textContent = `${g.game_date_str || ''} - ${g.home_team_name} vs ${g.away_team_name}`;
    select.appendChild(opt);
  });
  
  // Setup navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      state.view = link.dataset.view;
      render();
    });
  });
  
  // Load first game or show empty
  if (state.games.length > 0) {
    await loadGame(state.games[0].game_id);
  } else {
    renderEmpty();
  }
}

async function loadGame(gameId) {
  if (!gameId) return;
  
  document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  try {
    const [game, events, eventsPlayer, shifts, roster, playerStats, shotXY, puckXY] = await Promise.all([
      fetchSupabase('dim_schedule', `game_id=eq.${gameId}`),
      fetchSupabase('fact_events', `game_id=eq.${gameId}&order=event_index`),
      fetchSupabase('fact_events_player', `game_id=eq.${gameId}`),
      fetchSupabase('fact_shifts', `game_id=eq.${gameId}&order=shift_index`),
      fetchSupabase('fact_gameroster', `game_id=eq.${gameId}`),
      fetchSupabase('fact_player_game_stats', `game_id=eq.${gameId}`),
      fetchSupabase('fact_shot_xy', `game_id=eq.${gameId}`),
      fetchSupabase('fact_puck_xy_long', `game_id=eq.${gameId}`)
    ]);
    
    state.currentGame = gameId;
    state.gameData = {
      game: game[0],
      events,
      eventsPlayer,
      shifts,
      roster,
      playerStats,
      shotXY,
      puckXY
    };
    
    render();
  } catch (err) {
    console.error(err);
    document.getElementById('content').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error loading game data</p></div>`;
  }
}

// =============================================================================
// RENDER
// =============================================================================
function render() {
  if (!state.gameData) {
    renderEmpty();
    return;
  }
  
  switch (state.view) {
    case 'overview': renderOverview(); break;
    case 'boxscore': renderBoxScore(); break;
    case 'shots': renderShotChart(); break;
    case 'players': renderPlayers(); break;
    case 'advanced': renderAdvanced(); break;
    case 'h2h': renderH2H(); break;
    default: renderOverview();
  }
}

function renderEmpty() {
  document.getElementById('content').innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üèí</div>
      <h2>No Game Selected</h2>
      <p>Select a game from the dropdown to view analytics</p>
    </div>
  `;
}

// =============================================================================
// OVERVIEW VIEW
// =============================================================================
function renderOverview() {
  const { game, events, shifts, roster, playerStats, shotXY } = state.gameData;
  
  // Calculate stats
  const goals = events.filter(e => e.event_type === 'Goal');
  const shots = events.filter(e => ['Shot', 'Goal'].includes(e.event_type));
  const faceoffs = events.filter(e => e.event_type === 'Faceoff');
  
  const homeGoals = goals.filter(e => e.team_venue === 'Home').length;
  const awayGoals = goals.filter(e => e.team_venue === 'Away').length;
  const homeShots = shots.filter(e => e.team_venue === 'Home').length;
  const awayShots = shots.filter(e => e.team_venue === 'Away').length;
  const homeFO = faceoffs.filter(e => e.team_venue === 'Home' && e.event_successful === 's').length;
  const awayFO = faceoffs.filter(e => e.team_venue === 'Away' && e.event_successful === 's').length;
  
  const html = `
    <!-- Score Header -->
    <div class="score-header">
      <div class="score-content">
        <div class="team-block">
          <div class="team-logo">üè†</div>
          <div class="team-name">${game?.home_team_name || 'Home'}</div>
          <div class="team-record">HOME</div>
        </div>
        <div class="score-center">
          <div class="final-score">
            <span class="home">${homeGoals}</span>
            <span style="color:var(--muted)">-</span>
            <span class="away">${awayGoals}</span>
          </div>
          <div class="game-info">${game?.game_date_str || ''} ‚Ä¢ Final</div>
        </div>
        <div class="team-block">
          <div class="team-logo">‚úàÔ∏è</div>
          <div class="team-name">${game?.away_team_name || 'Away'}</div>
          <div class="team-record">AWAY</div>
        </div>
      </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-4" style="margin-bottom:20px">
      <div class="stat-box">
        <div class="stat-value">${events.length}</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${homeShots + awayShots}</div>
        <div class="stat-label">Shots</div>
        <div class="stat-compare"><span class="home">${homeShots} H</span><span class="away">${awayShots} A</span></div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${shifts.length}</div>
        <div class="stat-label">Shifts Tracked</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">${shotXY.length}</div>
        <div class="stat-label">XY Data Points</div>
      </div>
    </div>
    
    <!-- Comparison Bars -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Team Comparison</div>
      </div>
      ${renderCompareBar('Goals', homeGoals, awayGoals)}
      ${renderCompareBar('Shots', homeShots, awayShots)}
      ${renderCompareBar('Faceoff Wins', homeFO, awayFO)}
      ${renderCompareBar('Shot %', homeShots ? ((homeGoals/homeShots)*100).toFixed(1) : 0, awayShots ? ((awayGoals/awayShots)*100).toFixed(1) : 0, true)}
    </div>
    
    <!-- Timeline -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Game Timeline</div>
      </div>
      <div class="timeline">
        <div class="timeline-period">
          <div class="timeline-label">1st</div>
          ${renderTimelineEvents(goals, 1)}
        </div>
        <div class="timeline-period">
          <div class="timeline-label">2nd</div>
          ${renderTimelineEvents(goals, 2)}
        </div>
        <div class="timeline-period">
          <div class="timeline-label">3rd</div>
          ${renderTimelineEvents(goals, 3)}
        </div>
      </div>
    </div>
    
    <!-- Top Performers -->
    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Top Scorers</div>
        </div>
        ${renderTopPlayers(playerStats, 'total_points')}
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Most Shots</div>
        </div>
        ${renderTopPlayers(playerStats, 'shots')}
      </div>
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

function renderCompareBar(label, home, away, isPercent = false) {
  const total = parseFloat(home) + parseFloat(away) || 1;
  const homePct = (parseFloat(home) / total * 100).toFixed(0);
  const awayPct = (100 - homePct).toFixed(0);
  
  return `
    <div class="compare-bar">
      <div class="compare-label">${label}</div>
      <div class="compare-track">
        <div class="compare-home" style="width:${homePct}%">${home}${isPercent ? '%' : ''}</div>
        <div class="compare-away" style="width:${awayPct}%">${away}${isPercent ? '%' : ''}</div>
      </div>
    </div>
  `;
}

function renderTimelineEvents(goals, period) {
  return goals.filter(g => g.period == period).map(g => {
    const pos = ((20 - (parseInt(g.event_start_min) || 0)) / 20 * 100).toFixed(0);
    const cls = g.team_venue === 'Home' ? 'goal-home' : 'goal-away';
    return `<div class="timeline-event ${cls}" style="left:${pos}%" title="Goal - ${g.event_start_min}:${g.event_start_sec}"></div>`;
  }).join('');
}

function renderTopPlayers(stats, sortKey) {
  const sorted = [...stats].sort((a, b) => (parseInt(b[sortKey]) || 0) - (parseInt(a[sortKey]) || 0)).slice(0, 5);
  
  if (sorted.length === 0) return '<div class="empty-state">No player data</div>';
  
  return sorted.map(p => `
    <div class="player-card">
      <div class="player-avatar">${(p.player_name || '??').substring(0, 2).toUpperCase()}</div>
      <div class="player-info">
        <div class="player-name">${p.player_name || 'Unknown'}</div>
        <div class="player-meta">${p.team_name || ''}</div>
      </div>
      <div class="player-stats">
        <div class="player-stat"><div class="player-stat-value">${p.goals || 0}</div><div class="player-stat-label">G</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.assists || 0}</div><div class="player-stat-label">A</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.shots || 0}</div><div class="player-stat-label">S</div></div>
      </div>
    </div>
  `).join('');
}

// =============================================================================
// BOX SCORE VIEW
// =============================================================================
function renderBoxScore() {
  const { game, roster, playerStats } = state.gameData;
  
  const homeRoster = roster.filter(r => r.team_venue === 'Home');
  const awayRoster = roster.filter(r => r.team_venue === 'Away');
  
  const html = `
    <div class="tabs">
      <button class="tab active" onclick="showBoxTeam('home', this)">Home - ${game?.home_team_name || 'Home'}</button>
      <button class="tab" onclick="showBoxTeam('away', this)">Away - ${game?.away_team_name || 'Away'}</button>
    </div>
    
    <div class="card">
      <div class="table-wrapper">
        <table id="boxTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Pos</th>
              <th class="num">G</th>
              <th class="num">A</th>
              <th class="num">P</th>
              <th class="num">+/-</th>
              <th class="num">S</th>
              <th class="num">S%</th>
              <th class="num">TOI</th>
              <th class="num">FO%</th>
              <th class="num">Hits</th>
              <th class="num">Blk</th>
            </tr>
          </thead>
          <tbody id="boxBody">
            ${renderBoxRows(homeRoster, playerStats)}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

function renderBoxRows(roster, stats) {
  return roster.map(r => {
    const ps = stats.find(s => s.player_id === r.player_id) || {};
    const shots = parseInt(ps.shots) || 0;
    const goals = parseInt(ps.goals) || 0;
    const shotPct = shots > 0 ? ((goals / shots) * 100).toFixed(1) : '0.0';
    
    return `
      <tr>
        <td>${r.player_game_number || '-'}</td>
        <td>${r.player_name || r.player_id}</td>
        <td>${r.player_position || '-'}</td>
        <td class="num ${goals > 0 ? 'highlight' : ''}">${goals}</td>
        <td class="num">${ps.assists || 0}</td>
        <td class="num highlight">${(goals) + (parseInt(ps.assists) || 0)}</td>
        <td class="num ${(parseInt(ps.plus_minus) || 0) > 0 ? 'positive' : (parseInt(ps.plus_minus) || 0) < 0 ? 'negative' : ''}">${ps.plus_minus || 0}</td>
        <td class="num">${shots}</td>
        <td class="num">${shotPct}</td>
        <td class="num">${ps.toi_minutes || '-'}</td>
        <td class="num">${ps.faceoff_pct || '-'}</td>
        <td class="num">${ps.hits || 0}</td>
        <td class="num">${ps.blocked_shots || 0}</td>
      </tr>
    `;
  }).join('');
}

window.showBoxTeam = function(team, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  
  const { roster, playerStats } = state.gameData;
  const filtered = roster.filter(r => r.team_venue === (team === 'home' ? 'Home' : 'Away'));
  document.getElementById('boxBody').innerHTML = renderBoxRows(filtered, playerStats);
};

// =============================================================================
// SHOT CHART VIEW
// =============================================================================
function renderShotChart() {
  const { game, shotXY, events } = state.gameData;
  
  // Get shots from events if no XY data
  const shots = shotXY.length > 0 ? shotXY : events.filter(e => ['Shot', 'Goal'].includes(e.event_type));
  
  const html = `
    <div class="filters">
      <div class="filter-group">
        <label>Team:</label>
        <select id="shotTeamFilter" onchange="filterShots()">
          <option value="all">All</option>
          <option value="Home">Home</option>
          <option value="Away">Away</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Period:</label>
        <select id="shotPeriodFilter" onchange="filterShots()">
          <option value="all">All</option>
          <option value="1">1st</option>
          <option value="2">2nd</option>
          <option value="3">3rd</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Result:</label>
        <select id="shotResultFilter" onchange="filterShots()">
          <option value="all">All</option>
          <option value="goal">Goals</option>
          <option value="save">Saves</option>
          <option value="miss">Missed</option>
        </select>
      </div>
    </div>
    
    <div class="card">
      <div class="shot-chart">
        <svg viewBox="0 0 200 85" id="shotSvg">
          <!-- Rink -->
          <defs>
            <linearGradient id="iceGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#f0f4f8"/>
              <stop offset="100%" style="stop-color:#dce4ec"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="200" height="85" fill="url(#iceGrad)" rx="15"/>
          <line x1="100" y1="0" x2="100" y2="85" stroke="#dc2626" stroke-width="2"/>
          <line x1="25" y1="0" x2="25" y2="85" stroke="#2563eb" stroke-width="1.5"/>
          <line x1="175" y1="0" x2="175" y2="85" stroke="#2563eb" stroke-width="1.5"/>
          <circle cx="100" cy="42.5" r="15" fill="none" stroke="#2563eb" stroke-width="1"/>
          <circle cx="31" cy="21" r="15" fill="none" stroke="#dc2626" stroke-width="0.7"/>
          <circle cx="31" cy="64" r="15" fill="none" stroke="#dc2626" stroke-width="0.7"/>
          <circle cx="169" cy="21" r="15" fill="none" stroke="#dc2626" stroke-width="0.7"/>
          <circle cx="169" cy="64" r="15" fill="none" stroke="#dc2626" stroke-width="0.7"/>
          <rect x="0" y="37" width="4" height="11" fill="#dc2626" rx="1"/>
          <rect x="196" y="37" width="4" height="11" fill="#dc2626" rx="1"/>
          
          <!-- Shots -->
          <g id="shotDots">
            ${renderShotDots(shots)}
          </g>
        </svg>
      </div>
    </div>
    
    <div class="grid grid-3">
      <div class="stat-box">
        <div class="stat-value" id="statGoals">${shots.filter(s => s.is_goal === '1' || s.shot_result?.includes('Goal')).length}</div>
        <div class="stat-label">Goals</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="statSOG">${shots.length}</div>
        <div class="stat-label">Shots</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="statPct">${shots.length > 0 ? ((shots.filter(s => s.is_goal === '1' || s.shot_result?.includes('Goal')).length / shots.length) * 100).toFixed(1) : 0}%</div>
        <div class="stat-label">Shooting %</div>
      </div>
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

function renderShotDots(shots) {
  return shots.map((s, i) => {
    const x = s.shot_x || s.x_coord || (Math.random() * 100 + 100); // Default to offensive zone
    const y = s.shot_y || s.y_coord || (Math.random() * 60 + 12);
    const isGoal = s.is_goal === '1' || s.shot_result?.includes('Goal');
    const cls = isGoal ? 'goal' : 'save';
    const r = isGoal ? 5 : 3;
    
    return `<circle class="shot-dot ${cls}" cx="${x}" cy="${y}" r="${r}" data-idx="${i}" data-team="${s.team_venue}" data-period="${s.period}" data-result="${isGoal ? 'goal' : 'save'}"/>`;
  }).join('');
}

window.filterShots = function() {
  const team = document.getElementById('shotTeamFilter').value;
  const period = document.getElementById('shotPeriodFilter').value;
  const result = document.getElementById('shotResultFilter').value;
  
  document.querySelectorAll('.shot-dot').forEach(dot => {
    let show = true;
    if (team !== 'all' && dot.dataset.team !== team) show = false;
    if (period !== 'all' && dot.dataset.period !== period) show = false;
    if (result !== 'all' && dot.dataset.result !== result) show = false;
    dot.style.display = show ? '' : 'none';
  });
};

// =============================================================================
// PLAYERS VIEW
// =============================================================================
function renderPlayers() {
  const { roster, playerStats } = state.gameData;
  
  const html = `
    <div class="filters">
      <div class="filter-group">
        <label>Team:</label>
        <select id="playerTeamFilter" onchange="filterPlayers()">
          <option value="all">All</option>
          <option value="Home">Home</option>
          <option value="Away">Away</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Position:</label>
        <select id="playerPosFilter" onchange="filterPlayers()">
          <option value="all">All</option>
          <option value="F">Forwards</option>
          <option value="D">Defense</option>
          <option value="G">Goalies</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Sort:</label>
        <select id="playerSortFilter" onchange="filterPlayers()">
          <option value="points">Points</option>
          <option value="goals">Goals</option>
          <option value="shots">Shots</option>
          <option value="toi">TOI</option>
        </select>
      </div>
    </div>
    
    <div id="playerCards">
      ${renderPlayerCards(roster, playerStats)}
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

function renderPlayerCards(roster, stats) {
  const cards = roster.map(r => {
    const ps = stats.find(s => s.player_id === r.player_id) || {};
    return { ...r, ...ps, points: (parseInt(ps.goals) || 0) + (parseInt(ps.assists) || 0) };
  });
  
  return cards.sort((a, b) => b.points - a.points).map(p => `
    <div class="player-card" data-team="${p.team_venue}" data-pos="${p.player_position?.charAt(0) || 'F'}">
      <div class="player-avatar">${p.player_game_number || '?'}</div>
      <div class="player-info">
        <div class="player-name">${p.player_name || p.player_id}</div>
        <div class="player-meta">${p.team_name || p.team_venue} ‚Ä¢ ${p.player_position || '-'}</div>
      </div>
      <div class="player-stats">
        <div class="player-stat"><div class="player-stat-value">${p.goals || 0}</div><div class="player-stat-label">G</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.assists || 0}</div><div class="player-stat-label">A</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.points}</div><div class="player-stat-label">P</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.shots || 0}</div><div class="player-stat-label">S</div></div>
        <div class="player-stat"><div class="player-stat-value">${p.toi_minutes || '-'}</div><div class="player-stat-label">TOI</div></div>
      </div>
    </div>
  `).join('');
}

window.filterPlayers = function() {
  const team = document.getElementById('playerTeamFilter').value;
  const pos = document.getElementById('playerPosFilter').value;
  
  document.querySelectorAll('.player-card').forEach(card => {
    let show = true;
    if (team !== 'all' && card.dataset.team !== team) show = false;
    if (pos !== 'all' && card.dataset.pos !== pos) show = false;
    card.style.display = show ? '' : 'none';
  });
};

// =============================================================================
// ADVANCED VIEW
// =============================================================================
function renderAdvanced() {
  const { events, shifts, puckXY } = state.gameData;
  
  // Calculate advanced stats
  const shots = events.filter(e => ['Shot', 'Goal'].includes(e.event_type));
  const blocks = events.filter(e => e.event_type === 'Block');
  const misses = events.filter(e => e.event_detail?.includes('Missed'));
  
  const homeCF = shots.filter(e => e.team_venue === 'Home').length + blocks.filter(e => e.team_venue === 'Away').length + misses.filter(e => e.team_venue === 'Home').length;
  const awayCF = shots.filter(e => e.team_venue === 'Away').length + blocks.filter(e => e.team_venue === 'Home').length + misses.filter(e => e.team_venue === 'Away').length;
  
  const homeFF = shots.filter(e => e.team_venue === 'Home').length + misses.filter(e => e.team_venue === 'Home').length;
  const awayFF = shots.filter(e => e.team_venue === 'Away').length + misses.filter(e => e.team_venue === 'Away').length;
  
  const html = `
    <div class="grid grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Corsi (Shot Attempts)</div>
        </div>
        ${renderCompareBar('CF', homeCF, awayCF)}
        <div class="stat-box" style="margin-top:12px">
          <div class="stat-value">${((homeCF / (homeCF + awayCF)) * 100).toFixed(1)}%</div>
          <div class="stat-label">Home CF%</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">Fenwick (Unblocked Attempts)</div>
        </div>
        ${renderCompareBar('FF', homeFF, awayFF)}
        <div class="stat-box" style="margin-top:12px">
          <div class="stat-value">${((homeFF / (homeFF + awayFF)) * 100).toFixed(1)}%</div>
          <div class="stat-label">Home FF%</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-title">Event Breakdown</div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Event Type</th><th class="num">Home</th><th class="num">Away</th><th class="num">Total</th></tr>
          </thead>
          <tbody>
            ${renderEventBreakdown(events)}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-title">Tracking Data Summary</div>
      </div>
      <div class="grid grid-4">
        <div class="stat-box">
          <div class="stat-value">${events.length}</div>
          <div class="stat-label">Events</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${shifts.length}</div>
          <div class="stat-label">Shifts</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${puckXY.length}</div>
          <div class="stat-label">Puck XY Points</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${events.filter(e => e.x_coord).length}</div>
          <div class="stat-label">Events w/ XY</div>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

function renderEventBreakdown(events) {
  const types = {};
  events.forEach(e => {
    if (!types[e.event_type]) types[e.event_type] = { home: 0, away: 0 };
    if (e.team_venue === 'Home') types[e.event_type].home++;
    else types[e.event_type].away++;
  });
  
  return Object.entries(types).sort((a, b) => (b[1].home + b[1].away) - (a[1].home + a[1].away)).map(([type, counts]) => `
    <tr>
      <td>${type}</td>
      <td class="num">${counts.home}</td>
      <td class="num">${counts.away}</td>
      <td class="num highlight">${counts.home + counts.away}</td>
    </tr>
  `).join('');
}

// =============================================================================
// H2H VIEW
// =============================================================================
function renderH2H() {
  const { roster, playerStats, events } = state.gameData;
  
  const html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Head-to-Head Comparison</div>
        <div class="card-subtitle">Compare two players</div>
      </div>
      
      <div class="grid grid-2" style="margin-bottom:20px">
        <div class="filter-group">
          <label>Player 1:</label>
          <select id="h2hPlayer1" onchange="updateH2H()" style="width:100%">
            <option value="">Select player...</option>
            ${roster.map(r => `<option value="${r.player_id}">${r.player_game_number} - ${r.player_name || r.player_id}</option>`).join('')}
          </select>
        </div>
        <div class="filter-group">
          <label>Player 2:</label>
          <select id="h2hPlayer2" onchange="updateH2H()" style="width:100%">
            <option value="">Select player...</option>
            ${roster.map(r => `<option value="${r.player_id}">${r.player_game_number} - ${r.player_name || r.player_id}</option>`).join('')}
          </select>
        </div>
      </div>
      
      <div id="h2hComparison">
        <div class="empty-state">Select two players to compare</div>
      </div>
    </div>
  `;
  
  document.getElementById('content').innerHTML = html;
}

window.updateH2H = function() {
  const p1Id = document.getElementById('h2hPlayer1').value;
  const p2Id = document.getElementById('h2hPlayer2').value;
  
  if (!p1Id || !p2Id) {
    document.getElementById('h2hComparison').innerHTML = '<div class="empty-state">Select two players to compare</div>';
    return;
  }
  
  const { playerStats, roster } = state.gameData;
  const p1Stats = playerStats.find(s => s.player_id === p1Id) || {};
  const p2Stats = playerStats.find(s => s.player_id === p2Id) || {};
  const p1Roster = roster.find(r => r.player_id === p1Id) || {};
  const p2Roster = roster.find(r => r.player_id === p2Id) || {};
  
  const stats = ['goals', 'assists', 'shots', 'hits', 'blocked_shots', 'faceoff_wins'];
  const labels = ['Goals', 'Assists', 'Shots', 'Hits', 'Blocks', 'FO Wins'];
  
  document.getElementById('h2hComparison').innerHTML = `
    <div class="grid grid-2" style="text-align:center;margin-bottom:20px">
      <div>
        <div class="player-avatar" style="margin:0 auto">${p1Roster.player_game_number || '?'}</div>
        <div style="font-weight:600;margin-top:8px">${p1Stats.player_name || p1Id}</div>
      </div>
      <div>
        <div class="player-avatar" style="margin:0 auto">${p2Roster.player_game_number || '?'}</div>
        <div style="font-weight:600;margin-top:8px">${p2Stats.player_name || p2Id}</div>
      </div>
    </div>
    ${stats.map((stat, i) => renderCompareBar(labels[i], parseInt(p1Stats[stat]) || 0, parseInt(p2Stats[stat]) || 0)).join('')}
  `;
};

// =============================================================================
// START
// =============================================================================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
